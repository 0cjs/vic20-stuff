
VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 1
Copyright (C) 1981 Commodore Business Machines, Inc.   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                            1   	.nam VIC20 KERNEL  #901486-04  (C)1981 CBM
                            2   	.subttl Copyright (C) 1981 Commodore Business Machines, Inc.
                            3   
                            4   ; Converted to VAX/VMS BSO format 10/30/87 by Fred Bowen
                            5   
                            6   ;	.include   disclaimer
                            7   ;	.include   declare
                            8   ;	.include   editor.1
                            9   ;	.include   conkat
                           10   ;	.include   editor.2
                           11   ;	.include   editor.3
                           12   ;	.include   serial2.1
                           13   ;	.include   rs232trans
                           14   ;	.include   rs232rcvr
                           15   ;	.include   rs232inout
                           16   ;	.include   messages
                           17   ;	.include   channelio
                           18   ;	.include   openchannel
                           19   ;	.include   close
                           20   ;	.include   clall
                           21   ;	.include   open
                           22   ;	.include   load
                           23   ;	.include   save
                           24   ;	.include   time
                           25   ;	.include   errorhandler
                           26   ;	.include   tapefile
                           27   ;	.include   tapecontrol
                           28   ;	.include   read
                           29   ;	.include   write
                           30   ;	.include   init
                           31   ;	.include   rs232nmifile
                           32   ;	.include   irqfile
                           33   ;	.include   vectors
                           34   ;.end
                           35   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 2
Copyright (C) 1981 Commodore Business Machines, Inc.   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                           37   
                           38   ;****************************************
                           39   ;*                                      *
                           40   ;* KK  K EEEEE RRRR  NN  N  AAA  LL     *
                           41   ;* KK KK EE    RR  R NNN N AA  A LL     *
                           42   ;* KKK   EE    RR  R NNN N AA  A LL     *
                           43   ;* KKK   EEEE  RRRR  NNNNN AAAAA LL     *
                           44   ;* KK K  EE    RR  R NN NN AA  A LL     *
                           45   ;* KK KK EE    RR  R NN NN AA  A LL     *
                           46   ;* KK KK EEEEE RR  R NN NN AA  A LLLLL  *
                           47   ;*                                      *
                           48   ;***************************************
                           49   ;
                           50   ;***************************************
                           51   ;* pet kernal                          *
                           52   ;*   memory and i/o dependent routines *
                           53   ;* driving the hardware of the         *
                           54   ;* following cbm models:               *
                           55   ;*   vixen                             *
                           56   ;* copyright (c) 1980 by               *
                           57   ;* commodore business machines (cbm)   *
                           58   ;***************************************
                           59   
                           60   
                           61   ;****listing date --1200 09 oct.  1980**
                           62   
                           63   
                           64   ;***************************************
                           65   ;* this software is furnished for use  *
                           66   ;* use in the micro-pet computer       *
                           67   ;* only.                               *
                           68   ;*                                     *
                           69   ;* copies thereof may not be provided  *
                           70   ;* or made available for use on any    *
                           71   ;* other system.                       *
                           72   ;*                                     *
                           73   ;* the information in this document is *
                           74   ;* subject to change without notice.   *
                           75   ;*                                     *
                           76   ;* no responsibility is assumed for    *
                           77   ;* reliability of this software.       *
                           78   ;*                                     *
                           79   ;***************************************
                           80   ;.end
                           81   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 3
DECLARE   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                           83   	.subttl DECLARE
                           84   
                           85   ;virtual regs for machine language monitor
                           86   
            =0000          87   	* = $0000
                           88   
     0000   =0001          89   pch      *=*+1
     0001   =0002          90   pcl      *=*+1
     0002   =0003          91   flgs     *=*+1
     0003   =0004          92   acc      *=*+1
     0004   =0005          93   xr       *=*+1
     0005   =0006          94   yr       *=*+1
     0006   =0007          95   sp       *=*+1
     0007   =0008          96   invh     *=*+1          ; user modifiable irq
     0008   =0009          97   invl     *=*+1
                           98   
                           99   
            =0090         100           * = $90
                          101   
     0090   =0091         102   status   *=*+1          ; i/o operation status byte
                          103   ; crfac *=*+2 ;correction factor (unused)
     0091   =0092         104   stkey    *=*+1          ; stop key flag
     0092   =0093         105   svxt     *=*+1          ; temporary
     0093   =0094         106   verck    *=*+1          ; load or verify flag
     0094   =0095         107   c3p0     *=*+1          ; ieee buffered char flag
     0095   =0096         108   bsour    *=*+1          ; char buffer for ieee
     0096   =0097         109   syno     *=*+1          ; cassette sync #
     0097   =0098         110   xsav     *=*+1          ; temp for basin
     0098   =0099         111   ldtnd    *=*+1          ; index to logical file
     0099   =009A         112   dfltn    *=*+1          ; default input device #
     009A   =009B         113   dflto    *=*+1          ; default output device #
     009B   =009C         114   prty     *=*+1          ; cassette parity
     009C   =009D         115   dpsw     *=*+1          ; cassette dipole switch
     009D   =009E         116   msgflg   *=*+1          ; os message flag
     009E                 117   ptr1            	; cassette error pass1
     009E   =009F         118   t1       *=*+1          ; temporary 1
     009F                 119   tmpc
     009F                 120   ptr2            	; cassette error pass2
     009F   =00A0         121   t2       *=*+1          ; temporary 2
     00A0   =00A3         122   time     *=*+3          ; 24 hour clock in 1/60th seconds
     00A3                 123   r2d2            	; serial bus usage
     00A3   =00A4         124   pcntr    *=*+1          ; cassette stuff
                          125   ; ptch *=*+1  (unused)
     00A4                 126   bsour1          	; temp used by serial routine
     00A4   =00A5         127   firt     *=*+1
     00A5                 128   count           	; temp used by serial routine
     00A5   =00A6         129   cntdn    *=*+1          ; cassette sync countdown
     00A6   =00A7         130   bufpt    *=*+1          ; cassette buffer pointer
     00A7                 131   inbit           	; rs-232 rcvr input bit storage
     00A7   =00A8         132   shcnl    *=*+1          ; cassette short count

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 3-1
DECLARE   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     00A8                 133   bitci           	; rs-232 rcvr bit count in
     00A8   =00A9         134   rer      *=*+1          ; cassette read error
     00A9                 135   rinone          	; rs-232 rcvr flag for start bit check
     00A9   =00AA         136   rez      *=*+1          ; cassete reading zeroes
     00AA                 137   ridata          	; rs-232 rcvr byte buffer
     00AA   =00AB         138   rdflg    *=*+1          ; cassette read mode
     00AB                 139   riprty          	; rs-232 rcvr parity storage
     00AB   =00AC         140   shcnh    *=*+1          ; cassette short cnt
     00AC   =00AD         141   sal      *=*+1
     00AD   =00AE         142   sah      *=*+1
     00AE   =00AF         143   eal      *=*+1
     00AF   =00B0         144   eah      *=*+1
     00B0   =00B1         145   cmp0     *=*+1
     00B1   =00B2         146   temp     *=*+1
     00B2   =00B4         147   tape1    *=*+2          ; address of tape buffer #1y.
     00B4                 148   bitts           	; rs-232 trns bit count
     00B4   =00B5         149   snsw1    *=*+1
     00B5                 150   nxtbit          	; rs-232 trns next bit to be sent
     00B5   =00B6         151   diff     *=*+1
     00B6                 152   rodata          	; rs-232 trns byte buffer
     00B6   =00B7         153   prp      *=*+1
     00B7   =00B8         154   fnlen    *=*+1          ; length current file n str
     00B8   =00B9         155   la       *=*+1          ; current file logical addr
     00B9   =00BA         156   sa       *=*+1          ; current file 2nd addr
     00BA   =00BB         157   fa       *=*+1          ; current file primary addr
     00BB   =00BD         158   fnadr    *=*+2          ; addr current file name str
     00BD                 159   roprty          	; rs-232 trns parity buffer
     00BD   =00BE         160   ochar    *=*+1
     00BE   =00BF         161   fsblk    *=*+1          ; cassette read block count
     00BF   =00C0         162   mych     *=*+1
     00C0   =00C1         163   cas1     *=*+1          ; cassette manual/controlled switch
     00C1                 164   tmp0
     00C1   =00C2         165   stal     *=*+1
     00C2   =00C3         166   stah     *=*+1
     00C3                 167   memuss          	; cassette load temps (2 bytes)
     00C3   =00C5         168   tmp2     *=*+2
                          169   ;
                          170   ;variables for screen editor
                          171   ;
     00C5   =00C6         172   lstx     *=*+1          ; key scan index
                          173   ; sfst	*=*+1 		;keyboard shift flag (unused)
     00C6   =00C7         174   ndx      *=*+1          ; index to keyboard q
     00C7   =00C8         175   rvs      *=*+1          ; rvs field on flag
     00C8   =00C9         176   indx     *=*+1
     00C9   =00CA         177   lsxp     *=*+1          ; x pos at start
     00CA   =00CB         178   lstp     *=*+1
     00CB   =00CC         179   sfdx     *=*+1          ; shift mode on print
     00CC   =00CD         180   blnsw    *=*+1          ; cursor blink enab
     00CD   =00CE         181   blnct    *=*+1          ; count to toggle cur
     00CE   =00CF         182   gdbln    *=*+1          ; char before cursor

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 3-2
DECLARE   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     00CF   =00D0         183   blnon    *=*+1          ; on/off blink flag
     00D0   =00D1         184   crsw     *=*+1          ; input vs get flag
     00D1   =00D3         185   pnt      *=*+2          ; pointer to row
                          186   ; point *=*+1   	;(unused)
     00D3   =00D4         187   pntr     *=*+1          ; pointer to column
     00D4   =00D5         188   qtsw     *=*+1          ; quote switch
     00D5   =00D6         189   lnmx     *=*+1          ; 40/80 max positon
     00D6   =00D7         190   tblx     *=*+1
     00D7   =00D8         191   data     *=*+1
     00D8   =00D9         192   insrt    *=*+1          ; insert mode flag
     00D9   =00F2         193   ldtb1    *=*+25         ; 40/80 line flags
     00F2   =00F3         194   lintmp   *=*+1          ; temporary for line index
     00F3   =00F5         195   user     *=*+2          ; screen editor color ip
     00F5   =00F7         196   keytab   *=*+2          ; keyscan table indirect
                          197   
                          198   ;rs-232 z-page
     00F7   =00F9         199   ribuf    *=*+2          ; rs-232 input buffer pointer
     00F9   =00FB         200   robuf    *=*+2          ; rs-232 output buffer pointer
     00FB   =00FF         201   frekzp   *=*+4          ; free kernal zero page 9/24/80
     00FF   =0100         202   baszpt   *=*+1          ; location ($00ff) used by basic
                                
                                
                                
            =0100         204   	* = $100
     0100   =0101         205   bad      *=*+1
                          206   
            =0200         207   	* = $200
     0200   =0259         208   buf      *=*+89         ; basic/monitor buffer
                          209   
                          210   ; tables for open files
                          211   ;
     0259   =0263         212   lat      *=*+10         ; logical file numbers
     0263   =026D         213   fat      *=*+10         ; primary device numbers
     026D   =0277         214   sat      *=*+10         ; secondary addresses
                                
                                
                          216   ; system storage
                          217   ;
     0277   =0281         218   keyd     *=*+10         ; irq keyboard buffer
     0281   =0283         219   memstr   *=*+2          ; start of memory
     0283   =0285         220   memsiz   *=*+2          ; top of memory
     0285   =0286         221   timout   *=*+1          ; ieee timeout flag
                                
                                
                          223   ; screen editor storage
                          224   ;
     0286   =0287         225   color    *=*+1          ; activ color nybble
     0287   =0288         226   gdcol    *=*+1          ; original color before cursor
     0288   =0289         227   hibase   *=*+1          ; base location of screen (top)
     0289   =028A         228   xmax     *=*+1

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 3-3
DECLARE   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     028A   =028B         229   rptflg   *=*+1          ; key repeat flag
     028B   =028C         230   kount    *=*+1
     028C   =028D         231   delay    *=*+1
     028D   =028E         232   shflag   *=*+1          ; shift flag byte
     028E   =028F         233   lstshf   *=*+1          ; last shift pattern
     028F   =0291         234   keylog   *=*+2          ; indirect for keyboard table setup
     0291   =0292         235   mode     *=*+1          ; 0-pet mode, 1-cattacanna
     0292   =0293         236   autodn   *=*+1          ; auto scroll down flag(=0 on,<>0 off)
                                
                                
                                
                          238   ; rs-232 storage
                          239   ;
     0293   =0294         240   m51ctr   *=*+1          ; 6551 control register
     0294   =0295         241   m51cdr   *=*+1          ; 6551 command register
     0295   =0297         242   m51ajb   *=*+2          ; non standard (bittime/2-100)
     0297   =0298         243   rsstat   *=*+1          ;  rs-232 status register
     0298   =0299         244   bitnum   *=*+1          ; number of bits to send (fast response)
     0299   =029B         245   baudof   *=*+2          ; baud rate full bit time (created by open)
                          246   ;
                          247   ; reciever storage
                          248   ;
                          249   ; inbit *=*+1 ;input bit storage
                          250   ; bitci *=*+1 ;bit count in
                          251   ; rinone *=*+1 ;flag for start bit check
                          252   ; ridata *=*+1 ;byte in buffer
                          253   ; riprty *=*+1 ;byte in parity storage
     029B   =029C         254   ridbe    *=*+1          ; input buffer index to end
     029C   =029D         255   ridbs    *=*+1          ; input buffer pointer to start
                          256   ;
                          257   ; transmitter storage
                          258   ;
                          259   ; bitts *=*+1 ;# of bits to be sent
                          260   ; nxtbit *=*+1 ;next bit to be sent
                          261   ; roprty *=*+1 ;parity of byte sent
                          262   ; rodata *=*+1 ;byte buffer out
     029D   =029E         263   rodbs    *=*+1          ; output buffer index to start
     029E   =029F         264   rodbe    *=*+1          ; output buffer index to end
                          265   ;
     029F   =02A1         266   irqtmp   *=*+2          ; holds irq during tape ops
                          267   ;
                                
                                
                                
            =0300         269   	* = $0300         ; rem program indirects(10)
            =0314         270   	* = $0300+20      ; rem kernal/os indirects(20)
                          271   
     0314   =0316         272   cinv     *=*+2          ; irq ram vector
     0316   =0318         273   cbinv    *=*+2          ; brk instr ram vector
     0318   =031A         274   nminv    *=*+2          ; nmi ram vector

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 3-4
DECLARE   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     031A   =031C         275   iopen    *=*+2          ; indirects for code
     031C   =031E         276   iclose   *=*+2          ;  conforms to kernal spec 8/19/80
     031E   =0320         277   ichkin   *=*+2
     0320   =0322         278   ickout   *=*+2
     0322   =0324         279   iclrch   *=*+2
     0324   =0326         280   ibasin   *=*+2
     0326   =0328         281   ibsout   *=*+2
     0328   =032A         282   istop    *=*+2
     032A   =032C         283   igetin   *=*+2
     032C   =032E         284   iclall   *=*+2
     032E   =0330         285   usrcmd   *=*+2
     0330   =0332         286   iload    *=*+2
     0332   =0334         287   isave    *=*+2          ; savesp
                                
                                
                                
            =033C         289   	* = $0300+60
     033C   =03FC         290   tbuffr   *=*+192        ; cassette data buffer
                                
                                
                                
            =0400         292           * = $400	; ramloc
                                
                                
                                
            =1000         294           * = $1000
     1000   =1200         295   vicscn   *=*+512        ; vic screen
                                
                                
                                
            =9000         297           * = $9000
     9000   =9010         298   vicreg   *=*+16         ; vic registers
                          299   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 4
DECLARE   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                          301   ; i/o devices
                          302   ;
            =9110         303           * = $9110       ; device1 6522 (page2 nmi)
     9110   =9111         304   d1orb    *=*+1
     9111   =9112         305   d1orah   *=*+1
     9112   =9113         306   d1ddrb   *=*+1
     9113   =9114         307   d1ddra   *=*+1
     9114   =9115         308   d1t1l    *=*+1
     9115   =9116         309   d1t1h    *=*+1
     9116   =9117         310   d1t1ll   *=*+1
     9117   =9118         311   d1t1lh   *=*+1
     9118   =9119         312   d1t2l    *=*+1
     9119   =911A         313   d1t2h    *=*+1
     911A   =911B         314   d1sr     *=*+1
     911B   =911C         315   d1acr    *=*+1
     911C   =911D         316   d1pcr    *=*+1
     911D   =911E         317   d1ifr    *=*+1
     911E   =911F         318   d1ier    *=*+1
     911F   =9120         319   d1ora    *=*+1
                                
                                
                                
            =9120         321           * = $9120       ; device2 6522 (page3 irq)
     9120                 322   colm            ; keyboard matrix
     9120   =9121         323   d2orb    *=*+1
     9121                 324   rows            ; keyboard matrix
     9121   =9122         325   d2orah   *=*+1
     9122   =9123         326   d2ddrb   *=*+1
     9123   =9124         327   d2ddra   *=*+1
     9124   =9125         328   d2t1l    *=*+1
     9125   =9126         329   d2t1h    *=*+1
     9126   =9127         330   d2t1ll   *=*+1
     9127   =9128         331   d2t1lh   *=*+1
     9128   =9129         332   d2t2l    *=*+1
     9129   =912A         333   d2t2h    *=*+1
     912A   =912B         334   d2sr     *=*+1
     912B   =912C         335   d2acr    *=*+1
     912C   =912D         336   d2pcr    *=*+1
     912D   =912E         337   d2ifr    *=*+1
     912E   =912F         338   d2ier    *=*+1
     912F   =9130         339   d2ora    *=*+1
                                
                                
                                
            =9400         341           * = $9400
     9400   =9600         342   viccol   *=*+512        ; vic color nybbles
                          343   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 5
DECLARE   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                          345   ;tape block types
                          346   ;
            =0005         347   eot      =5     ; end of tape
            =0001         348   blf      =1     ; basic load file
            =0002         349   bdf      =2     ; basic data file
            =0003         350   plf      =3     ; fixed program type
            =0004         351   bdfh     =4     ; basic data file header
            =00C0         352   bufsz    =192   ; buffer size
                          353   ;
                          354   ;screen editor constants
                          355   ;
            =0016         356   llen     =22    ; single line 22 columns
            =002C         357   llen2    =44    ; double line = 44 columns
            =0017         358   nlines   =23    ; 23 rows on screen
            =0001         359   white    =$01   ; white screen color
            =0006         360   blue     =$06   ; blue char color
            =000D         361   cr       =$d    ; carriage return
                          362   
                          363   ;.end
                          364   ;rsr 8/3/80 add & change z-page
                          365   ;rsr 8/11/80 add memuss & plf type
                          366   ;rsr 8/22/80 add rs-232 routines
                          367   ;rsr 8/24/80 add open variables
                          368   ;rsr 8/29/80 add baud space move rs232 to z-page
                          369   ;rsr 9/2/80 add screen editor vars&con
                          370   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 6
DECLARE   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

            =E500         372   	* = $e500         ; start of vixen kernal
                          373   
            =0058         374   maxchr=88
            =0004         375   nwrap=4         ; max number of physical lines per logical line
                          376   
                          377   ;undefined function entry
                          378   ;
                          379   ; undefd ldx #0
                          380   ; undef2 lda unmsg,x
                          381   ; jsr prt
                          382   ; inx
                          383   ; cpx #unmsg2-unmsg
                          384   ; bne undef2
                          385   ; sec
                          386   ; rts
                          387   ;
                          388   ; unmsg .byte $d,'?advanced function not available',$d
                          389   ; unmsg2
                          390   ;
                          391   ;return address of 6522
                          392   ;
                          393   
     E500   A2 10         394   iobase  ldx  #<d1orb
     E502   A0 91         395           ldy  #>d1orb
     E504   60            396           rts
                          397   
                          398   ;
                          399   ;return max rows,cols of screen
                          400   ;
     E505   A2 16         401   scrorg  ldx  #llen
     E507   A0 17         402           ldy  #23
     E509   60            403           rts
                          404   
                          405   ;
                          406   ;read/plot cursor position
                          407   ;
     E50A   B0 07         408   plot    bcs  plot10
     E50C   86 D6         409           stx  tblx
     E50E   84 D3         410           sty  pntr
     E510   20 E587       411           jsr  stupt
     E513   A6 D6         412   plot10  ldx  tblx
     E515   A4 D3         413           ldy  pntr
     E517   60            414           rts
                                
                                
                                
                                
                                
                          416   ;initialize i/o
                          417   ;

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 6-1
DECLARE   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     E518                 418   cint
                          419   ;
                          420   ; check for expansion ram
                          421   ; establish screen memory
                          422   ;
     E518   20 E5BB       423           jsr  panic      ; set up vic
                          424   ;
     E51B   AD 0288       425           lda  hibase     ; get screen base
     E51E   29 FD         426           and  #$fd       ; get rid of .5k boundry
     E520   0A            427           asl  a          ; set it up for the vic
     E521   0A            428           asl  a
     E522   09 80         429           ora  #$80
     E524   8D 9005       430           sta  vicreg+5   ; point the vic at the new screen
                          431   ;
     E527   AD 0288       432           lda  hibase     ; check for .5k boundary
     E52A   29 02         433           and  #$02
     E52C   F0 08         434           beq  nohalf     ; branch if on 1k boundary
     E52E   A9 80         435           lda  #$80       ; else set .5k bit in vic
     E530   0D 9002       436           ora  vicreg+2
     E533   8D 9002       437           sta  vicreg+2
     E536                 438   nohalf
     E536   A9 00         439           lda  #0         ; make sure we're in pet mode
     E538   8D 0291       440           sta  mode
     E53B   85 CF         441           sta  blnon      ; we dont have a good char from the screen yet
                          442   
     E53D   A9 DC         443           lda  #<shflog   ; set shift logic indirects
     E53F   8D 028F       444           sta  keylog
     E542   A9 EB         445           lda  #>shflog
     E544   8D 0290       446           sta  keylog+1
     E547   A9 0A         447           lda  #10
     E549   8D 0289       448           sta  xmax       ; maximum type ahead buffer size
     E54C   8D 028C       449           sta  delay
     E54F   A9 06         450           lda  #blue
     E551   8D 0286       451           sta  color
     E554   A9 04         452           lda  #4
     E556   8D 028B       453           sta  kount      ; delay between key repeats
     E559   A9 0C         454           lda  #$c
     E55B   85 CD         455           sta  blnct
     E55D   85 CC         456           sta  blnsw
     E55F   AD 0288       457   clsr    lda  hibase     ; fill hi byte ptr table
     E562   09 80         458           ora  #$80
     E564   A8            459           tay
     E565   A9 00         460           lda  #0
     E567   AA            461           tax
     E568   94 D9         462   lps1    sty  ldtb1,x
     E56A   18            463           clc
     E56B   69 16         464           adc  #llen
     E56D   90 01         465           bcc  lps2
     E56F   C8            466           iny     ; carry bump hi byte
     E570   E8            467   lps2    inx

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 6-2
DECLARE   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     E571   E0 18         468           cpx  #nlines+1          ; done # of lines?
     E573   D0 F3         469           bne  lps1       ; no...
     E575   A9 FF         470           lda  #$ff       ; tag end of line table
     E577   95 D9         471           sta  ldtb1,x
     E579   A2 16         472           ldx  #nlines-1          ; clear from the bottom line up
     E57B   20 EA8D       473   clear1  jsr  clrln      ; see scroll routines
     E57E   CA            474           dex
     E57F   10 FA         475           bpl  clear1
                                
                                
                                
                                
                                
                          477   ;home function
                          478   ;
     E581   A0 00         479   nxtd    ldy  #0
     E583   84 D3         480           sty  pntr       ; left column
     E585   84 D6         481           sty  tblx       ; top line
                          482   ;
                          483   ;move cursor to tblx,pntr
                          484   ;
     E587                 485   stupt
     E587   A6 D6         486           ldx  tblx       ; get curent line index
     E589   A5 D3         487           lda  pntr       ; get character pointer
     E58B   B4 D9         488   fndstr  ldy  ldtb1,x    ; find begining of line
     E58D   30 08         489           bmi  stok       ; branch if start found
     E58F   18            490           clc
     E590   69 16         491           adc  #llen      ; adjust pointer
     E592   85 D3         492           sta  pntr
     E594   CA            493           dex
     E595   10 F4         494           bpl  fndstr
                          495   ;
     E597                 496   stok
     E597   B5 D9         497           lda  ldtb1,x
     E599   29 03         498           and  #$03       ; get rid of garbage
     E59B   0D 0288       499           ora  hibase     ; or in high order bits
     E59E   85 D2         500           sta  pnt+1
     E5A0   BD EDFD       501           lda  ldtb2,x
     E5A3   85 D1         502           sta  pnt
                          503   ;
     E5A5   A9 15         504           lda  #llen-1
     E5A7   E8            505           inx
     E5A8   B4 D9         506   fndend  ldy  ldtb1,x
     E5AA   30 06         507           bmi  stdone
     E5AC   18            508           clc
     E5AD   69 16         509           adc  #llen
     E5AF   E8            510           inx
     E5B0   10 F6         511           bpl  fndend
     E5B2                 512   stdone
     E5B2   85 D5         513           sta  lnmx

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 6-3
DECLARE   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     E5B4   60            514           rts
                                
                                
                                
                                
                                
                          516   ;panic nmi entry
                          517   ;
     E5B5   20 E5BB       518   vpan    jsr  panic      ; fix vic screen
     E5B8   4C E581       519           jmp  nxtd       ; home cursor
                                
                                
                                
                                
                                
     E5BB   A9 03         521   panic   lda  #3         ; reset default i/o
     E5BD   85 9A         522           sta  dflto
     E5BF   A9 00         523           lda  #0
     E5C1   85 99         524           sta  dfltn
                                
                                
                                
                                
                                
                          526   ;init vic
                          527   ;
     E5C3   A2 10         528   initv   ldx  #$10
     E5C5   BD EDE3       529   px4     lda  tvic-1,x
     E5C8   9D 8FFF       530           sta  vicreg-1,x
     E5CB   CA            531           dex
     E5CC   D0 F7         532           bne  px4
     E5CE   60            533           rts
                                
                                
                                
                                
                                
                          535   ;
                          536   ;remove character from queue
                          537   ;
     E5CF   AC 0277       538   lp2     ldy  keyd
     E5D2   A2 00         539           ldx  #0
     E5D4   BD 0278       540   lp1     lda  keyd+1,x
     E5D7   9D 0277       541           sta  keyd,x
     E5DA   E8            542           inx
     E5DB   E4 C6         543           cpx  ndx
     E5DD   D0 F5         544           bne  lp1
     E5DF   C6 C6         545           dec  ndx
     E5E1   98            546           tya
     E5E2   58            547           cli

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 6-4
DECLARE   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     E5E3   18            548           clc     ; good return
     E5E4   60            549           rts
                          550   
     E5E5   20 E742       551   loop4   jsr  prt
     E5E8   A5 C6         552   loop3   lda  ndx
     E5EA   85 CC         553           sta  blnsw
     E5EC   8D 0292       554           sta  autodn     ; turn on auto scroll down
     E5EF   F0 F7         555           beq  loop3
     E5F1   78            556           sei
     E5F2   A5 CF         557           lda  blnon
     E5F4   F0 0C         558           beq  lp21
     E5F6   A5 CE         559           lda  gdbln
     E5F8   AE 0287       560           ldx  gdcol      ; restore original color
     E5FB   A0 00         561           ldy  #0
     E5FD   84 CF         562           sty  blnon
     E5FF   20 EAA1       563           jsr  dspp
     E602   20 E5CF       564   lp21    jsr  lp2
     E605   C9 83         565           cmp  #$83       ; run key?
     E607   D0 10         566           bne  lp22
     E609   A2 09         567           ldx  #9
     E60B   78            568           sei
     E60C   86 C6         569           stx  ndx
     E60E   BD EDF3       570   lp23    lda  runtb-1,x
     E611   9D 0276       571           sta  keyd-1,x
     E614   CA            572           dex
     E615   D0 F7         573           bne  lp23
     E617   F0 CF         574           beq  loop3
     E619   C9 0D         575   lp22    cmp  #$d
     E61B   D0 C8         576           bne  loop4
     E61D   A4 D5         577           ldy  lnmx
     E61F   84 D0         578           sty  crsw
     E621   B1 D1         579   clp5    lda  (pnt),y
     E623   C9 20         580           cmp  #' '
     E625   D0 03         581           bne  clp6
     E627   88            582           dey
     E628   D0 F7         583           bne  clp5
     E62A   C8            584   clp6    iny
     E62B   84 C8         585           sty  indx
     E62D   A0 00         586           ldy  #0
     E62F   8C 0292       587           sty  autodn     ; turn off auto scroll down
     E632   84 D3         588           sty  pntr
     E634   84 D4         589           sty  qtsw
     E636   A5 C9         590           lda  lsxp
     E638   30 1D         591           bmi  lop5
     E63A   A6 D6         592           ldx  tblx
     E63C   20 E719       593           jsr  findst     ; find 1st physical line
     E63F   E4 C9         594           cpx  lsxp
     E641   D0 14         595           bne  lop5
     E643   D0 12         596           bne  lop5
     E645   A5 CA         597           lda  lstp

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 6-5
DECLARE   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     E647   85 D3         598           sta  pntr
     E649   C5 C8         599           cmp  indx
     E64B   90 0A         600           bcc  lop5
     E64D   B0 42         601           bcs  clp2
                                
                                
                                
                                
                                
                          603   ;input a line until carriage return
                          604   ;
     E64F   98            605   loop5   tya
     E650   48            606           pha
     E651   8A            607           txa
     E652   48            608           pha
     E653   A5 D0         609           lda  crsw
     E655   F0 91         610           beq  loop3
     E657   A4 D3         611   lop5    ldy  pntr
     E659   B1 D1         612           lda  (pnt),y
     E65B   EA EA EA      613   	.byte   $ea,$ea,$ea
     E65E   EA EA         614   	.byte   $ea,$ea
     E660   EA EA         615   	.byte   $ea,$ea
     E662   EA EA EA      616   	.byte   $ea,$ea,$ea
     E665   EA EA         617   	.byte   $ea,$ea
     E667   EA            618   	.byte   $ea
     E668   EA            619   	.byte   $ea
     E669   EA EA         620   	.byte   $ea,$ea
     E66B   EA EA         621   	.byte   $ea,$ea
     E66D   EA EA EA      622   	.byte   $ea,$ea,$ea
     E670   EA EA         623   	.byte   $ea,$ea
     E672                 624   notone
     E672   85 D7         625           sta  data
     E674   29 3F         626   lop51   and  #$3f
     E676   06 D7         627           asl  data
     E678   24 D7         628           bit  data
     E67A   10 02         629           bpl  lop54
     E67C   09 80         630           ora  #$80
     E67E   90 04         631   lop54   bcc  lop52
     E680   A6 D4         632           ldx  qtsw
     E682   D0 04         633           bne  lop53
     E684   70 02         634   lop52   bvs  lop53
     E686   09 40         635           ora  #$40
     E688   E6 D3         636   lop53   inc  pntr
     E68A   20 E6B8       637           jsr  qtswc
     E68D   C4 C8         638           cpy  indx
     E68F   D0 17         639           bne  clp1
     E691   A9 00         640   clp2    lda  #0
     E693   85 D0         641           sta  crsw
     E695   A9 0D         642           lda  #$d
     E697   A6 99         643           ldx  dfltn      ; fix gets from screen

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 6-6
DECLARE   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     E699   E0 03         644           cpx  #3         ; is it the screen?
     E69B   F0 06         645           beq  clp2a
     E69D   A6 9A         646           ldx  dflto
     E69F   E0 03         647           cpx  #3
     E6A1   F0 03         648           beq  clp21
     E6A3   20 E742       649   clp2a   jsr  prt
     E6A6   A9 0D         650   clp21   lda  #$d
     E6A8   85 D7         651   clp1    sta  data
     E6AA   68            652           pla
     E6AB   AA            653           tax
     E6AC   68            654           pla
     E6AD   A8            655           tay
     E6AE   A5 D7         656           lda  data
     E6B0   C9 DE         657           cmp  #$de       ; is it <pi> ?
     E6B2   D0 02         658           bne  clp7
     E6B4   A9 FF         659           lda  #$ff
     E6B6   18            660   clp7    clc
     E6B7   60            661           rts
                                
                                
                                
                                
                                
     E6B8   C9 22         663   qtswc   cmp  #$22
     E6BA   D0 08         664           bne  qtswl
     E6BC   A5 D4         665           lda  qtsw
     E6BE   49 01         666           eor  #$1
     E6C0   85 D4         667           sta  qtsw
     E6C2   A9 22         668           lda  #$22
     E6C4   60            669   qtswl   rts
                                
                                
                                
                                
                                
     E6C5   09 40         671   nxt33   ora  #$40
     E6C7   A6 C7         672   nxt3    ldx  rvs
     E6C9   F0 02         673           beq  nvs
     E6CB   09 80         674   nc3     ora  #$80
     E6CD   A6 D8         675   nvs     ldx  insrt
     E6CF   F0 02         676           beq  nvs1
     E6D1   C6 D8         677           dec  insrt
     E6D3   AE 0286       678   nvs1    ldx  color  put  color  on  screen
     E6D6   20 EAA1       679           jsr  dspp
     E6D9   20 E6EA       680           jsr  wlogic     ; check for wraparound
     E6DC   68            681   loop2   pla
     E6DD   A8            682           tay
     E6DE   A5 D8         683           lda  insrt
     E6E0   F0 02         684           beq  lop2
     E6E2   46 D4         685           lsr  qtsw

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 6-7
DECLARE   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     E6E4   68            686   lop2    pla
     E6E5   AA            687           tax
     E6E6   68            688           pla
     E6E7   18            689           clc     ; good return
     E6E8   58            690           cli
     E6E9   60            691           rts
                          692   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 7
DECLARE   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     E6EA                 694   wlogic
     E6EA   20 E8FA       695           jsr  chkdwn     ; maybe we should we increment tblx
     E6ED   E6 D3         696           inc  pntr       ; bump charcter pointer
     E6EF   A5 D5         697           lda  lnmx       ;
     E6F1   C5 D3         698           cmp  pntr       ; if lnmx is less than pntr
     E6F3   B0 37         699           bcs  wlgrts     ; branch if lnmx>=pntr
     E6F5   C9 57         700           cmp  #maxchr-1          ; past max characters
     E6F7   F0 2A         701           beq  wlog10     ; branch if so
     E6F9   AD 0292       702           lda  autodn     ; should we auto scroll down?
     E6FC   F0 03         703           beq  wlog20     ; branch if not
     E6FE   4C E9F0       704           jmp  bmt1       ; else decide which way to scroll
                                
                                
                                
     E701                 706   wlog20
     E701   A6 D6         707           ldx  tblx       ; see if we should scroll down
     E703   E0 17         708           cpx  #nlines
     E705   90 07         709           bcc  wlog30     ; branch if not
     E707   20 E975       710           jsr  scrol      ; else do the scrol up
     E70A   C6 D6         711           dec  tblx       ; and adjust curent line#
     E70C   A6 D6         712           ldx  tblx
     E70E   16 D9         713   wlog30  asl  ldtb1,x    ; wrap the line
     E710   56 D9         714           lsr  ldtb1,x
                          715   
     E712   4C ED5B       716           jmp  patchx     ; do the fix for run mode wrap
     E715                 717   patout          	; patch re-entry point
                          718   
     E715   69 16         719           adc  #llen
     E717   85 D5         720           sta  lnmx
     E719                 721   findst
     E719   B5 D9         722           lda  ldtb1,x    ; is this the first line?
     E71B   30 03         723           bmi  finx       ; branch if so
     E71D   CA            724           dex     ; else backup 1
     E71E   D0 F9         725           bne  findst
     E720                 726   finx
     E720   4C EA7E       727           jmp  setpnt     ; make sure pnt is right
                          728   
     E723   C6 D6         729   wlog10  dec  tblx
     E725   20 E8C3       730           jsr  nxln
     E728   A9 00         731           lda  #0
     E72A   85 D3         732           sta  pntr       ; point to first byte
     E72C   60            733   wlgrts  rts
                          734   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 8
DECLARE   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     E72D   A6 D6         736   bkln    ldx  tblx
     E72F   D0 06         737           bne  bkln1
     E731   86 D3         738           stx  pntr
     E733   68            739           pla
     E734   68            740           pla
     E735   D0 A5         741           bne  loop2
                          742   ;
     E737   CA            743   bkln1   dex
     E738   86 D6         744           stx  tblx
     E73A   20 E587       745           jsr  stupt
     E73D   A4 D5         746           ldy  lnmx
     E73F   84 D3         747           sty  pntr
     E741   60            748           rts
                                
                                
                                
                                
                                
                          750   ;print routine
                          751   ;
     E742   48            752   prt     pha
     E743   85 D7         753           sta  data
     E745   8A            754           txa
     E746   48            755           pha
     E747   98            756           tya
     E748   48            757           pha
     E749   A9 00         758           lda  #0
     E74B   85 D0         759           sta  crsw
     E74D   A4 D3         760           ldy  pntr
     E74F   A5 D7         761           lda  data
     E751   10 03         762           bpl  *+5
     E753   4C E800       763           jmp  nxtx
                          764   
     E756   C9 0D         765           cmp  #$d
     E758   D0 03         766           bne  njt1
     E75A   4C E8D8       767           jmp  nxt1
                          768   
     E75D   C9 20         769   njt1    cmp  #' '
     E75F   90 10         770           bcc  ntcn
     E761   C9 60         771           cmp  #$60       ; lower case?
     E763   90 04         772           bcc  njt8       ; no...
     E765   29 DF         773           and  #$df       ; yes...make screen lower
     E767   D0 02         774           bne  njt9       ; always
     E769   29 3F         775   njt8    and  #$3f
     E76B   20 E6B8       776   njt9    jsr  qtswc
     E76E   4C E6C7       777           jmp  nxt3
                          778   
     E771   A6 D8         779   ntcn    ldx  insrt
     E773   F0 03         780           beq  cnc3x
     E775   4C E6CB       781           jmp  nc3

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 8-1
DECLARE   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                          782   
     E778   C9 14         783   cnc3x   cmp  #$14
     E77A   D0 2E         784           bne  ntcn1
     E77C   98            785           tya
     E77D   D0 06         786           bne  bak1up
     E77F   20 E72D       787           jsr  bkln
     E782   4C E79F       788           jmp  bk2
                          789   
     E785   20 E8E8       790   bak1up  jsr  chkbak     ; should we dec tblx
     E788   88            791           dey
     E789   84 D3         792           sty  pntr
     E78B   20 EAB2       793   bk1     jsr  scolor     ; fix color ptrs
     E78E   C8            794   bk15    iny
     E78F   B1 D1         795           lda  (pnt),y
     E791   88            796           dey
     E792   91 D1         797           sta  (pnt),y
     E794   C8            798           iny
     E795   B1 F3         799           lda  (user),y
     E797   88            800           dey
     E798   91 F3         801           sta  (user),y
     E79A   C8            802           iny
     E79B   C4 D5         803           cpy  lnmx
     E79D   D0 EF         804           bne  bk15
     E79F   A9 20         805   bk2     lda  #' '
     E7A1   91 D1         806           sta  (pnt),y
     E7A3   AD 0286       807           lda  color
     E7A6   91 F3         808           sta  (user),y
     E7A8   10 4D         809           bpl  jpl3
     E7AA   A6 D4         810   ntcn1   ldx  qtsw
     E7AC   F0 03         811           beq  nc3w
     E7AE   4C E6CB       812   cnc3    jmp  nc3
                          813   
     E7B1   C9 12         814   nc3w    cmp  #$12
     E7B3   D0 02         815           bne  nc1
     E7B5   85 C7         816           sta  rvs
     E7B7   C9 13         817   nc1     cmp  #$13
     E7B9   D0 03         818           bne  nc2
     E7BB   20 E581       819           jsr  nxtd
     E7BE   C9 1D         820   nc2     cmp  #$1d
     E7C0   D0 17         821           bne  ncx2
     E7C2   C8            822           iny
     E7C3   20 E8FA       823           jsr  chkdwn
     E7C6   84 D3         824           sty  pntr
     E7C8   88            825           dey
     E7C9   C4 D5         826           cpy  lnmx
     E7CB   90 09         827           bcc  ncz2
     E7CD   C6 D6         828           dec  tblx
     E7CF   20 E8C3       829           jsr  nxln
     E7D2   A0 00         830           ldy  #0
     E7D4   84 D3         831   jpl4    sty  pntr

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 8-2
DECLARE   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     E7D6   4C E6DC       832   ncz2    jmp  loop2
                          833   
     E7D9   C9 11         834   ncx2    cmp  #$11
     E7DB   D0 1D         835           bne  colr1
     E7DD   18            836           clc
     E7DE   98            837           tya
     E7DF   69 16         838           adc  #llen
     E7E1   A8            839           tay
     E7E2   E6 D6         840           inc  tblx
     E7E4   C5 D5         841           cmp  lnmx
     E7E6   90 EC         842           bcc  jpl4
     E7E8   F0 EA         843           beq  jpl4
     E7EA   C6 D6         844           dec  tblx
     E7EC   E9 16         845   curs10  sbc  #llen
     E7EE   90 04         846           bcc  gotdwn
     E7F0   85 D3         847           sta  pntr
     E7F2   D0 F8         848           bne  curs10
     E7F4   20 E8C3       849   gotdwn  jsr  nxln
     E7F7   4C E6DC       850   jpl3    jmp  loop2
                          851   
     E7FA   20 E912       852   colr1   jsr  chkcol     ; check for a color
     E7FD   4C ED21       853           jmp  lower      ; was jmp loop2
                                
                                
                                
                          855   ;check color
                          856   ;
                                
                                
                                
                                
                                
                          858   ;shifted keys
                          859   ;
     E800   EA EA EA      860   nxtx     .byte  $ea,$ea,$ea
     E803   EA EA         861   	.byte   $ea,$ea
     E805   EA EA         862   	.byte   $ea,$ea
     E807   EA EA EA      863   	.byte   $ea,$ea,$ea
     E80A   EA EA         864   	.byte    $ea,$ea
     E80C   EA            865   	.byte   $ea
     E80D   EA            866   	.byte   $ea
     E80E   EA EA         867   	.byte   $ea,$ea
                          868   ;
     E810   EA EA         869   	.byte   $ea,$ea
                          870   ;
     E812   EA EA EA      871   	.byte   $ea,$ea,$ea
     E815                 872   keepit
     E815   29 7F         873           and  #$7f
     E817   C9 7F         874           cmp  #$7f
     E819   D0 02         875           bne  nxtx1

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 8-3
DECLARE   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     E81B   A9 5E         876           lda  #$5e
     E81D   EA EA         877   nxtx1    .byte  $ea,$ea
     E81F   EA EA         878   	.byte    $ea,$ea
     E821   EA EA         879   	.byte    $ea,$ea
     E823                 880   nxtxa
     E823   C9 20         881           cmp  #$20       ; is it a function key
     E825   90 03         882           bcc  uhuh
     E827   4C E6C5       883           jmp  nxt33
                          884   
     E82A                 885   uhuh
     E82A   C9 0D         886           cmp  #$d
     E82C   D0 03         887           bne  up5
     E82E   4C E8D8       888           jmp  nxt1
                          889   
     E831   A6 D4         890   up5     ldx  qtsw
     E833   D0 3F         891           bne  up6
     E835   C9 14         892           cmp  #$14
     E837   D0 37         893           bne  up9
     E839   A4 D5         894           ldy  lnmx
     E83B   B1 D1         895           lda  (pnt),y
     E83D   C9 20         896           cmp  #' '
     E83F   D0 04         897           bne  ins3
     E841   C4 D3         898           cpy  pntr
     E843   D0 07         899           bne  ins1
     E845   C0 57         900   ins3    cpy  #maxchr-1
     E847   F0 24         901           beq  insext     ; exit if line too long
     E849   20 E9EE       902           jsr  newlin     ; scroll down 1
     E84C   A4 D5         903   ins1    ldy  lnmx
     E84E   20 EAB2       904           jsr  scolor
     E851   88            905   ins2    dey
     E852   B1 D1         906           lda  (pnt),y
     E854   C8            907           iny
     E855   91 D1         908           sta  (pnt),y
     E857   88            909           dey
     E858   B1 F3         910           lda  (user),y
     E85A   C8            911           iny
     E85B   91 F3         912           sta  (user),y
     E85D   88            913           dey
     E85E   C4 D3         914           cpy  pntr
     E860   D0 EF         915           bne  ins2
     E862   A9 20         916           lda  #$20
     E864   91 D1         917           sta  (pnt),y
     E866   AD 0286       918           lda  color
     E869   91 F3         919           sta  (user),y
     E86B   E6 D8         920           inc  insrt
     E86D   4C E6DC       921   insext  jmp  loop2
                          922   
     E870   A6 D8         923   up9     ldx  insrt
     E872   F0 05         924           beq  up2
     E874   09 40         925   up6     ora  #$40

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 8-4
DECLARE   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     E876   4C E6CB       926           jmp  nc3
                          927   
     E879   C9 11         928   up2     cmp  #$11
     E87B   D0 16         929           bne  nxt2
     E87D   A6 D6         930           ldx  tblx
     E87F   F0 37         931           beq  jpl2
     E881   C6 D6         932           dec  tblx
     E883   A5 D3         933           lda  pntr
     E885   38            934           sec
     E886   E9 16         935           sbc  #llen
     E888   90 04         936           bcc  upalin
     E88A   85 D3         937           sta  pntr
     E88C   10 2A         938           bpl  jpl2
     E88E   20 E587       939   upalin  jsr  stupt
     E891   D0 25         940           bne  jpl2
     E893   C9 12         941   nxt2    cmp  #$12
     E895   D0 04         942           bne  nxt6
     E897   A9 00         943           lda  #0
     E899   85 C7         944           sta  rvs
     E89B   C9 1D         945   nxt6    cmp  #$1d
     E89D   D0 12         946           bne  nxt61
     E89F   98            947           tya
     E8A0   F0 09         948           beq  bakbak
     E8A2   20 E8E8       949           jsr  chkbak
     E8A5   88            950           dey
     E8A6   84 D3         951           sty  pntr
     E8A8   4C E6DC       952           jmp  loop2
                          953   
     E8AB   20 E72D       954   bakbak  jsr  bkln
     E8AE   4C E6DC       955           jmp  loop2
                          956   
     E8B1   C9 13         957   nxt61   cmp  #$13
     E8B3   D0 06         958           bne  sccl
     E8B5   20 E55F       959           jsr  clsr
     E8B8   4C E6DC       960   jpl2    jmp  loop2
                          961   
     E8BB                 962   sccl
     E8BB   09 80         963           ora  #$80       ; make it upper case
     E8BD   20 E912       964           jsr  chkcol     ; try for color
     E8C0   4C ED30       965           jmp  upper      ; was jmp loop2
                          966   ;
     E8C3   46 C9         967   nxln    lsr  lsxp
     E8C5   A6 D6         968           ldx  tblx
     E8C7   E8            969   nxln2   inx
     E8C8   E0 17         970           cpx  #nlines    ; off bottom?
     E8CA   D0 03         971           bne  nxln1      ; no...
     E8CC   20 E975       972           jsr  scrol      ; yes...scroll
     E8CF   B5 D9         973   nxln1   lda  ldtb1,x    ; double line?
     E8D1   10 F4         974           bpl  nxln2      ; yes...scroll again
     E8D3   86 D6         975           stx  tblx

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 8-5
DECLARE   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     E8D5   4C E587       976           jmp  stupt
                          977   
     E8D8                 978   nxt1
     E8D8   A2 00         979           ldx  #0
     E8DA   86 D8         980           stx  insrt
     E8DC   86 C7         981           stx  rvs
     E8DE   86 D4         982           stx  qtsw
     E8E0   86 D3         983           stx  pntr
     E8E2   20 E8C3       984           jsr  nxln
     E8E5   4C E6DC       985   jpl5    jmp  loop2
                          986   ;
                          987   ;
                          988   ; check for a decrement tblx
                          989   ;
     E8E8   A2 04         990   chkbak  ldx  #nwrap
     E8EA   A9 00         991           lda  #0
     E8EC   C5 D3         992   chklup  cmp  pntr
     E8EE   F0 07         993           beq  back
     E8F0   18            994           clc
     E8F1   69 16         995           adc  #llen
     E8F3   CA            996           dex
     E8F4   D0 F6         997           bne  chklup
     E8F6   60            998           rts
                          999   ;
     E8F7   C6 D6        1000   back    dec  tblx
     E8F9   60           1001           rts
                         1002   ;
                         1003   ; check for increment tblx
                         1004   ;
     E8FA   A2 04        1005   chkdwn  ldx  #nwrap
     E8FC   A9 15        1006           lda  #llen-1
     E8FE   C5 D3        1007   dwnchk  cmp  pntr
     E900   F0 07        1008           beq  dnline
     E902   18           1009           clc
     E903   69 16        1010           adc  #llen
     E905   CA           1011           dex
     E906   D0 F6        1012           bne  dwnchk
     E908   60           1013           rts
                         1014   ;
     E909   A6 D6        1015   dnline  ldx  tblx
     E90B   E0 17        1016           cpx  #nlines
     E90D   F0 02        1017           beq  dwnbye
     E90F   E6 D6        1018           inc  tblx
                         1019   ;
     E911   60           1020   dwnbye  rts
                                
                                
     E912                1022   chkcol
     E912   A2 07        1023           ldx  #7         ; there's 8 colors
     E914   DD E921      1024   chk1a   cmp  coltab,x

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 8-6
DECLARE   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     E917   F0 04        1025           beq  chk1b
     E919   CA           1026           dex
     E91A   10 F8        1027           bpl  chk1a
     E91C   60           1028           rts
                         1029   ;
     E91D                1030   chk1b
     E91D   8E 0286      1031           stx  color      ; change the color
     E920   60           1032           rts
                         1033   
     E921                1034   coltab
                         1035   ;blk,wht,red,cyan,magenta,grn,blue,yellow
     E921   90 05 1C     1036   	.byte   $90,$05,$1c,$9f,$9c,$1e,$1f,$9e
     E924   9F 9C 1E            
     E927   1F 9E               
                         1037   
                         1038   ;********************************
                         1039   ; the following table serves to
                         1040   ; convert to and from screen code
                         1041   ; to kascii.  it is implemented for
                         1042   ; testing only.  it could be improved
                         1043   ; to reduce code and speed by an
                         1044   ; algorithm
                         1045   ;
                         1046   ;*********************************
                         1047   ;.end
                         1048   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 9
CONKAT   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         1050   	.subttl CONKAT
                         1051   
     E929   EF A1        1052   	.byte   $ef,$a1        ; all of this is available for patch space
     E92B   DF A6        1053   	.byte   $df,$a6
     E92D   E1 B1        1054   	.byte   $e1,$b1
     E92F   E2 B2        1055   	.byte   $e2,$b2
     E931   E3 B3        1056   	.byte   $e3,$b3
     E933   E4 B4        1057   	.byte   $e4,$b4
     E935   E5 B5        1058   	.byte   $e5,$b5
     E937   E6 B6        1059   	.byte   $e6,$b6
     E939   E7 B7        1060   	.byte   $e7,$b7
     E93B   E8 B8        1061   	.byte   $e8,$b8
     E93D   E9 B9        1062   	.byte   $e9,$b9
     E93F   FA BA        1063   	.byte   $fa,$ba
     E941   FB BB        1064   	.byte   $fb,$bb
     E943   FC BC        1065   	.byte   $fc,$bc
     E945   EC BD        1066   	.byte   $ec,$bd
     E947   FE BE        1067   	.byte   $fe,$be
     E949   84 BF        1068   	.byte   $84,$bf
     E94B   F7 C0        1069   	.byte   $f7,$c0
     E94D   F8 DB        1070   	.byte   $f8,$db
     E94F   F9 DD        1071   	.byte   $f9,$dd
     E951   EA DE        1072   	.byte   $ea,$de
     E953                1073   unkat
     E953   5E E0        1074   	.byte   $5e,$e0        ; e0-e2 special conversion codes
     E955   5B E1        1075   	.byte   $5b,$e1
     E957   5D E2        1076   	.byte   $5d,$e2
     E959   40 B0        1077   	.byte   $40,$b0
     E95B   61 B1        1078   	.byte   $61,$b1        ; unconversion
     E95D   78 DB        1079   	.byte   $78,$db
     E95F   79 DD        1080   	.byte   $79,$dd
     E961   66 B6        1081   	.byte   $66,$b6
     E963   77 C0        1082   	.byte   $77,$c0
     E965   70 F0        1083   	.byte   $70,$f0
     E967   71 F1        1084   	.byte   $71,$f1
     E969   72 F2        1085   	.byte   $72,$f2
     E96B   73 F3        1086   	.byte   $73,$f3
     E96D   74 F4        1087   	.byte   $74,$f4
     E96F   75 F5        1088   	.byte   $75,$f5
     E971   76 F6        1089   	.byte   $76,$f6
     E973   7D FD        1090   	.byte   $7d,$fd
                         1091   
                         1092   ;.end
                         1093   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 10
EDITOR.2   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         1095   	.subttl EDITOR.2
                         1096   ;screen scroll routine
                         1097   ;
     E975   A5 AC        1098   scrol   lda  sal
     E977   48           1099           pha
     E978   A5 AD        1100           lda  sah
     E97A   48           1101           pha
     E97B   A5 AE        1102           lda  eal
     E97D   48           1103           pha
     E97E   A5 AF        1104           lda  eah
     E980   48           1105           pha
                         1106   ;
                         1107   ;   s c r o l l   u p
                         1108   ;
     E981   A2 FF        1109   scro0   ldx  #$ff
     E983   C6 D6        1110           dec  tblx
     E985   C6 C9        1111           dec  lsxp
     E987   C6 F2        1112           dec  lintmp
     E989   E8           1113   scr10   inx     ; goto next line
     E98A   20 EA7E      1114           jsr  setpnt     ; point to 'to' line
     E98D   E0 16        1115           cpx  #nlines-1          ; done?
     E98F   B0 0C        1116           bcs  scr41      ; branch if so
                         1117   ;
     E991   BD EDFE      1118           lda  ldtb2+1,x          ; setup from pntr
     E994   85 AC        1119           sta  sal
     E996   B5 DA        1120           lda  ldtb1+1,x
     E998   20 EA56      1121           jsr  scrlin     ; scroll this line up1
     E99B   30 EC        1122           bmi  scr10
                         1123   ;
     E99D                1124   scr41
     E99D   20 EA8D      1125           jsr  clrln
                         1126   ;
     E9A0   A2 00        1127           ldx  #0         ; scroll hi byte pointers
     E9A2   B5 D9        1128   scrl5   lda  ldtb1,x
     E9A4   29 7F        1129           and  #$7f
     E9A6   B4 DA        1130           ldy  ldtb1+1,x
     E9A8   10 02        1131           bpl  scrl3
     E9AA   09 80        1132           ora  #$80
     E9AC   95 D9        1133   scrl3   sta  ldtb1,x
     E9AE   E8           1134           inx
     E9AF   E0 16        1135           cpx  #nlines-1
     E9B1   D0 EF        1136           bne  scrl5
                         1137   ;
     E9B3   A5 EF        1138           lda  ldtb1+nlines-1
     E9B5   09 80        1139           ora  #$80
     E9B7   85 EF        1140           sta  ldtb1+nlines-1
     E9B9   A5 D9        1141           lda  ldtb1      ; double line?
     E9BB   10 C4        1142           bpl  scro0      ; yes...scroll again
                         1143   ;
     E9BD   E6 D6        1144           inc  tblx

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 10-1
EDITOR.2   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     E9BF   E6 F2        1145           inc  lintmp
     E9C1   A9 FB        1146           lda  #$fb       ; check for control key
     E9C3   8D 9120      1147           sta  colm       ; drop line 2 on port b
     E9C6   AD 9121      1148           lda  rows
     E9C9   C9 FE        1149           cmp  #$fe       ; slow scroll key?(control)
     E9CB   08           1150           php     ; save status. restore port b
     E9CC   A9 F7        1151           lda  #$f7       ; for stop key check
     E9CE   8D 9120      1152           sta  colm
     E9D1   28           1153           plp
     E9D2   D0 0B        1154           bne  mlp42
                         1155   ;
     E9D4   A0 00        1156           ldy  #0
     E9D6   EA           1157   mlp4    nop     ; delay
     E9D7   CA           1158           dex
     E9D8   D0 FC        1159           bne  mlp4
     E9DA   88           1160           dey
     E9DB   D0 F9        1161           bne  mlp4
     E9DD   84 C6        1162           sty  ndx        ; clear key queue buffer
                         1163   ;
     E9DF   A6 D6        1164   mlp42   ldx  tblx
                         1165   ;
     E9E1   68           1166           pla
     E9E2   85 AF        1167           sta  eah
     E9E4   68           1168           pla
     E9E5   85 AE        1169           sta  eal
     E9E7   68           1170           pla
     E9E8   85 AD        1171           sta  sah
     E9EA   68           1172           pla
     E9EB   85 AC        1173           sta  sal
                         1174   ;
     E9ED   60           1175           rts

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 11
EDITOR.2   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     E9EE                1177   newlin
     E9EE   A6 D6        1178           ldx  tblx
     E9F0   E8           1179   bmt1    inx
     E9F1   B5 D9        1180           lda  ldtb1,x    ; find last display line of this line
     E9F3   10 FB        1181           bpl  bmt1
     E9F5   86 F2        1182           stx  lintmp     ; found it
                         1183   ;generate a new line
     E9F7   E0 16        1184           cpx  #nlines-1          ; is one line from bottom?
     E9F9   F0 0D        1185           beq  newlx      ; yes...just clear last
     E9FB   90 0B        1186           bcc  newlx      ; <nlines...insert line
     E9FD   20 E975      1187           jsr  scrol      ; scroll everything
     EA00   A6 F2        1188           ldx  lintmp
     EA02   CA           1189           dex
     EA03   C6 D6        1190           dec  tblx
     EA05   4C E70E      1191           jmp  wlog30
                         1192   
     EA08   A5 AC        1193   newlx   lda  sal
     EA0A   48           1194           pha
     EA0B   A5 AD        1195           lda  sah
     EA0D   48           1196           pha
     EA0E   A5 AE        1197           lda  eal
     EA10   48           1198           pha
     EA11   A5 AF        1199           lda  eah
     EA13   48           1200           pha
     EA14   A2 17        1201           ldx  #nlines
     EA16   CA           1202   scd10   dex
     EA17   20 EA7E      1203           jsr  setpnt     ; set up to addr
     EA1A   E4 F2        1204           cpx  lintmp
     EA1C   90 0E        1205           bcc  scr40
     EA1E   F0 0C        1206           beq  scr40      ; branch if finished
     EA20   BD EDFC      1207           lda  ldtb2-1,x          ; set from addr
     EA23   85 AC        1208           sta  sal
     EA25   B5 D8        1209           lda  ldtb1-1,x
     EA27   20 EA56      1210           jsr  scrlin     ; scroll this line down
     EA2A   30 EA        1211           bmi  scd10
     EA2C                1212   scr40
     EA2C   20 EA8D      1213           jsr  clrln
     EA2F   A2 15        1214           ldx  #nlines-2
     EA31                1215   scrd21
     EA31   E4 F2        1216           cpx  lintmp     ; done?
     EA33   90 0F        1217           bcc  scrd22     ; branch if so
     EA35   B5 DA        1218           lda  ldtb1+1,x
     EA37   29 7F        1219           and  #$7f
     EA39   B4 D9        1220           ldy  ldtb1,x    ; was it continued
     EA3B   10 02        1221           bpl  scrd19     ; branch if so
     EA3D   09 80        1222           ora  #$80
     EA3F   95 DA        1223   scrd19  sta  ldtb1+1,x
     EA41   CA           1224           dex
     EA42   D0 ED        1225           bne  scrd21
     EA44                1226   scrd22

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 11-1
EDITOR.2   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     EA44   A6 F2        1227           ldx  lintmp
     EA46   20 E70E      1228           jsr  wlog30
                         1229   ;
     EA49   68           1230           pla
     EA4A   85 AF        1231           sta  eah
     EA4C   68           1232           pla
     EA4D   85 AE        1233           sta  eal
     EA4F   68           1234           pla
     EA50   85 AD        1235           sta  sah
     EA52   68           1236           pla
     EA53   85 AC        1237           sta  sal
     EA55   60           1238           rts
                         1239   ;
                         1240   ; scroll line from sal to pnt
                         1241   ; and colors from eal to user
                         1242   ;
     EA56                1243   scrlin
     EA56   29 03        1244           and  #$03       ; clear any garbage stuff
     EA58   0D 0288      1245           ora  hibase     ; put in hiorder bits
     EA5B   85 AD        1246           sta  sal+1
     EA5D   20 EA6E      1247           jsr  tofrom     ; color to & from addrs
     EA60   A0 15        1248           ldy  #llen-1
     EA62                1249   scd20
     EA62   B1 AC        1250           lda  (sal),y
     EA64   91 D1        1251           sta  (pnt),y
     EA66   B1 AE        1252           lda  (eal),y
     EA68   91 F3        1253           sta  (user),y
     EA6A   88           1254           dey
     EA6B   10 F5        1255           bpl  scd20
     EA6D   60           1256           rts
                         1257   ;
                         1258   ; do color to and from addresses
                         1259   ; from character to and from adrs
                         1260   ;
     EA6E                1261   tofrom
     EA6E   20 EAB2      1262           jsr  scolor
     EA71   A5 AC        1263           lda  sal        ; character from
     EA73   85 AE        1264           sta  eal        ; make color from
     EA75   A5 AD        1265           lda  sal+1
     EA77   29 03        1266           and  #$03
     EA79   09 94        1267           ora  #>viccol
     EA7B   85 AF        1268           sta  eal+1
     EA7D   60           1269           rts
                         1270   ;
                         1271   ; set up pnt and y
                         1272   ; from .x
                         1273   ;
     EA7E   BD EDFD      1274   setpnt  lda  ldtb2,x
     EA81   85 D1        1275           sta  pnt
     EA83   B5 D9        1276           lda  ldtb1,x

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 11-2
EDITOR.2   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     EA85   29 03        1277           and  #$03
     EA87   0D 0288      1278           ora  hibase
     EA8A   85 D2        1279           sta  pnt+1
     EA8C   60           1280           rts
                         1281   ;
                         1282   ; clear the line pointed to by .x
                         1283   ;
     EA8D   A0 15        1284   clrln   ldy  #llen-1
     EA8F   20 EA7E      1285           jsr  setpnt
     EA92   20 EAB2      1286           jsr  scolor
     EA95   A9 20        1287   clr10   lda  #$20
     EA97   91 D1        1288           sta  (pnt),y
     EA99   A9 01        1289           lda  #white     ; do the color
     EA9B   91 F3        1290           sta  (user),y
     EA9D   88           1291           dey
     EA9E   10 F5        1292           bpl  clr10
     EAA0   60           1293           rts
                                
                                
                                
                                
                                
                         1295   ;
                         1296   ;put a char on the screen
                         1297   ;
     EAA1   A8           1298   dspp    tay     ; save char
     EAA2   A9 02        1299           lda  #2
     EAA4   85 CD        1300           sta  blnct      ; blink cursor
     EAA6   20 EAB2      1301           jsr  scolor     ; set color ptr
     EAA9   98           1302           tya     ; restore color
     EAAA   A4 D3        1303   dspp2   ldy  pntr       ; get column
     EAAC   91 D1        1304           sta  (pnt),y    ; char to screen
     EAAE   8A           1305           txa
     EAAF   91 F3        1306           sta  (user),y   ; color to screen
     EAB1   60           1307           rts
                                
                                
                                
                                
                                
     EAB2   A5 D1        1309   scolor  lda  pnt        ; generate color ptr
     EAB4   85 F3        1310           sta  user
     EAB6   A5 D2        1311           lda  pnt+1
     EAB8   29 03        1312           and  #$03
     EABA   09 94        1313           ora  #>viccol   ; vic color ram
     EABC   85 F4        1314           sta  user+1
     EABE   60           1315           rts

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 12
EDITOR.2   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     EABF   20 FFEA      1317   key     jsr  $ffea      ; update jiffy clock
     EAC2   A5 CC        1318           lda  blnsw      ; blinking crsr ?
     EAC4   D0 29        1319           bne  key4       ; no
     EAC6   C6 CD        1320           dec  blnct      ; time to blink ?
     EAC8   D0 25        1321           bne  key4       ; no
     EACA   A9 14        1322           lda  #20        ; reset blink counter
     EACC   85 CD        1323   repdo   sta  blnct
     EACE   A4 D3        1324           ldy  pntr       ; cursor position
     EAD0   46 CF        1325           lsr  blnon      ; carry set if original char
     EAD2   AE 0287      1326           ldx  gdcol      ; get char original color
     EAD5   B1 D1        1327           lda  (pnt),y    ; get character
     EAD7   B0 11        1328           bcs  key5       ; branch if not needed
                         1329   ;
     EAD9   E6 CF        1330           inc  blnon      ; set to 1
     EADB   85 CE        1331           sta  gdbln      ; save original char
     EADD   20 EAB2      1332           jsr  scolor
     EAE0   B1 F3        1333           lda  (user),y   ; get original color
     EAE2   8D 0287      1334           sta  gdcol      ; save it
     EAE5   AE 0286      1335           ldx  color      ; blink in this color
     EAE8   A5 CE        1336           lda  gdbln      ; with original character
                         1337   ;
     EAEA   49 80        1338   key5    eor  #$80       ; blink it
     EAEC   20 EAAA      1339           jsr  dspp2      ; display it
                         1340   ;
     EAEF   AD 911F      1341   key4    lda  d1ora      ; get cassette switches
     EAF2   29 40        1342           and  #$40       ; is swithc down
     EAF4   F0 0B        1343           beq  key3       ; branch if so
                         1344   ;
     EAF6   A0 00        1345           ldy  #0
     EAF8   84 C0        1346           sty  cas1       ; cassette off switch
                         1347   ;
     EAFA   AD 911C      1348           lda  d1pcr
     EAFD   09 02        1349           ora  #$02
     EAFF   D0 09        1350           bne  kl24       ; branch if motor is off
                         1351   ;
     EB01   A5 C0        1352   key3    lda  cas1
     EB03   D0 0D        1353           bne  kl2
                         1354   ;
     EB05   AD 911C      1355           lda  d1pcr
     EB08   29 FD        1356           and  #$fd       ; turn motor on
                         1357   ;
     EB0A   2C 911E      1358   kl24    bit  d1ier      ; check rs-232 transmitter on (t1)
     EB0D   70 03        1359           bvs  kl2        ; yes...no manual cass controls
     EB0F   8D 911C      1360           sta  d1pcr
                         1361   ;
     EB12   20 EB1E      1362   kl2     jsr  scnkey     ; scan keyboard
                         1363   ;
     EB15   2C 9124      1364   kprend  bit  d2t1l      ; clear interupt flag
     EB18   68           1365           pla     ; restore registers
     EB19   A8           1366           tay

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 12-1
EDITOR.2   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     EB1A   68           1367           pla
     EB1B   AA           1368           tax
     EB1C   68           1369           pla
     EB1D   40           1370           rti     ; exit from irq routines
                                
                                
                                
                         1372   ; ****** general keyboard scan ******
                         1373   ;
     EB1E   A9 00        1374   scnkey  lda  #$00
     EB20   8D 028D      1375           sta  shflag
     EB23   A0 40        1376           ldy  #64        ; last key index
     EB25   84 CB        1377           sty  sfdx       ; null key found
     EB27   8D 9120      1378           sta  colm       ; raise all lines
     EB2A   AE 9121      1379           ldx  rows       ; check for a key down
     EB2D   E0 FF        1380           cpx  #$ff       ; no keys down?
     EB2F   F0 5E        1381           beq  scnout     ; branch if none
                         1382   ; lda crfac ;check for restore background/boarder
                         1383   ; bpl dontre ;don't restore if plus
                         1384   ; lda crfac+1 ;get old value
                         1385   ; sta vicreg+15 ;put it back in vic
                         1386   ;dontre
                         1387   ; lda #0
                         1388   ; sta crfac ;remember i changed it back
     EB31   A9 FE        1389           lda  #$fe       ; start with 1st column
     EB33   8D 9120      1390           sta  colm
     EB36   A0 00        1391           ldy  #0
     EB38   A9 5E        1392           lda  #<mode1
     EB3A   85 F5        1393           sta  keytab
     EB3C   A9 EC        1394           lda  #>mode1
     EB3E   85 F6        1395           sta  keytab+1
     EB40   A2 08        1396   scn20   ldx  #8         ; 8 row keyboard
     EB42   AD 9121      1397           lda  rows
     EB45   CD 9121      1398           cmp  rows       ; debounce keyboard
     EB48   D0 F6        1399           bne  scn20
     EB4A   4A           1400   scn30   lsr  a          ; look for key down
     EB4B   B0 16        1401           bcs  ckit       ; none
     EB4D   48           1402           pha
     EB4E   B1 F5        1403           lda  (keytab),y         ; get char code
     EB50   C9 05        1404           cmp  #$05
     EB52   B0 0C        1405           bcs  spck2      ; if not special key go on
     EB54   C9 03        1406           cmp  #$03       ; could it be a stop key?
     EB56   F0 08        1407           beq  spck2      ; branch if so
     EB58   0D 028D      1408           ora  shflag
     EB5B   8D 028D      1409           sta  shflag     ; put shift bit in flag byte
     EB5E   10 02        1410           bpl  ckut
     EB60                1411   spck2
     EB60   84 CB        1412           sty  sfdx       ; save key number
     EB62   68           1413   ckut    pla
     EB63   C8           1414   ckit    iny

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 12-2
EDITOR.2   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     EB64   C0 41        1415           cpy  #65
     EB66   B0 09        1416           bcs  ckit1      ; branch if finished
     EB68   CA           1417           dex
     EB69   D0 DF        1418           bne  scn30
     EB6B   38           1419           sec
     EB6C   2E 9120      1420           rol  colm       ; next column on keyboard
     EB6F   D0 CF        1421           bne  scn20      ; always branch
                         1422   
     EB71                1423   ckit1
     EB71   6C 028F      1424           jmp  (keylog)   ; evaluate shift functions
                         1425   
     EB74   A4 CB        1426   rekey   ldy  sfdx       ; get key index
     EB76   B1 F5        1427           lda  (keytab),y         ; get char code
     EB78   AA           1428           tax     ; save the char
     EB79   C4 C5        1429           cpy  lstx       ; same as prev char index?
     EB7B   F0 07        1430           beq  rpt10      ; yes
     EB7D   A0 10        1431           ldy  #$10       ; no - reset delay before repeat
     EB7F   8C 028C      1432           sty  delay
     EB82   D0 36        1433           bne  ckit2      ; always
     EB84   29 7F        1434   rpt10   and  #$7f       ; unshift it
     EB86   2C 028A      1435           bit  rptflg     ; check for repeat disable
     EB89   30 16        1436           bmi  rpt20      ; yes
     EB8B   70 49        1437           bvs  scnrts
     EB8D   C9 7F        1438           cmp  #$7f       ; no keys ?
     EB8F   F0 29        1439   scnout  beq  ckit2      ; yes - get out
     EB91   C9 14        1440           cmp  #$14       ; an inst/del key ?
     EB93   F0 0C        1441           beq  rpt20      ; yes - repeat it
     EB95   C9 20        1442           cmp  #$20       ; a space key ?
     EB97   F0 08        1443           beq  rpt20      ; yes
     EB99   C9 1D        1444           cmp  #$1d       ; a crsr left/right ?
     EB9B   F0 04        1445           beq  rpt20      ; yes
     EB9D   C9 11        1446           cmp  #$11       ; a crsr up/dwn ?
     EB9F   D0 35        1447           bne  scnrts     ; no - exit
     EBA1   AC 028C      1448   rpt20   ldy  delay      ; time to repeat ?
     EBA4   F0 05        1449           beq  rpt40      ; yes
     EBA6   CE 028C      1450           dec  delay
     EBA9   D0 2B        1451           bne  scnrts
     EBAB   CE 028B      1452   rpt40   dec  kount      ; time for next repeat ?
     EBAE   D0 26        1453           bne  scnrts     ; no
     EBB0   A0 04        1454           ldy  #4         ; yes - reset ctr
     EBB2   8C 028B      1455           sty  kount
     EBB5   A4 C6        1456           ldy  ndx        ; no repeat if queue full
     EBB7   88           1457           dey
     EBB8   10 1C        1458           bpl  scnrts
     EBBA                1459   ckit2
     EBBA   A4 CB        1460           ldy  sfdx       ; get index of key
     EBBC   84 C5        1461           sty  lstx       ; save this index to key found
     EBBE   AC 028D      1462           ldy  shflag     ; update shift status
     EBC1   8C 028E      1463           sty  lstshf
     EBC4   E0 FF        1464   ckit3   cpx  #$ff       ; a null key or no key ?

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 12-3
EDITOR.2   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     EBC6   F0 0E        1465           beq  scnrts     ; branch if so
     EBC8   8A           1466           txa     ; need x as index so...
     EBC9   A6 C6        1467           ldx  ndx        ; get # of chars in key queue
     EBCB   EC 0289      1468           cpx  xmax       ; irq buffer full ?
     EBCE   B0 06        1469           bcs  scnrts     ; yes - no more insert
     EBD0                1470   putque
     EBD0   9D 0277      1471           sta  keyd,x     ; put raw data here
     EBD3   E8           1472           inx
     EBD4   86 C6        1473           stx  ndx        ; update key queue count
                         1474   
     EBD6   A9 F7        1475   scnrts  lda  #$f7       ; setup pb3 for stop key sense
     EBD8   8D 9120      1476           sta  colm
     EBDB   60           1477           rts

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 13
EDITOR.2   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         1479   ;
                         1480   ; shift logic
                         1481   ;
     EBDC                1482   shflog
     EBDC   AD 028D      1483           lda  shflag
     EBDF   C9 03        1484           cmp  #$03       ; commodore shift combination?
     EBE1   D0 2C        1485           bne  keylg2     ; branch if not
     EBE3   CD 028E      1486           cmp  lstshf     ; did i do this already
     EBE6   F0 EE        1487           beq  scnrts     ; branch if so
     EBE8   AD 0291      1488           lda  mode
     EBEB   30 56        1489           bmi  shfout     ; dont shift if its minus
                         1490   
     EBED   EA EA        1491   	.byte    $ea,$ea        ; and #$18 ;which mode?
     EBEF   EA EA        1492   	.byte    $ea,$ea        ; beq kataon ;if pet mode turnon katakana
     EBF1   EA EA        1493   	.byte    $ea,$ea        ; lda #0
     EBF3   EA EA EA     1494   	.byte    $ea,$ea,$ea    ; sta mode ;set pet mode
     EBF6   EA EA EA     1495   	.byte    $ea,$ea,$ea    ; lda vicreg+5 ;turn on petset
     EBF9   EA EA        1496   	.byte    $ea,$ea        ; and #$fd ;clear bit 1
     EBFB   EA EA EA     1497   	.byte    $ea,$ea,$ea    ; sta vicreg+5
     EBFE   EA EA        1498   	.byte    $ea,$ea        ; bne shfout
                         1499   
     EC00   AD 9005      1500   switch  lda  vicreg+5
     EC03   49 02        1501           eor  #$02       ; turn on other case
     EC05   8D 9005      1502           sta  vicreg+5   ; point the vic there
     EC08   EA EA        1503   	.byte    $ea,$ea        ; lda #8 ;set katakana mode
     EC0A   EA EA        1504   	.byte    $ea,$ea        ; sta mode
     EC0C   4C EC43      1505           jmp  shfout
                         1506   
     EC0F                1507   keylg2
     EC0F   0A           1508           asl  a
     EC10   C9 08        1509           cmp  #$08       ; was it a control key
     EC12   90 04        1510           bcc  nctrl      ; branch if not
     EC14   A9 06        1511           lda  #6         ; else use table #4
     EC16   EA EA        1512   	.byte    $ea,$ea        ; bne notkat ;do the table shift
                         1513   ;
     EC18                1514   nctrl
     EC18   EA EA EA     1515   	.byte   $ea,$ea,$ea    ; ldx mode
     EC1B   EA EA        1516   	.byte   $ea,$ea        ; beq notkat
     EC1D   EA EA EA     1517   	.byte   $ea,$ea,$ea    ; ldx shflag ;see if co.key
     EC20   EA EA        1518   	.byte   $ea,$ea        ; cpx #2
     EC22   EA EA        1519   	.byte   $ea,$ea        ; bne notkat ;branch if not
     EC24   EA EA EA     1520   	.byte    $ea,$ea,$ea    ; cpx lstshf ;did i do this last time?
     EC27   EA EA        1521   	.byte    $ea,$ea        ; beq shfout ;branch if so
     EC29   EA EA EA     1522   	.byte    $ea,$ea,$ea    ; lda mode ;else ...
     EC2C   EA EA        1523   	.byte    $ea,$ea        ; eor #$18 ;switch kata-extended
     EC2E   EA EA EA     1524   	.byte    $ea,$ea,$ea    ; sta mode
     EC31   EA EA        1525   	.byte    $ea,$ea        ; bpl shfout
     EC33                1526   notkat
     EC33   EA EA EA     1527   	.byte    $ea,$ea,$ea    ; ora mode ;add mode table offset
     EC36   EA EA        1528   	.byte    $ea,$ea        ; and #$7f ;clear

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 13-1
EDITOR.2   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     EC38   AA           1529           tax
     EC39   BD EC46      1530           lda  keycod,x
     EC3C   85 F5        1531           sta  keytab
     EC3E   BD EC47      1532           lda  keycod+1,x
     EC41   85 F6        1533           sta  keytab+1
     EC43                1534   shfout
     EC43   4C EB74      1535           jmp  rekey
                         1536   
                         1537   ;.end
                         1538   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 14
EDITOR.3   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         1540   	.subttl EDITOR.3
     EC46                1541   keycod          ; keyboard mode 'dispatch'
     EC46   EC5E         1542   	.word    mode1
     EC48   EC9F         1543   	.word    mode2
     EC4A   ECE0         1544   	.word    mode3
     EC4C   EDA3         1545   	.word    contrl         ; control keys
                         1546   ;
                         1547   ; cottaconna mode
                         1548   ;
     EC4E   EC5E         1549   	.word    mode1          ; pet mode1
     EC50   EC9F         1550   	.word    mode2          ; pet mode2
     EC52   ED69         1551   	.word    cctta3         ; dummy word
     EC54   EDA3         1552   	.word    contrl
                         1553   ;
                         1554   ; extended katakana mode
                         1555   ;
     EC56   ED21         1556   	.word   cctta2         ; katakana characters
     EC58   ED69         1557   	.word   cctta3         ; limited graphics
     EC5A   ED69         1558   	.word   cctta3         ; dummy
     EC5C   EDA3         1559   	.word   contrl
                                
                                
                                
                                
                                

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 15
EDITOR.3   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     EC5E                1562   mode1
                         1563   		;1,3,5,7,9,+,yen sign,del
     EC5E   31 33 35     1564   	.byte   $31,$33,$35,$37,$39,$2b,$5c,$14
     EC61   37 39 2B            
     EC64   5C 14               
                         1565   		;lft.arrow,w,r,y,i,p,*,return
     EC66   5F 57 52     1566   	.byte   $5f,$57,$52,$59,$49,$50,$2a,$0d
     EC69   59 49 50            
     EC6C   2A 0D               
                         1567   		;ctrl,a,d,g,j,l,;,rt crsr
     EC6E   04 41 44     1568   	.byte   $04,$41,$44,$47,$4a,$4c,$3b,$1d
     EC71   47 4A 4C            
     EC74   3B 1D               
                         1569   		;stop,l.shift,x,v,n,,,/,crsr dwn
     EC76   03 01 58     1570   	.byte   $03,1,$58,$56,$4e,$2c,$2f,$11
     EC79   56 4E 2C            
     EC7C   2F 11               
                         1571   		;space,z,c,b,m,.,r.shiftt,f1
     EC7E   20 5A 43     1572   	.byte   $20,$5a,$43,$42,$4d,$2e,1,$85
     EC81   42 4D 2E            
     EC84   01 85               
                         1573   		;co.key,s,f,h,k,:,=,f2
     EC86   02 53 46     1574   	.byte   $02,$53,$46,$48,$4b,$3a,$3d,$86
     EC89   48 4B 3A            
     EC8C   3D 86               
                         1575   		;q,e,t,u,o,@,exp,f3
     EC8E   51 45 54     1576   	.byte   $51,$45,$54,$55,$4f,$40,$5e,$87
     EC91   55 4F 40            
     EC94   5E 87               
                         1577   		;2,4,6,8,0,-,home,f4
     EC96   32 34 36     1578   	.byte   $32,$34,$36,$38,$30,$2d,$13,$88
     EC99   38 30 2D            
     EC9C   13 88               
     EC9E   FF           1579   	.byte   $ff    ; end of table null
                                
                                
                                
     EC9F                1581   mode2
                         1582   		; !,%,',),+,yen,ins
     EC9F   21 23 25     1583   	.byte   $21,$23,$25,$27,$29,$db,$a9,$94
     ECA2   27 29 DB            
     ECA5   A9 94               
                         1584   		;shifted lft.arrow,w,r,y,i,p,*,return
     ECA7   5F D7 D2     1585   	.byte   $5f,$d7,$d2,$d9,$c9,$d0,$c0,$8d
     ECAA   D9 C9 D0            
     ECAD   C0 8D               
                         1586   			;ctrl,a,d,g,j,l,;,lf.crsr
     ECAF   04 C1 C4     1587   	.byte   $04,$c1,$c4,$c7,$ca,$cc,$5d,$9d
     ECB2   C7 CA CC            
     ECB5   5D 9D               

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 15-1
EDITOR.3   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         1588   		;run,l.shift,x,v,n,,,/,crsr dwn
     ECB7   83 01 D8     1589   	.byte    $83,1,$d8,$d6,$ce,$3c,$3f,$91
     ECBA   D6 CE 3C            
     ECBD   3F 91               
                         1590   		;shifted space,z,c,b,m,.,r.shift,f5
     ECBF   A0 DA C3     1591   	.byte   $a0,$da,$c3,$c2,$cd,$3e,1,$89
     ECC2   C2 CD 3E            
     ECC5   01 89               
                         1592   		;shiftec co.key  ,s,f,h,k,:,=,f6
     ECC7   02 D3 C6     1593   	.byte   $02,$d3,$c6,$c8,$cb,$5b,$3d,$8a
     ECCA   C8 CB 5B            
     ECCD   3D 8A               
                         1594   		;shifted  g,e,t,u,o,@,pi,f7
     ECCF   D1 C5 D4     1595   	.byte   $d1,$c5,$d4,$d5,$cf,$ba,$de,$8b
     ECD2   D5 CF BA            
     ECD5   DE 8B               
                         1596   		;",$,&,(,
     ECD7   22 24 26     1597   	.byte   $22,$24,$26,$28,$30,$dd,$93,$8c
     ECDA   28 30 DD            
     ECDD   93 8C               
     ECDF   FF           1598   	.byte   $ff    ; end of table null
                         1599   
     ECE0                1600   mode3           ; left window grahpics
                         1601   		; 1,3,5,7,9,+,pound sign,ins
     ECE0   21 23 25     1602   	.byte   $21,$23,$25,$27,$29,$a6,$a8,$94
     ECE3   27 29 A6            
     ECE6   A8 94               
                         1603   		; lft.arrow,w,r,y,i,p,*,return
     ECE8   5F B3 B2     1604   	.byte   $5f,$b3,$b2,$b7,$a2,$af,$df,$8d
     ECEB   B7 A2 AF            
     ECEE   DF 8D               
                         1605   		; ctrl,a,d,g,j,l,;,lf.crsr
     ECF0   04 B0 AC     1606   	.byte   $04,$b0,$ac,$a5,$b5,$b6,$5d,$9d
     ECF3   A5 B5 B6            
     ECF6   5D 9D               
                         1607   		;  run,l.shift,x,v,n,,,/,crsr.up
     ECF8   83 01 BD     1608   	.byte   $83,$01,$bd,$be,$aa,$3c,$3f,$91
     ECFB   BE AA 3C            
     ECFE   3F 91               
                         1609   		; space,z,c,b,m,.,r.shift,f2
     ED00   A0 AD BC     1610   	.byte   $a0,$ad,$bc,$bf,$a7,$3e,$01,$89
     ED03   BF A7 3E            
     ED06   01 89               
                         1611   		; co.key,s,f,h,k,:,=,f4
     ED08   02 AE BB     1612   	.byte   $02,$ae,$bb,$b4,$a1,$5b,$3d,$8a
     ED0B   B4 A1 5B            
     ED0E   3D 8A               
                         1613   		; q,e,t,u,o,@,pi,f6
     ED10   AB B1 A3     1614   	.byte   $ab,$b1,$a3,$b8,$b9,$a4,$de,$8b
     ED13   B8 B9 A4            

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 15-2
EDITOR.3   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     ED16   DE 8B               
                         1615   		; ",$,&,(,0,-,home,f8
     ED18   22 24 26     1616   	.byte   $22,$24,$26,$28,$30,$dc,$93,$8c
     ED1B   28 30 DC            
     ED1E   93 8C               
     ED20   FF           1617   	.byte   $ff    ; end of table null
     ED21                1618   cctta2          ; was cctta2 in japanese version
     ED21                1619   lower
     ED21   C9 0E        1620           cmp  #$0e       ; does he want lower case?
     ED23   D0 0B        1621           bne  upper      ; branch if not
     ED25   A9 02        1622           lda  #2         ; else set vic to point to lower case
     ED27   0D 9005      1623           ora  vicreg+5
     ED2A   8D 9005      1624           sta  vicreg+5
     ED2D   4C E6DC      1625           jmp  loop2
                         1626   
     ED30                1627   upper
     ED30   C9 8E        1628           cmp  #$8e       ; does he want upper case
     ED32   D0 0B        1629           bne  lock       ; branch if not
     ED34   A9 FD        1630           lda  #$fd       ; make sure vic point to upper/pet set
     ED36   2D 9005      1631           and  vicreg+5
     ED39   8D 9005      1632           sta  vicreg+5
     ED3C   4C E6DC      1633   outhre  jmp  loop2
                         1634   
     ED3F                1635   lock
     ED3F   C9 08        1636           cmp  #8         ; does he want to lock in this mode?
     ED41   D0 0A        1637           bne  unlock     ; branch if not
     ED43   A9 80        1638           lda  #$80       ; else set lock switch on
     ED45   0D 0291      1639           ora  mode       ; don't hurt anything - just in case
     ED48   8D 0291      1640           sta  mode
     ED4B   30 EF        1641           bmi  outhre
                         1642   
     ED4D                1643   unlock
     ED4D   C9 09        1644           cmp  #9         ; does he want to unlock the keyboard?
     ED4F   D0 EB        1645           bne  outhre     ; branch if not
     ED51   A9 7F        1646           lda  #$7f       ; clear the lock switch
     ED53   2D 0291      1647           and  mode       ; dont hurt anything
     ED56   8D 0291      1648           sta  mode
     ED59   10 E1        1649           bpl  outhre     ; get out
                         1650   
     ED5B                1651   patchx
     ED5B   E8           1652           inx     ; index to next line
     ED5C   B5 D9        1653           lda  ldtb1,x    ; get high order byte of address
     ED5E   09 80        1654           ora  #$80       ; make it a non-continuation line
     ED60   95 D9        1655           sta  ldtb1,x    ; and put it back
     ED62   CA           1656           dex  get  back  to  curent  line
     ED63   A5 D5        1657           lda  lnmx       ; continue the bytes i took out
     ED65   18           1658           clc
     ED66   4C E715      1659           jmp  patout     ; and go back to the code we patched
                         1660   
     ED69                1661   cctta3

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 15-3
EDITOR.3   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

            =ED72        1662   	*=$ed72         ; remainder of cctta3 must start here
     ED72   04 FF FF     1663   	.byte   $04,$ff,$ff,$ff,$ff,$ff,$e2,$9d
     ED75   FF FF FF            
     ED78   E2 9D               
                         1664   		;run-k24-k31
     ED7A   83 01 FF     1665   	.byte   $83,$01,$ff,$ff,$ff,$ff,$ff,$91
     ED7D   FF FF FF            
     ED80   FF 91               
                         1666   		;k32-k39.f5
     ED82   A0 FF FF     1667   	.byte   $a0,$ff,$ff,$ff,$ff,$ee,$01,$89
     ED85   FF FF EE            
     ED88   01 89               
                         1668   		;co.key,k40-k47.f6
     ED8A   02 FF FF     1669   	.byte   $02,$ff,$ff,$ff,$ff,$e1,$fd,$8a
     ED8D   FF FF E1            
     ED90   FD 8A               
                         1670   		;k48-k55
     ED92   FF FF FF     1671   	.byte   $ff,$ff,$ff,$ff,$ff,$b0,$e0,$8b
     ED95   FF FF B0            
     ED98   E0 8B               
                         1672   		;k56-k63
     ED9A   F2 F4 F6     1673   	.byte   $f2,$f4,$f6,$ff,$f0,$ed,$93,$8c
     ED9D   FF F0 ED            
     EDA0   93 8C               
     EDA2   FF           1674   	.byte   $ff    ; end of table null
                         1675   
                         1676   
     EDA3                1677   contrl
                         1678   		;black,red,purple,blue,rvs ,null,null,null
     EDA3   90 1C 9C     1679   	.byte   $90,$1c,$9c,$1f,$12,$ff,$ff,$ff
     EDA6   1F 12 FF            
     EDA9   FF FF               
                         1680   		;null,null,reverse,null,null,null,null,null
     EDAB   FF FF 12     1681   	.byte   $ff,$ff,$12,$ff,$ff,$ff,$ff,$ff
     EDAE   FF FF FF            
     EDB1   FF FF               
                         1682   		; five lines of nulls
     EDB3   FF FF FF     1683   	.byte   $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff
     EDB6   FF FF FF            
     EDB9   FF FF               
     EDBB   FF FF FF     1684   	.byte   $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff
     EDBE   FF FF FF            
     EDC1   FF FF               
     EDC3   FF FF FF     1685   	.byte   $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff
     EDC6   FF FF FF            
     EDC9   FF FF               
     EDCB   FF FF FF     1686   	.byte   $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff
     EDCE   FF FF FF            
     EDD1   FF FF               
     EDD3   FF FF FF     1687   	.byte   $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 15-4
EDITOR.3   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     EDD6   FF FF FF            
     EDD9   FF FF               
                         1688   		;white,cyan,green,yellow,rvs off,null,null,null
     EDDB   05 9F 1E     1689   	.byte   $05,$9f,$1e,$9e,$92,$ff,$ff,$ff
     EDDE   9E 92 FF            
     EDE1   FF FF               
     EDE3   FF           1690   	.byte   $ff    ; end of table null
     EDE4                1691   tvic
     EDE4   05 19 16     1692   	.byte   $05,$19,$16,$2e,$0,$c0,$0,0
     EDE7   2E 00 C0            
     EDEA   00 00               
     EDEC   00 00 00     1693   	.byte   0,0,0,0,0,0,0,$1b
     EDEF   00 00 00            
     EDF2   00 1B               
                         1694   ;
     EDF4   4C 4F 41     1695   runtb    .byte  'LOAD',$D,'RUN',$D
     EDF7   44 0D 52            
     EDFA   55 4E 0D            
                         1696   ;
            =1000        1697   linz0    =  vicscn
            =1016        1698   linz1    =  linz0+llen
            =102C        1699   linz2    =  linz1+llen
            =1042        1700   linz3    =  linz2+llen
            =1058        1701   linz4    =  linz3+llen
            =106E        1702   linz5    =  linz4+llen
            =1084        1703   linz6    =  linz5+llen
            =109A        1704   linz7    =  linz6+llen
            =10B0        1705   linz8    =  linz7+llen
            =10C6        1706   linz9    =  linz8+llen
            =10DC        1707   linz10   =  linz9+llen
            =10F2        1708   linz11   =  linz10+llen
            =1108        1709   linz12   =  linz11+llen
            =111E        1710   linz13   =  linz12+llen
            =1134        1711   linz14   =  linz13+llen
            =114A        1712   linz15   =  linz14+llen
            =1160        1713   linz16   =  linz15+llen
            =1176        1714   linz17   =  linz16+llen
            =118C        1715   linz18   =  linz17+llen
            =11A2        1716   linz19   =  linz18+llen
            =11B8        1717   linz20   =  linz19+llen
            =11CE        1718   linz21   =  linz20+llen
            =11E4        1719   linz22   =  linz21+llen
                         1720   
                         1721   
                         1722   
                         1723   ;****** screen lines lo byte table ******
                         1724   
     EDFD                1725   ldtb2
     EDFD   00           1726   	.byte    <linz0
     EDFE   16           1727   	.byte    <linz1

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 15-5
EDITOR.3   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     EDFF   2C           1728   	.byte    <linz2
     EE00   42           1729   	.byte    <linz3
     EE01   58           1730   	.byte    <linz4
     EE02   6E           1731   	.byte    <linz5
     EE03   84           1732   	.byte    <linz6
     EE04   9A           1733   	.byte    <linz7
     EE05   B0           1734   	.byte    <linz8
     EE06   C6           1735   	.byte    <linz9
     EE07   DC           1736   	.byte    <linz10
     EE08   F2           1737   	.byte    <linz11
     EE09   08           1738   	.byte    <linz12
     EE0A   1E           1739   	.byte    <linz13
     EE0B   34           1740   	.byte    <linz14
     EE0C   4A           1741   	.byte    <linz15
     EE0D   60           1742   	.byte    <linz16
     EE0E   76           1743   	.byte    <linz17
     EE0F   8C           1744   	.byte    <linz18
     EE10   A2           1745   	.byte    <linz19
     EE11   B8           1746   	.byte    <linz20
     EE12   CE           1747   	.byte    <linz21
     EE13   E4           1748   	.byte    <linz22
                         1749   
                         1750   ; .end
                         1751   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 16
SERIAL   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         1753   	.subttl  SERIAL
                         1754   ;command serial bus device to talk
                         1755   ;
     EE14   09 40        1756   talk    ora  #$40       ; make a talk adr
     EE16   2C           1757   	.byte   $2c    ; skip two bytes
                                
                                
                                
                                
                                
                         1759   ;command serial bus device to listen
                         1760   ;
     EE17   09 20        1761   listn   ora  #$20       ; make a listen adr
     EE19   20 F160      1762           jsr  rsp232     ; protect self from rs232 nmi's
     EE1C   48           1763   list1   pha
                         1764   ;
                         1765   ;
     EE1D   24 94        1766           bit  c3p0       ; character left in buf?
     EE1F   10 0A        1767           bpl  list2      ; no...
                         1768   ;
                         1769   ;send buffered character
                         1770   ;
     EE21   38           1771           sec     ; set eoi flag
     EE22   66 A3        1772           ror  r2d2
                         1773   ;
     EE24   20 EE49      1774           jsr  isour      ; send last character
                         1775   ;
     EE27   46 94        1776           lsr  c3p0       ; buffer clear flag
     EE29   46 A3        1777           lsr  r2d2       ; clear eoi flag
                         1778   ;
                         1779   ;
     EE2B   68           1780   list2   pla     ; talk/listen address
     EE2C   85 95        1781           sta  bsour
     EE2E   20 E4A0      1782           jsr  datahi
     EE31   C9 3F        1783           cmp  #$3f       ; clkhi only on unlisten
     EE33   D0 03        1784           bne  list5
     EE35   20 EF84      1785           jsr  clkhi
                         1786   ;
     EE38   AD 911F      1787   list5   lda  d1ora      ; assert attention
     EE3B   09 80        1788           ora  #$80
     EE3D   8D 911F      1789           sta  d1ora
                         1790   ;
                                
                                
                                
                                
                                
     EE40                1792   isoura
     EE40   20 EF8D      1793           jsr  clklo      ; set clock line low
     EE43   20 E4A0      1794           jsr  datahi

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 16-1
SERIAL   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     EE46   20 EF96      1795           jsr  w1ms       ; delay 1 ms
                                
                                
                                
                                
                                
     EE49   78           1797   isour   sei     ; no irq's allowed
     EE4A   20 E4A0      1798           jsr  datahi     ; make sure data is released
     EE4D   20 E4B2      1799           jsr  debpia     ; data should be low
     EE50   4A           1800           lsr  a
     EE51   B0 61        1801           bcs  nodev
     EE53   20 EF84      1802           jsr  clkhi      ; clock line high
     EE56   24 A3        1803           bit  r2d2       ; eoi flag test
     EE58   10 0C        1804           bpl  noeoi
                         1805   ; do the eoi
     EE5A   20 E4B2      1806   isr02   jsr  debpia     ; wait for data to go high
     EE5D   4A           1807           lsr  a
     EE5E   90 FA        1808           bcc  isr02
                         1809   ;
     EE60   20 E4B2      1810   isr03   jsr  debpia     ; wait for data to go low
     EE63   4A           1811           lsr  a
     EE64   B0 FA        1812           bcs  isr03
                         1813   ;
     EE66   20 E4B2      1814   noeoi   jsr  debpia     ; wait for data high
     EE69   4A           1815           lsr  a
     EE6A   90 FA        1816           bcc  noeoi
     EE6C   20 EF8D      1817           jsr  clklo      ; set clock low
                         1818   ;
                         1819   ; set to send data
                         1820   ;
     EE6F   A9 08        1821           lda  #$08       ; count 8 bits
     EE71   85 A5        1822           sta  count
                         1823   ;
     EE73                1824   isr01
     EE73   AD 911F      1825           lda  d1ora      ; debounce the bus
     EE76   CD 911F      1826           cmp  d1ora
     EE79   D0 F8        1827           bne  isr01
     EE7B   4A           1828           lsr  a
     EE7C   4A           1829           lsr  a
     EE7D   90 38        1830           bcc  frmerr     ; data must be hi
                         1831   ;
     EE7F   66 95        1832           ror  bsour      ; next bit into carry
     EE81   B0 05        1833           bcs  isrhi
     EE83   20 E4A9      1834           jsr  datalo
     EE86   D0 03        1835           bne  isrclk
     EE88   20 E4A0      1836   isrhi   jsr  datahi
     EE8B   20 EF84      1837   isrclk  jsr  clkhi      ; clock hi
     EE8E   EA           1838           nop
     EE8F   EA           1839           nop
     EE90   EA           1840           nop

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 16-2
SERIAL   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     EE91   EA           1841           nop
     EE92   AD 912C      1842           lda  d2pcr
     EE95   29 DF        1843           and  #%11011111         ; data high
     EE97   09 02        1844           ora  #$02       ; clock low
     EE99   8D 912C      1845           sta  d2pcr
     EE9C   C6 A5        1846           dec  count
     EE9E   D0 D3        1847           bne  isr01
     EEA0   A9 04        1848           lda  #$04       ; set timer for 1ms
     EEA2   8D 9129      1849           sta  d2t2h
     EEA5   AD 912D      1850   isr04   lda  d2ifr
     EEA8   29 20        1851           and  #$20
     EEAA   D0 0B        1852           bne  frmerr
     EEAC   20 E4B2      1853           jsr  debpia
     EEAF   4A           1854           lsr  a
     EEB0   B0 F3        1855           bcs  isr04
     EEB2   58           1856           cli     ; let irq's continue
     EEB3   60           1857           rts
                         1858   ;
     EEB4                1859   nodev           ; device not present error
     EEB4   A9 80        1860           lda  #$80
     EEB6   2C           1861   	.byte   $2c
     EEB7                1862   frmerr          ; framing error
     EEB7   A9 03        1863           lda  #$03
     EEB9   20 FE6A      1864   csberr  jsr  udst       ; commodore serial buss error entry
     EEBC   58           1865           cli     ; irq's were off...turn on
     EEBD   18           1866           clc     ; make sure no kernal error returned
     EEBE   90 49        1867           bcc  dlabye     ; turn atn off ,release all lines
                         1868   ;
                                
                                
                                
                                
                                
                         1870   ;send secondary address after listen
                         1871   ;
     EEC0   85 95        1872   secnd   sta  bsour      ; buffer character
     EEC2   20 EE40      1873           jsr  isoura     ; send it
                                
                                
                                
                                
                                
                         1875   ;release attention after listen
                         1876   ;
     EEC5   AD 911F      1877   scatn   lda  d1ora
     EEC8   29 7F        1878           and  #$7f
     EECA   8D 911F      1879           sta  d1ora      ; release attention
     EECD   60           1880           rts
                                
                                

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 16-3
SERIAL   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                                
                                
                                
                         1882   ;talk second address
                         1883   ;
     EECE   85 95        1884   tksa    sta  bsour      ; buffer character
     EED0   20 EE40      1885           jsr  isoura     ; send second addr
                                
                                
                                
                                
                                
     EED3                1887   tkatn           ; shift over to listener
     EED3   78           1888           sei     ; no irq's here
     EED4   20 E4A9      1889           jsr  datalo     ; data line low
     EED7   20 EEC5      1890           jsr  scatn
     EEDA   20 EF84      1891           jsr  clkhi      ; clock line high jsr/rts
     EEDD   20 E4B2      1892   tkatn1  jsr  debpia     ; wait for clock to go low
     EEE0   B0 FB        1893           bcs  tkatn1
     EEE2   58           1894           cli     ; irq's okay now
     EEE3   60           1895           rts
                                
                                
                                
                                
                                
                         1897   ;buffered output to serial bus
                         1898   ;
     EEE4   24 94        1899   ciout   bit  c3p0       ; buffered char?
     EEE6   30 05        1900           bmi  ci2        ; yes...send last
                         1901   ;
     EEE8   38           1902           sec     ; no...
     EEE9   66 94        1903           ror  c3p0       ; set buffered char flag
     EEEB   D0 05        1904           bne  ci4        ; branch always
                         1905   ;
     EEED   48           1906   ci2     pha     ; save current char
     EEEE   20 EE49      1907           jsr  isour      ; send last char
     EEF1   68           1908           pla     ; restore current char
     EEF2   85 95        1909   ci4     sta  bsour      ; buffer current char
     EEF4   18           1910           clc     ; carry-good exit
     EEF5   60           1911           rts
                                
                                
                                
                                
                                
                         1913   ;send untalk command on serial bus
                         1914   ;
     EEF6   20 EF8D      1915   untlk   jsr  clklo
     EEF9   AD 911F      1916           lda  d1ora      ; pull atn

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 16-4
SERIAL   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     EEFC   09 80        1917           ora  #$80
     EEFE   8D 911F      1918           sta  d1ora
     EF01   A9 5F        1919           lda  #$5f       ; untalk command
     EF03   2C           1920   	.byte   $2c    ; skip two bytes
                                
                                
                                
                                
                                
                         1922   ;send unlisten command on serial bus
                         1923   ;
     EF04   A9 3F        1924   unlsn   lda  #$3f       ; unlisten command
     EF06   20 EE1C      1925           jsr  list1      ; send it
                         1926   ;
                         1927   ; release all lines
     EF09   20 EEC5      1928   dlabye  jsr  scatn      ; always release atn
                         1929   ; delay then release clock and data
                         1930   ;
     EF0C   8A           1931   dladlh  txa     ; delay approx 60 us
     EF0D   A2 0B        1932           ldx  #11
     EF0F   CA           1933   dlad00  dex
     EF10   D0 FD        1934           bne  dlad00
     EF12   AA           1935           tax
     EF13   20 EF84      1936           jsr  clkhi
     EF16   4C E4A0      1937           jmp  datahi
                                
                                
                                
                                
                                
                         1939   ;input a byte from serial bus
                         1940   ;
     EF19                1941   acptr
     EF19   78           1942           sei     ; no irq allowed
     EF1A   A9 00        1943           lda  #$00       ; set eoi/error flag
     EF1C   85 A5        1944           sta  count
     EF1E   20 EF84      1945           jsr  clkhi      ; make sure clock line is released
     EF21   20 E4B2      1946   acp00a  jsr  debpia     ; wait for clock high
     EF24   90 FB        1947           bcc  acp00a
     EF26   20 E4A0      1948           jsr  datahi     ; data line high
                         1949   ;
     EF29   A9 01        1950   eoiacp  lda  #$01       ; set timer 2 for 256us
     EF2B   8D 9129      1951           sta  d2t2h
     EF2E   AD 912D      1952   acp00   lda  d2ifr
     EF31   29 20        1953           and  #$20       ; check the timer
     EF33   D0 07        1954           bne  acp00b     ; ran out.....
     EF35   20 E4B2      1955           jsr  debpia     ; check the clock line
     EF38   B0 F4        1956           bcs  acp00      ; no not yet
     EF3A   90 18        1957           bcc  acp01      ; yes.....
                         1958   ;

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 16-5
SERIAL   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     EF3C   A5 A5        1959   acp00b  lda  count      ; check for error (twice thru timeouts)
     EF3E   F0 05        1960           beq  acp00c
     EF40   A9 02        1961           lda  #2
     EF42   4C EEB9      1962           jmp  csberr     ;  st = 2 read timeout
                         1963   ;
                         1964   ; timer ran out do an eoi thing
                         1965   ;
     EF45   20 E4A9      1966   acp00c  jsr  datalo     ; data line low
     EF48   20 EF0C      1967           jsr  dladlh     ; delay and then set datahi (also clkhi)
     EF4B   A9 40        1968           lda  #$40
     EF4D   20 FE6A      1969           jsr  udst       ; or an eoi bit into status
     EF50   E6 A5        1970           inc  count      ; go around again for error check on eoi
     EF52   D0 D5        1971           bne  eoiacp
                         1972   ;
                         1973   ; do the byte transfer
                         1974   ;
     EF54   A9 08        1975   acp01   lda  #08        ; set up counter
     EF56   85 A5        1976           sta  count
                         1977   ;
     EF58   AD 911F      1978   acp03   lda  d1ora      ; wait for clock high
     EF5B   CD 911F      1979           cmp  d1ora      ; debounce
     EF5E   D0 F8        1980           bne  acp03
     EF60   4A           1981           lsr  a
     EF61   90 F5        1982           bcc  acp03
     EF63   4A           1983           lsr  a          ; put data bit into carry
     EF64   66 A4        1984           ror  bsour1     ; rotate data in
                         1985   ;
     EF66   AD 911F      1986   acp03a  lda  d1ora      ; wait for clock low
     EF69   CD 911F      1987           cmp  d1ora      ; debounce
     EF6C   D0 F8        1988           bne  acp03a
     EF6E   4A           1989           lsr  a
     EF6F   B0 F5        1990           bcs  acp03a
     EF71   C6 A5        1991           dec  count
     EF73   D0 E3        1992           bne  acp03      ; more bits.....
                         1993   ;...exit...
     EF75   20 E4A9      1994           jsr  datalo     ; data low
     EF78   A5 90        1995           lda  status     ; check for eoi
     EF7A   F0 03        1996           beq  acp04      ; none...
                         1997   ;
     EF7C   20 EF0C      1998           jsr  dladlh     ; delay then set data high
                         1999   ;
     EF7F   A5 A4        2000   acp04   lda  bsour1
     EF81   58           2001           cli     ; irq is ok
     EF82   18           2002           clc     ; good exit
     EF83   60           2003           rts
                         2004   ;
     EF84                2005   clkhi           ; set clock line high (inverted)
     EF84   AD 912C      2006           lda  d2pcr
     EF87   29 FD        2007           and  #%11111101
     EF89   8D 912C      2008           sta  d2pcr

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 16-6
SERIAL   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     EF8C   60           2009           rts
                         2010   ;
     EF8D                2011   clklo           ; set clock line low  (inverted)
     EF8D   AD 912C      2012           lda  d2pcr
     EF90   09 02        2013           ora  #$02
     EF92   8D 912C      2014           sta  d2pcr
     EF95   60           2015           rts
                         2016   
            =EF96        2017   around	= *
                         2018   
                         2019   ;
                         2020   ; moved because of needed patch space
                         2021   ;
                         2022   
            =E4A0        2023   	* = $e4a0          ; patch area
                         2024   
     E4A0                2025   datahi          ; set data line high (inverted)
     E4A0   AD 912C      2026           lda  d2pcr
     E4A3   29 DF        2027           and  #%11011111
     E4A5   8D 912C      2028           sta  d2pcr
     E4A8   60           2029           rts
                         2030   ;
     E4A9                2031   datalo          ; set data line low  (inverted)
     E4A9   AD 912C      2032           lda  d2pcr
     E4AC   09 20        2033           ora  #$20
     E4AE   8D 912C      2034           sta  d2pcr
     E4B1   60           2035           rts
                         2036   ;
     E4B2   AD 911F      2037   debpia  lda  d1ora      ; debpunce the pia
     E4B5   CD 911F      2038           cmp  d1ora
     E4B8   D0 F8        2039           bne  debpia
     E4BA   4A           2040           lsr  a          ; shift the clock bit into the carry
     E4BB   60           2041           rts
                         2042   
            =E4BC        2043   ksp2	= *     ; kernal space for patch 2
                         2044   
            =EF96        2045   	* = around
                         2046   
     EF96                2047   w1ms            ; delay 1ms using timer 2
     EF96   A9 04        2048           lda  #$04
     EF98   8D 9129      2049           sta  d2t2h
     EF9B                2050   w1ms1           ; timer wait loop
     EF9B   AD 912D      2051           lda  d2ifr
     EF9E   29 20        2052           and  #$20
     EFA0   F0 F9        2053           beq  w1ms1
     EFA2   60           2054           rts
                         2055   
                         2056   ;.end
                         2057   ;*******************************
                         2058   ;written 8/11/80 bob fairbairn

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 16-7
SERIAL   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         2059   ;test serial0.6 8/12/80  rjf
                         2060   ;change i/o structure 8/21/80 rjf
                         2061   ;more i/o changes 8/24/80 rjf
                         2062   ;final release into kernal 8/26/80 rjf
                         2063   ;some clean up 9/8/80 rsr
                         2064   ;add irq protect on isour and tkatn 9/22/80 rsr
                         2065   ;fix untalk 10/7/80 rsr
                         2066   ;******************************
                         2067   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 17
RS232TRANS   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         2069   	.subttl  RS232TRANS
                         2070   ; rstrab - entry for nmi continue routine
                         2071   ; rstbgn - entry for start transmitter
                         2072   ;
                         2073   ;   rsr - 8/18/80
                         2074   ;
                         2075   ; variables used
                         2076   ;   bitts - # of bits to be sent (<>0 not done)
                         2077   ;   nxtbit - byte contains next bit to be sent
                         2078   ;   roprty - byte contains parity bit calculated
                         2079   ;   rodata - stores data byte currently being transmitted
                         2080   ;   rodbs - output buffer index start
                         2081   ;   rodbe - output buffer index end
                         2082   ;   if rodbs=rodbe then buffer empty
                         2083   ;   robuf - indirect pointer to data buffer
                         2084   ;   rsstat - rs-232 status byte
                         2085   ;
                         2086   ;   xxx us - normal bit path
                         2087   ;   xxx us - worst case parity bit path
                         2088   ;   xxx us - stop bit path
                         2089   ;   xxx us - start bit path
                         2090   ;
     EFA3   A5 B4        2091   rstrab  lda  bitts      ; check for place in byte...
     EFA5   F0 47        2092           beq  rstbgn     ; ...done, =0 start next
                         2093   ;
     EFA7   30 3F        2094           bmi  rst050     ; ...doing stop bits
                         2095   ;
     EFA9   46 B6        2096           lsr  rodata     ; shift data into carry
     EFAB   A2 00        2097           ldx  #00        ; prepare for a zero
     EFAD   90 01        2098           bcc  rst005     ; yes...a zero
     EFAF   CA           2099           dex     ; no...make an $ff
     EFB0   8A           2100   rst005  txa     ; ready to send
                         2101   ;
     EFB1   45 BD        2102           eor  roprty     ; calc into parity
     EFB3   85 BD        2103           sta  roprty
                         2104   ;
     EFB5   C6 B4        2105           dec  bitts      ; bit count down
     EFB7   F0 06        2106           beq  rst010     ; want a parity instead
                         2107   ;
     EFB9   8A           2108   rstext  txa     ; calc bit whole to send
     EFBA   29 20        2109           and  #$20       ; goes out cb2
     EFBC   85 B5        2110           sta  nxtbit
     EFBE   60           2111           rts
                         2112   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 18
RS232TRANS   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         2114   ; calculate parity
                         2115   ;  nxtbit =0 upon entry
                         2116   ;
     EFBF   A9 20        2117   rst010  lda  #$20       ; check 6551 reg bits
     EFC1   2C 0294      2118           bit  m51cdr
     EFC4   F0 14        2119           beq  rspno      ; ...no parity, send a stop
     EFC6   30 1C        2120           bmi  rst040     ; ...not real parity
     EFC8   70 14        2121           bvs  rst030     ; ...even parity
                         2122   ;
     EFCA   A5 BD        2123           lda  roprty     ; calc odd parity
     EFCC   D0 01        2124           bne  rspext     ; correct guess
                         2125   ;
     EFCE   CA           2126   rswext  dex     ; wrong guess...its a one
                         2127   ;
     EFCF   C6 B4        2128   rspext  dec  bitts      ; one stop bit always
     EFD1   AD 0293      2129           lda  m51ctr     ; check # of stop bits
     EFD4   10 E3        2130           bpl  rstext     ; ...one
     EFD6   C6 B4        2131           dec  bitts      ; ...two
     EFD8   D0 DF        2132           bne  rstext     ; jump
                         2133   ;
     EFDA                2134   rspno           ; line to send cannot be pb0
     EFDA   E6 B4        2135           inc  bitts      ; counts as one stop bit
     EFDC   D0 F0        2136           bne  rswext     ; jump to flip to one
                         2137   ;
     EFDE   A5 BD        2138   rst030  lda  roprty     ; even parity
     EFE0   F0 ED        2139           beq  rspext     ; correct guess...exit
     EFE2   D0 EA        2140           bne  rswext     ; wrong...flip and exit
                         2141   ;
     EFE4   70 E9        2142   rst040  bvs  rspext     ; wanted space
     EFE6   50 E6        2143           bvc  rswext     ;  wanted mark
                                
                                
                                
                         2145   ; stop bits
                         2146   ;
     EFE8   E6 B4        2147   rst050  inc  bitts      ; stop bit count towards zero
     EFEA   A2 FF        2148           ldx  #$ff       ; send stop bit
     EFEC   D0 CB        2149           bne  rstext     ; jump to exit
                         2150   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 19
RS232TRANS   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         2152   ; rstbgn - entry to start byte trans
                         2153   ;
     EFEE   AD 0294      2154   rstbgn  lda  m51cdr     ; check for 3/x line
     EFF1   4A           2155           lsr  a
     EFF2   90 07        2156           bcc  rst060     ; 3 line...no check
     EFF4   2C 9120      2157           bit  d2orb      ; check for...
     EFF7   10 1D        2158           bpl  dsrerr     ; ...dsr error
     EFF9   50 1E        2159           bvc  ctserr     ; ...cts error
                         2160   ;
                         2161   ; set up to send next byte
                         2162   ;
     EFFB   A9 00        2163   rst060  lda  #0
     EFFD   85 BD        2164           sta  roprty     ; zero parity
     EFFF   85 B5        2165           sta  nxtbit     ; send start bit
     F001   AE 0298      2166           ldx  bitnum     ; get # of bits
     F004   86 B4        2167   rst070  stx  bitts      ; bitts=#of bitts+1
                         2168   ;
     F006   AC 029D      2169   rst080  ldy  rodbs      ; check buffer pointers
     F009   CC 029E      2170           cpy  rodbe
     F00C   F0 13        2171           beq  rsodne     ; all done...
                         2172   ;
     F00E   B1 F9        2173           lda  (robuf),y          ; get data...
     F010   85 B6        2174           sta  rodata     ; ...into byte buffer
     F012   EE 029D      2175           inc  rodbs      ; move pointer to next
     F015   60           2176           rts
                                
                                
                                
                         2178   ; set errors
                         2179   ;
     F016   A9 40        2180   dsrerr  lda  #$40       ; dsr gone error
     F018   2C           2181   	.byte    $2c
     F019   A9 10        2182   ctserr  lda  #$10       ; cts gone error
     F01B   0D 0297      2183           ora  rsstat
     F01E   8D 0297      2184           sta  rsstat
                         2185   ;
                         2186   ; errors turn off t1
                         2187   ;
     F021   A9 40        2188   rsodne  lda  #$40       ; kill t1 nmi
     F023   8D 911E      2189           sta  d1ier
     F026   60           2190           rts
                                
                                
                                
                         2192   ; bitcnt - cal # of bits to be sent
                         2193   ;   returns #of bits+1
                         2194   ;
     F027   A2 09        2195   bitcnt  ldx  #9         ; calc word length
     F029   A9 20        2196           lda  #$20
     F02B   2C 0293      2197           bit  m51ctr

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 19-1
RS232TRANS   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     F02E   F0 01        2198           beq  bit010
     F030   CA           2199           dex     ; bit 5 high is a 7 or 5
     F031   50 02        2200   bit010  bvc  bit020
     F033   CA           2201           dex     ; bit 6 high is a 6 or 5
     F034   CA           2202           dex
     F035   60           2203   bit020  rts
                         2204   
                         2205   ;.end
                         2206   ; rsr 8/24/80 correct some mistakes
                         2207   ; rsr 8/27/80 change bitnum base to #bits+1
                         2208   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 20
RS232RCVR   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         2210   	.subttl RS232RCVR
                         2211   ; rsrcvr - nmi routine to collect
                         2212   ;  data into bytes
                         2213   ;
                         2214   ; rsr 8/18/80
                         2215   ;
                         2216   ; variables used
                         2217   ;   inbit - input bit value
                         2218   ;   bitci - bit count in
                         2219   ;   rinone - flag for start bit check <>0 start bit
                         2220   ;   ridata - byte input buffer
                         2221   ;   riprty - holds byte input parity
                         2222   ;   ribuf - indirect pointer to data buffer
                         2223   ;   ridbe - input buffer index to end
                         2224   ;   ridbs - input buffer pointer to start
                         2225   ;   if ridbe=ridbs then input buffer empty
                         2226   ;
     F036   A6 A9        2227   rsrcvr  ldx  rinone     ; check for start bit
     F038   D0 2E        2228           bne  rsrtrt     ; was start bit
                         2229   ;
     F03A   C6 A8        2230           dec  bitci      ; check where we are in input...
     F03C   F0 31        2231           beq  rsr030     ; have a full byte
     F03E   30 0D        2232           bmi  rsr020     ; getting stop bits
                         2233   ;
                         2234   ; calc parity
                         2235   ;
     F040   A5 A7        2236           lda  inbit      ; get data up
     F042   45 AB        2237           eor  riprty     ; calc new parity
     F044   85 AB        2238           sta  riprty
                         2239   ;
                         2240   ; shift data bit in
                         2241   ;
     F046   46 A7        2242           lsr  inbit      ; in bit pos 0
     F048   66 AA        2243           ror  ridata     ; c into data
                         2244   ;
                         2245   ; exit
                         2246   ;
     F04A   60           2247   rsrext  rts
                         2248   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 21
RS232RCVR   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         2250   ; have stop bit, so store in buffer
                         2251   ;
     F04B   C6 A8        2252   rsr018  dec  bitci      ; no parity, dec so check works
     F04D   A5 A7        2253   rsr020  lda  inbit      ; get data...
     F04F   F0 62        2254           beq  rsr060     ; ...zero, an error?
                         2255   ;
     F051   AD 0293      2256           lda  m51ctr     ; check for correct # of stop bits
     F054   0A           2257           asl  a          ; carry tell how may stop bits
     F055   A9 01        2258           lda  #01
     F057   65 A8        2259           adc  bitci
     F059   D0 EF        2260           bne  rsrext     ; no..exit
                         2261   ;
                         2262   ; rsrabl - enable to recieve a byte
                         2263   ;
     F05B   A9 90        2264   rsrabl  lda  #$90       ; enable cb1 for next byte
     F05D   8D 911E      2265           sta  d1ier
     F060   85 A9        2266           sta  rinone     ; flag for start bit
                         2267   ;
     F062   A9 20        2268   rsrsxt  lda  #$20       ; disable t2
     F064   8D 911E      2269           sta  d1ier
     F067   60           2270           rts
                                
                                
                         2272   ; reciever start bit check
                         2273   ;
     F068   A5 A7        2274   rsrtrt  lda  inbit      ; check if space
     F06A   D0 EF        2275           bne  rsrabl     ; bad...try again
     F06C   85 A9        2276           sta  rinone     ; good...disable flag
     F06E   60           2277           rts     ; and exit
                                
                                
                                
                                
                         2279   ;
                         2280   ; put data in buffer (at parity time)
                         2281   ;
     F06F   AC 029B      2282   rsr030  ldy  ridbe      ; get end
     F072   C8           2283           iny
     F073   CC 029C      2284           cpy  ridbs      ; have we passed start?
     F076   F0 2A        2285           beq  recerr     ; yes...error
                         2286   ;
     F078   8C 029B      2287           sty  ridbe      ; move ridbe foward
     F07B   88           2288           dey
                         2289   ;
     F07C   A5 AA        2290           lda  ridata     ; get byte buffer up
     F07E   AE 0298      2291           ldx  bitnum     ; shift untill full byte
     F081   E0 09        2292   rsr031  cpx  #9         ; always 8 bits
     F083   F0 04        2293           beq  rsr032
     F085   4A           2294           lsr  a          ; fill with zeros
     F086   E8           2295           inx

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 21-1
RS232RCVR   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     F087   D0 F8        2296           bne  rsr031
                         2297   ;
     F089   91 F7        2298   rsr032  sta  (ribuf),y          ; data to page buffer
                         2299   ;
                         2300   ; parity checking
                         2301   ;
     F08B   A9 20        2302           lda  #$20       ; check 6551 command register
     F08D   2C 0294      2303           bit  m51cdr
     F090   F0 B9        2304           beq  rsr018     ; no parity bit so stop bit
     F092   30 B6        2305           bmi  rsrext     ; no parity check
                         2306   ;
                         2307   ; check calc parity
                         2308   ;
     F094   A5 A7        2309           lda  inbit
     F096   45 AB        2310           eor  riprty     ; put in with parity
     F098   F0 03        2311           beq  rsr050     ; even parity
     F09A   70 AE        2312           bvs  rsrext     ; odd...okay so exit
     F09C   2C           2313   	.byte    $2c    ; skip two
     F09D   50 AB        2314   rsr050  bvc  rsrext     ; even...okay so exit
                         2315   ;
                         2316   ; errors reported
     F09F   A9 01        2317           lda  #1         ; parity error
     F0A1   2C           2318   	.byte    $2c
     F0A2   A9 04        2319   recerr  lda  #$4        ; reciever overrun
     F0A4   2C           2320   	.byte   $2c
     F0A5   A9 80        2321   breake  lda  #$80       ; break detected
     F0A7   2C           2322   	.byte    $2c
     F0A8   A9 02        2323   framee  lda  #$02       ; frame error
     F0AA   0D 0297      2324   err232  ora  rsstat
     F0AD   8D 0297      2325           sta  rsstat
     F0B0   4C F05B      2326           jmp  rsrabl     ; bad exit so hang ##????????##
                         2327   ;
                         2328   ; check for errors
                         2329   ;
     F0B3   A5 AA        2330   rsr060  lda  ridata     ; expecting stop...
     F0B5   D0 F1        2331           bne  framee     ; frame error
     F0B7   F0 EC        2332           beq  breake     ; could be a break
                         2333   ;
                         2334   ; rs232 load and save
                         2335   ;
     F0B9   4C F796      2336   rs232   jmp  error9     ; bad device number
                         2337   
                         2338   ;.end
                         2339   ; rsr - 8/21/80 add mods
                         2340   ; rsr - 8/24/80 fix errors
                         2341   ; rsr - 8/27/80 fix major errors
                         2342   ; rsr - 8/30-80 fix t2 adjust
                         2343   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 22
RS232INOUT   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         2345   	.SUBTTL RS232INOUT
                         2346   ; output a file over usr port
                         2347   ;  using rs232
                         2348   ;
     F0BC   85 9A        2349   cko232  sta  dflto      ; set default out ###temp code###
     F0BE   AD 0294      2350           lda  m51cdr     ; check for 3/x line
     F0C1   4A           2351           lsr  a
     F0C2   90 27        2352           bcc  cko100     ; 3line...no turn around
                         2353   ;
                         2354   ;*turn around logic
                         2355   ;
                         2356   ; check for dsr and rts
                         2357   ;
     F0C4   A9 02        2358           lda  #$02       ; bit rts is on
     F0C6   2C 9110      2359           bit  d1orb
     F0C9   10 1D        2360           bpl  ckdsrx     ; no dsr...error
     F0CB   D0 1E        2361           bne  cko100     ; rts...outputing or full duplex
                         2362   ;
                         2363   ; check for active input
                         2364   ;  rts will be low if currently inputing
                         2365   ;
     F0CD   AD 911E      2366   cko020  lda  d1ier
     F0D0   29 30        2367           and  #$30       ; look at ier for t2 or cb1
     F0D2   D0 F9        2368           bne  cko020     ; hang untill input done
                         2369   ;
                         2370   ; wait for cts to be off as spec reqs
                         2371   ;
     F0D4   2C 9110      2372   cko030  bit  d1orb
     F0D7   70 FB        2373           bvs  cko030
                         2374   ;
                         2375   ; turn on rts
                         2376   ;
     F0D9   AD 9110      2377           lda  d1orb
     F0DC   09 02        2378           ora  #$02
     F0DE   8D 9110      2379           sta  d1orb
                         2380   ;
                         2381   ; wait for cts to go on
                         2382   ;
     F0E1   2C 9110      2383   cko040  bit  d1orb
     F0E4   70 05        2384           bvs  cko100     ; done...
     F0E6   30 F9        2385           bmi  cko040     ; we still have dsr
                         2386   ;
     F0E8   20 F016      2387   ckdsrx  jsr  dsrerr     ; a data set ready error
                         2388   ;
     F0EB   18           2389   cko100  clc     ; no error
     F0EC   60           2390           rts
                         2391   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 23
RS232INOUT   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         2393   ; bso232 - output a char rs232
                         2394   ;
                         2395   ; buffer handler
                         2396   ;
     F0ED   AC 029E      2397   bso232  ldy  rodbe
     F0F0   C8           2398           iny
     F0F1   CC 029D      2399           cpy  rodbs      ; check for buffer full
     F0F4   F0 F7        2400           beq  bso232     ; hang if so...(may need timeout?)
     F0F6   8C 029E      2401           sty  rodbe      ; indicate new start
     F0F9   88           2402           dey
     F0FA   91 F9        2403           sta  (robuf),y          ; store data
                         2404   ;
                         2405   ; set up if necessary to output
                         2406   ;
     F0FC   2C 911E      2407   bso100  bit  d1ier      ; check for a t1 nmi enable
     F0FF   50 01        2408           bvc  bso110     ; none so set up timer
     F101   60           2409           rts     ; else return
                         2410   ;
                         2411   ; set up for a first byte out
                         2412   ;
     F102   AD 0299      2413   bso110  lda  baudof     ; set up timer1
     F105   8D 9114      2414           sta  d1t1l
     F108   AD 029A      2415           lda  baudof+1
     F10B   8D 9115      2416           sta  d1t1h
                         2417   ;
                         2418   ; set up t1 nmi's
                         2419   ;
     F10E   A9 C0        2420           lda  #$c0
     F110   8D 911E      2421           sta  d1ier
                         2422   ;
     F113   4C EFEE      2423           jmp  rstbgn     ; begin transfer
                         2424   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 24
RS232INOUT   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         2426   ; input a file over user port
                         2427   ;  using rs232
                         2428   ;
     F116   85 99        2429   cki232  sta  dfltn      ; set default input
                         2430   ;
     F118   AD 0294      2431           lda  m51cdr     ; check for 3/x line
     F11B   4A           2432           lsr  a
     F11C   90 28        2433           bcc  cki100     ; 3 line...no handshake
                         2434   ;
     F11E   29 08        2435           and  #$08       ; full/half check (byte shifted above)
     F120   F0 24        2436           beq  cki100     ; full...no handshake
                         2437   ;
                         2438   ;*turn around logic
                         2439   ;
                         2440   ; check if dsr and not rts
                         2441   ;
     F122   A9 02        2442           lda  #$02       ; bit rts is on
     F124   2C 9110      2443           bit  d1orb
     F127   10 BF        2444           bpl  ckdsrx     ; no dsr...error
     F129   F0 19        2445           beq  cki090     ; rts low...in correct mode
                         2446   ;
                         2447   ; wait for active output to be done
                         2448   ;
     F12B   2C 911E      2449   cki010  bit  d1ier
     F12E   70 FB        2450           bvs  cki010
                         2451   ;
                         2452   ; turn off rts
                         2453   ;
     F130   AD 9110      2454           lda  d1orb
     F133   29 FD        2455           and  #$ff-02
     F135   8D 9110      2456           sta  d1orb
                         2457   ;
                         2458   ; wait for dcd to go high (in spec)
                         2459   ;
     F138   AD 9110      2460   cki020  lda  d1orb
     F13B   29 04        2461           and  #$04
     F13D   F0 F9        2462           beq  cki020
                         2463   ;
                         2464   ; enable cb1 for rs232 input
                         2465   ;
     F13F   A9 90        2466   cki080  lda  #$90
     F141   8D 911E      2467           sta  d1ier
     F144   18           2468   cki090  clc     ; no error
     F145   60           2469           rts
                         2470   ;
                         2471   ; if not 3 line half then...
                         2472   ;  see if we need to turn on cb1
                         2473   ;
     F146   AD 911E      2474   cki100  lda  d1ier      ; check for cb1 or t2 active
     F149   29 30        2475           and  #$30

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 24-1
RS232INOUT   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     F14B   F0 F2        2476           beq  cki080     ; no need to turn on
     F14D   18           2477           clc     ; no error
     F14E   60           2478           rts
                         2479   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 25
RS232INOUT   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         2481   ; bsi232 - input a char rs232
                         2482   ;
                         2483   ; buffer handler
                         2484   ;
     F14F   AC 029C      2485   bsi232  ldy  ridbs      ; get last byte address
     F152   CC 029B      2486           cpy  ridbe      ; see if buffer empty
     F155   F0 06        2487           beq  bsi010     ; return a null if no char
                         2488   ;
     F157   B1 F7        2489           lda  (ribuf),y          ; get last char
     F159   EE 029C      2490           inc  ridbs      ; inc to next pos
                         2491   ;
                         2492   ; receiver always runs
                         2493   ;
     F15C   60           2494           rts
                         2495   
     F15D   A9 00        2496   bsi010  lda  #$0        ; return a null
     F15F   60           2497           rts
                                
                                
                                
                                
                         2499   ; rsp232 - protect serial/cass from rs232 nmi's
                         2500   ;
     F160   48           2501   rsp232  pha     ; save .a
     F161   AD 911E      2502           lda  d1ier      ; does rs232 have any enables?
     F164   F0 0C        2503           beq  rspok      ; no...
     F166   AD 911E      2504   rspoff  lda  d1ier      ; wait untill done
     F169   29 60        2505           and  #%01100000         ;  with t1 & t2
     F16B   D0 F9        2506           bne  rspoff
     F16D   A9 10        2507           lda  #%00010000         ;  disable cb1 (need to renable in user code)
     F16F   8D 911E      2508           sta  d1ier
     F172   68           2509   rspok   pla     ; all done
     F173   60           2510           rts
                         2511   
                         2512   ;.end
                         2513   ; rsr 8/24/80 original code out
                         2514   ; rsr 8/25/80 original code in
                         2515   ; rsr 9/22/80 remove parallel refs & fix xline logic
                         2516   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 26
MESSAGES   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         2518   	.subttl MESSAGES
     F174   0D 49 2F     2519   MS1      .BYTE  $D,'I/O ERROR ',$A3
     F177   4F 20 45            
     F17A   52 52 4F            
     F17D   52 20 A3            
     F180   0D 53 45     2520   MS5      .BYTE  $D,'SEARCHING',$A0
     F183   41 52 43            
     F186   48 49 4E            
     F189   47 A0               
     F18B   46 4F 52     2521   MS6      .BYTE  'FOR',$A0
     F18E   A0                  
     F18F   0D 50 52     2522   MS7      .BYTE  $D,'PRESS PLAY ON TAP',$C5
     F192   45 53 53            
     F195   20 50 4C            
     F198   41 59 20            
     F19B   4F 4E 20            
     F19E   54 41 50            
     F1A1   C5                  
     F1A2   50 52 45     2523   MS8      .BYTE  'PRESS RECORD & PLAY ON TAP',$C5
     F1A5   53 53 20            
     F1A8   52 45 43            
     F1AB   4F 52 44            
     F1AE   20 26 20            
     F1B1   50 4C 41            
     F1B4   59 20 4F            
     F1B7   4E 20 54            
     F1BA   41 50 C5            
     F1BD   0D 4C 4F     2524   MS10     .BYTE  $D,'LOADIN',$C7
     F1C0   41 44 49            
     F1C3   4E C7               
     F1C5   0D 53 41     2525   MS11     .BYTE  $D,'SAVING',$A0
     F1C8   56 49 4E            
     F1CB   47 A0               
     F1CD   0D 56 45     2526   MS21     .BYTE  $D,'VERIFYIN',$C7
     F1D0   52 49 46            
     F1D3   59 49 4E            
     F1D6   C7                  
     F1D7   0D 46 4F     2527   MS17     .BYTE  $D,'FOUND',$A0
     F1DA   55 4E 44            
     F1DD   A0                  
     F1DE   0D 4F 4B     2528   MS18     .BYTE  $D,'OK',$8D
     F1E1   8D                  
                         2529   
                         2530   ; MS34 .BYTE $D,'MONITOR',$8D
                         2531   ; MS36 .BYTE $D,'BREA',$CB
                                
                                
                                
                                
                                

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 26-1
MESSAGES   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         2533   ;print message to screen only if
                         2534   ;output enabled
                         2535   ;
     F1E2   24 9D        2536   spmsg   bit  msgflg     ; printing messages?
     F1E4   10 0D        2537           bpl  msg10      ; no...
     F1E6   B9 F174      2538   msg     lda  ms1,y
     F1E9   08           2539           php
     F1EA   29 7F        2540           and  #$7f
     F1EC   20 FFD2      2541           jsr  bsout
     F1EF   C8           2542           iny
     F1F0   28           2543           plp
     F1F1   10 F3        2544           bpl  msg
     F1F3   18           2545   msg10   clc
     F1F4   60           2546           rts
                         2547   
                         2548   ;.end
                         2549   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 27
CHANNELIO   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         2551   	.SUBTTL CHANNELIO
                         2552   ;***************************************
                         2553   ;* getin -- get character from channel *
                         2554   ;*      channel is determined by dfltn.*
                         2555   ;* if device is 0, keyboard queue is   *
                         2556   ;* examined and a character removed if *
                         2557   ;* available.  if queue is empty, z    *
                         2558   ;* flag is returned set.  devices 1-31 *
                         2559   ;* advance to basin.                   *
                         2560   ;***************************************
                         2561   ;
     F1F5   A5 99        2562   ngetin  lda  dfltn      ; check device
     F1F7   D0 08        2563           bne  gn10       ; not keyboard
                         2564   ;
     F1F9   A5 C6        2565           lda  ndx        ; queue index
     F1FB   F0 6D        2566           beq  bn31       ; nobody there...exit
                         2567   ;
     F1FD   78           2568           sei
     F1FE   4C E5CF      2569           jmp  lp2        ; go remove a character
                         2570   ;
     F201   C9 02        2571   gn10    cmp  #2         ; is it rs-232
     F203   D0 18        2572           bne  bn10       ; no...use basin
                         2573   ;
     F205   84 97        2574   gn232   sty  xsav       ; save .y, used in rs232
     F207   20 F14F      2575           jsr  bsi232
     F20A   A4 97        2576           ldy  xsav       ; restore .y
     F20C   18           2577           clc     ; good return
     F20D   60           2578           rts
                                
                                
                                
                         2580   ;***************************************
                         2581   ;* basin-- input character from channel*
                         2582   ;*     input differs from get on device*
                         2583   ;* #0 function which is keyboard. the  *
                         2584   ;* screen editor makes ready an entire *
                         2585   ;* line which is passed char by char   *
                         2586   ;* up to the carriage return.  other   *
                         2587   ;* devices are:                        *
                         2588   ;*      0 -- keyboard                  *
                         2589   ;*      1 -- cassette #1               *
                         2590   ;*      2 -- rs232                     *
                         2591   ;*      3 -- screen                    *
                         2592   ;*   4-31 -- serial bus                *
                         2593   ;***************************************
                         2594   ;
     F20E   A5 99        2595   nbasin  lda  dfltn      ; check device
     F210   D0 0B        2596           bne  bn10       ; is not keyboard...
                         2597   ;
                         2598   ;input from keyboard

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 27-1
CHANNELIO   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         2599   ;
     F212   A5 D3        2600           lda  pntr       ; save current...
     F214   85 CA        2601           sta  lstp       ; ... cursor column
     F216   A5 D6        2602           lda  tblx       ; save current...
     F218   85 C9        2603           sta  lsxp       ; ... line number
     F21A   4C E64F      2604           jmp  loop5      ; blink cursor until return
                         2605   ;
     F21D   C9 03        2606   bn10    cmp  #3         ; is input from screen?
     F21F   D0 09        2607           bne  bn20       ; no...
                         2608   ;
     F221   85 D0        2609           sta  crsw       ; fake a carriage return
     F223   A5 D5        2610           lda  lnmx       ; say we ended...
     F225   85 C8        2611           sta  indx       ; ...up on this line
     F227   4C E64F      2612           jmp  loop5      ; pick up characters
                         2613   ;
     F22A   B0 38        2614   bn20    bcs  bn30       ; devices >3
     F22C   C9 02        2615           cmp  #2         ; rs232?
     F22E   F0 3F        2616           beq  bn50
                         2617   ;
                         2618   ;input from cassette buffers
                         2619   ;
     F230   86 97        2620           stx  xsav
     F232   20 F250      2621           jsr  jtget
     F235   B0 16        2622           bcs  jtg37      ; stop key/error
     F237   48           2623           pha
     F238   20 F250      2624           jsr  jtget
     F23B   B0 0D        2625           bcs  jtg36      ; stop key/error
     F23D   D0 05        2626           bne  jtg35      ; not an end of file
     F23F   A9 40        2627           lda  #64        ; tell user eof
     F241   20 FE6A      2628           jsr  udst       ; in status
     F244   C6 A6        2629   jtg35   dec  bufpt
     F246   A6 97        2630           ldx  xsav       ; .x preserved
     F248   68           2631           pla     ; character returned
                         2632   ;c-clear from jtget
     F249   60           2633           rts     ; all done
                         2634   ;
     F24A   AA           2635   jtg36   tax     ; save error info
     F24B   68           2636           pla     ; toss data
     F24C   8A           2637           txa     ; restore error
     F24D   A6 97        2638   jtg37   ldx  xsav       ; return
     F24F   60           2639           rts     ; error return c-set from jtget
                                
                                
                                
                         2641   ;get a character from appropriate
                         2642   ;cassette buffer
                         2643   ;
     F250   20 F88A      2644   jtget   jsr  jtp20      ; buffer pointer wrap?
     F253   D0 0B        2645           bne  jtg10      ; no...
     F255   20 F8C0      2646           jsr  rblk       ; yes...read next block

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 27-2
CHANNELIO   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     F258   B0 11        2647           bcs  bn32       ; stop key pressed
     F25A   A9 00        2648           lda  #0
     F25C   85 A6        2649           sta  bufpt      ; point to begin.
     F25E   F0 F0        2650           beq  jtget      ; branch always
                         2651   ;
     F260   B1 B2        2652   jtg10   lda  (tape1),y          ; get char from buf
     F262   18           2653           clc     ; good return
     F263   60           2654           rts
                                
                                
                                
                         2656   ;input from serial bus
                         2657   ;
     F264   A5 90        2658   bn30    lda  status     ; status from last
     F266   F0 04        2659           beq  bn35       ; was good
     F268   A9 0D        2660           lda  #$d        ; bad...all done
     F26A   18           2661   bn31    clc     ; valid data
     F26B   60           2662   bn32    rts
                         2663   ;
     F26C   4C EF19      2664   bn35    jmp  acptr      ; good...handshake
                         2665   ;
                         2666   ;input from rs232
                         2667   ;
     F26F   20 F205      2668   bn50    jsr  gn232      ; get info
     F272   B0 05        2669           bcs  bn52       ; error return
     F274   C9 00        2670           cmp  #00
     F276   F0 F7        2671           beq  bn50       ; wait for valid data
     F278   18           2672           clc     ; good return
     F279   60           2673   bn52    rts
                         2674   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 28
CHANNELIO   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         2676   ;***************************************
                         2677   ;* bsout -- out character to channel   *
                         2678   ;*     determined by variable dflto:   *
                         2679   ;*     0 -- invalid                    *
                         2680   ;*     1 -- cassette #1                *
                         2681   ;*     2 -- rs232                      *
                         2682   ;*     3 -- screen                     *
                         2683   ;*  4-31 -- serial bus                 *
                         2684   ;***************************************
                         2685   ;
     F27A   48           2686   nbsout  pha     ; preserve .a
     F27B   A5 9A        2687           lda  dflto      ; check device
     F27D   C9 03        2688           cmp  #3         ; is it the screen?
     F27F   D0 04        2689           bne  bo10       ; no...
                         2690   ;
                         2691   ;print to crt
                         2692   ;
     F281   68           2693           pla     ; restore data
     F282   4C E742      2694           jmp  prt        ; print on crt
                         2695   ;
     F285                2696   bo10
     F285   90 04        2697           bcc  bo20       ; device 1 or 2
                         2698   ;
                         2699   ;print to serial bus
                         2700   ;
     F287   68           2701           pla
     F288   4C EEE4      2702           jmp  ciout
                         2703   ;
                         2704   ;print to cassette devices
                         2705   ;
     F28B   C9 02        2706   bo20    cmp  #2         ; rs232?
     F28D   F0 2A        2707           beq  bo50
                         2708   ;
     F28F   68           2709           pla
     F290   85 9E        2710   casout  sta  t1
                         2711   ;
                         2712   ;preserve registers
                         2713   ;
     F292   48           2714           pha
     F293   8A           2715           txa
     F294   48           2716           pha
     F295   98           2717           tya
     F296   48           2718           pha
                         2719   ;
     F297   20 F88A      2720           jsr  jtp20      ; check buffer pointer
     F29A   D0 0E        2721           bne  jtp10      ; has not reached end
     F29C   20 F8E3      2722           jsr  wblk       ; write full buffer
     F29F   B0 0E        2723           bcs  rstor      ; abort on stop key
                         2724   ;
                         2725   ;put buffer type byte

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 28-1
CHANNELIO   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         2726   ;
     F2A1   A9 02        2727           lda  #bdf
     F2A3   A0 00        2728           ldy  #0
     F2A5   91 B2        2729           sta  (tape1),y
                         2730   ;
                         2731   ;reset buffer pointer
                         2732   ;
     F2A7   C8           2733           iny     ; make .y=1
     F2A8   84 A6        2734           sty  bufpt      ; bufpt=1
                         2735   ;
     F2AA   A5 9E        2736   jtp10   lda  t1
     F2AC   91 B2        2737           sta  (tape1),y          ; data to buffer
                         2738   ;
                         2739   ;restore .x and .y
                         2740   ;
     F2AE   18           2741           clc     ; good return
     F2AF   68           2742   rstor   pla
     F2B0   A8           2743           tay
     F2B1   68           2744           pla
     F2B2   AA           2745           tax
     F2B3   68           2746           pla     ; restore .a
     F2B4   90 02        2747           bcc  rstor1     ; no error
     F2B6   A9 00        2748           lda  #00        ; stop error if c-set
     F2B8   60           2749   rstor1  rts
                         2750   ;
                         2751   ;output to rs232
                         2752   ;
     F2B9   68           2753   bo50    pla     ; get data
     F2BA   86 97        2754           stx  xsav       ; put in a temp
     F2BC   84 9E        2755           sty  t1
     F2BE   20 F0ED      2756           jsr  bso232     ; could put code here
     F2C1   A6 97        2757           ldx  xsav       ; go restore
     F2C3   A4 9E        2758           ldy  t1
     F2C5   18           2759           clc     ; good return
     F2C6   60           2760           rts
                         2761   
                         2762   ;.end
                         2763   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 29
OPENCHANNEL   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         2765   	.SUBTTL OPENCHANNEL
                         2766   ;***************************************
                         2767   ;* chkin -- open channel for input     *
                         2768   ;*                                     *
                         2769   ;* the number of the logical file to be*
                         2770   ;* opened for input is passed in .x.   *
                         2771   ;* chkin searches the logical file     *
                         2772   ;* to look up device and command info. *
                         2773   ;* errors are reported if the device   *
                         2774   ;* was not opened for input ,(e.g.     *
                         2775   ;* cassette write file), or the logical*
                         2776   ;* file has no reference in the tables.*
                         2777   ;* device 0, (keyboard), and device 3  *
                         2778   ;* (screen), require no table entries  *
                         2779   ;* and are handled separate.           *
                         2780   ;***************************************
                         2781   ;
     F2C7   20 F3CF      2782   nchkin  jsr  lookup     ; see if file known
     F2CA   F0 03        2783           beq  jx310      ; yup...
                         2784   ;
     F2CC   4C F784      2785           jmp  error3     ; no...file not open
                         2786   ;
     F2CF   20 F3DF      2787   jx310   jsr  jz100      ; extract file info
                         2788   ;
     F2D2   A5 BA        2789           lda  fa
     F2D4   F0 16        2790           beq  jx320      ; is keyboard...done.
                         2791   ;
                         2792   ;could be screen, keyboard, or serial
                         2793   ;
     F2D6   C9 03        2794           cmp  #3
     F2D8   F0 12        2795           beq  jx320      ; is screen...done.
     F2DA   B0 14        2796           bcs  jx330      ; is serial...address it
     F2DC   C9 02        2797           cmp  #2         ; rs232?
     F2DE   D0 03        2798           bne  jx315      ; no...
                         2799   ;
     F2E0   4C F116      2800           jmp  cki232
                         2801   ;
                         2802   ;some extra checks for tape
                         2803   ;
     F2E3   A6 B9        2804   jx315   ldx  sa
     F2E5   E0 60        2805           cpx  #$60       ; is command a read?
     F2E7   F0 03        2806           beq  jx320      ; yes...o.k....done
                         2807   ;
     F2E9   4C F78D      2808           jmp  error6     ; not input file
                         2809   ;
     F2EC   85 99        2810   jx320   sta  dfltn      ; all input come from here
                         2811   ;
     F2EE   18           2812           clc     ; good exit
     F2EF   60           2813           rts
                         2814   ;

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 29-1
OPENCHANNEL   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         2815   ;an serial device has to be a talker
                         2816   ;
     F2F0   AA           2817   jx330   tax     ; device # for dflto
     F2F1   20 EE14      2818           jsr  talk       ; tell him to talk
                         2819   ;
     F2F4   A5 B9        2820           lda  sa         ; a second?
     F2F6   10 06        2821           bpl  jx340      ; yes...send it
     F2F8   20 EED3      2822           jsr  tkatn      ; no...let go
     F2FB   4C F301      2823           jmp  jx350
                         2824   ;
     F2FE   20 EECE      2825   jx340   jsr  tksa       ; send second
                         2826   ;
     F301   8A           2827   jx350   txa
     F302   24 90        2828           bit  status     ; did he listen?
     F304   10 E6        2829           bpl  jx320      ; yes
                         2830   ;
     F306   4C F78A      2831           jmp  error5     ; device not present
                         2832   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 30
OPENCHANNEL   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         2834   ;***************************************
                         2835   ;* chkout -- open channel for output     *
                         2836   ;*                                     *
                         2837   ;* the number of the logical file to be*
                         2838   ;* opened for output is passed in .x.  *
                         2839   ;* chkout searches the logical file    *
                         2840   ;* to look up device and command info. *
                         2841   ;* errors are reported if the device   *
                         2842   ;* was not opened for input ,(e.g.     *
                         2843   ;* keyboard), or the logical file has   *
                         2844   ;* reference in the tables.             *
                         2845   ;* device 0, (keyboard), and device 3  *
                         2846   ;* (screen), require no table entries  *
                         2847   ;* and are handled separate.           *
                         2848   ;***************************************
                         2849   ;
     F309   20 F3CF      2850   nckout  jsr  lookup     ; is file in table?
     F30C   F0 03        2851           beq  ck5        ; yes...
                         2852   ;
     F30E   4C F784      2853           jmp  error3     ; no...file not open
                         2854   ;
     F311   20 F3DF      2855   ck5     jsr  jz100      ; extract table info
                         2856   ;
     F314   A5 BA        2857           lda  fa         ; is it keyboard?
     F316   D0 03        2858           bne  ck10       ; no...something else.
                         2859   ;
     F318   4C F790      2860   ck20    jmp  error7     ; yes...not output file
                         2861   ;
                         2862   ;could be screen,serial,or tapes
                         2863   ;
     F31B   C9 03        2864   ck10    cmp  #3
     F31D   F0 0F        2865           beq  ck30       ; is screen...done
     F31F   B0 11        2866           bcs  ck40       ; is serial...address it
     F321   C9 02        2867           cmp  #2         ; rs232?
     F323   D0 03        2868           bne  ck15
                         2869   ;
     F325   4C F0BC      2870           jmp  cko232
                         2871   ;
                         2872   ;
                         2873   ;special tape channel handling
                         2874   ;
     F328   A6 B9        2875   ck15    ldx  sa
     F32A   E0 60        2876           cpx  #$60       ; is command read?
     F32C   F0 EA        2877           beq  ck20       ; yes...error
                         2878   ;
     F32E   85 9A        2879   ck30    sta  dflto      ; all output goes here
                         2880   ;
     F330   18           2881           clc     ; good exit
     F331   60           2882           rts
                         2883   ;

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 30-1
OPENCHANNEL   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     F332   AA           2884   ck40    tax     ; save device for dflto
     F333   20 EE17      2885           jsr  listn      ; tell him to listen
                         2886   ;
     F336   A5 B9        2887           lda  sa         ; is there a second?
     F338   10 05        2888           bpl  ck50       ; yes...
                         2889   ;
     F33A   20 EEC5      2890           jsr  scatn      ; no...release lines
     F33D   D0 03        2891           bne  ck60       ; branch always
                         2892   ;
     F33F   20 EEC0      2893   ck50    jsr  secnd      ; send second...
                         2894   ;
     F342   8A           2895   ck60    txa
     F343   24 90        2896           bit  status     ; did he listen?
     F345   10 E7        2897           bpl  ck30       ; yes...finish up
                         2898   ;
     F347   4C F78A      2899           jmp  error5     ; no...device not present
                         2900   
                         2901   ;.end
                         2902   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 31
CLOSE   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         2904   	.subttl CLOSE
                         2905   ;***************************************
                         2906   ;* close -- close logical file       *
                         2907   ;*                                   *
                         2908   ;*     the logical file number of the*
                         2909   ;* file to be closed is passed in .a.*
                         2910   ;* keyboard, screen, and files not   *
                         2911   ;* open pass straight through. tape  *
                         2912   ;* files open for write are closed by*
                         2913   ;* dumping the last buffer and       *
                         2914   ;* conditionally writing an end of   *
                         2915   ;* tape block.serial files are closed*
                         2916   ;* by sending a close file command if*
                         2917   ;* a secondary address was specified *
                         2918   ;* in its open command.              *
                         2919   ;***************************************
                         2920   ;
     F34A   20 F3D4      2921   nclose  jsr  jltlk      ; look file up
     F34D   F0 02        2922           beq  jx050      ; open...
     F34F   18           2923           clc     ; else return
     F350   60           2924           rts
                         2925   ;
     F351   20 F3DF      2926   jx050   jsr  jz100      ; extract table data
     F354   8A           2927           txa     ; save table index
     F355   48           2928           pha
                         2929   ;
     F356   A5 BA        2930           lda  fa         ; check device number
     F358   F0 57        2931           beq  jx150      ; is keyboard...done
     F35A   C9 03        2932           cmp  #3
     F35C   F0 53        2933           beq  jx150      ; is screen...done
     F35E   B0 4E        2934           bcs  jx120      ; is serial...process
     F360   C9 02        2935           cmp  #2         ; rs232?
     F362   D0 29        2936           bne  jx115      ; no...
                         2937   ;
                         2938   ; rs-232
                         2939   ;
                         2940   ; remove file from tables
     F364   68           2941           pla
     F365   20 F3B2      2942           jsr  jxrmv
                         2943   ;
                         2944   ; disable all rs-232 nmi's (cb1 t1 t2)
                         2945   ;
     F368   A9 7D        2946           lda  #%01111101
     F36A   8D 911E      2947           sta  d1ier
                         2948   ;
                         2949   ; send mark & all lines high
                         2950   ;
     F36D   A9 06        2951           lda  #%00000110
     F36F   8D 9110      2952           sta  d1orb
     F372   A9 EE        2953           lda  #%11101110

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 31-1
CLOSE   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     F374   8D 911C      2954           sta  d1pcr
                         2955   ;
                         2956   ; deallocate buffers
                         2957   ;
     F377   20 FE75      2958           jsr  gettop     ; get memsiz
     F37A   A5 F8        2959           lda  ribuf+1    ; check input allocation
     F37C   F0 01        2960           beq  cls010     ; not...allocated
     F37E   C8           2961           iny
     F37F   A5 FA        2962   cls010  lda  robuf+1    ; check output allocation
     F381   F0 01        2963           beq  cls020
     F383   C8           2964           iny
     F384   A9 00        2965   cls020  lda  #00        ; deallocate
     F386   85 F8        2966           sta  ribuf+1
     F388   85 FA        2967           sta  robuf+1	; flag top of memory change
     F38A   4C F53C      2968           jmp  memtcf     ; go set new top
                         2969   ;
                         2970   ;close cassette file
                         2971   ;
     F38D   A5 B9        2972   jx115   lda  sa         ; was it a tape read?
     F38F   29 0F        2973           and  #$f
     F391   F0 1E        2974           beq  jx150      ; yes
                         2975   ;
     F393   20 F84D      2976           jsr  zzz        ; no. . .it is write
     F396   A9 00        2977           lda  #0         ; end of file character
     F398   20 F290      2978           jsr  casout     ; put in end of file
     F39B   20 F8E3      2979           jsr  wblk       ; empty last buffer
     F39E   B0 2D        2980           bcs  jx170      ; stop key pressed
                         2981   ;
     F3A0   A5 B9        2982           lda  sa
     F3A2   C9 62        2983           cmp  #$62       ; write end of tape block?
     F3A4   D0 0B        2984           bne  jx150      ; no...
                         2985   ;
     F3A6   A9 05        2986           lda  #eot
     F3A8   20 F7E7      2987           jsr  tapeh      ; write end of tape block
     F3AB   4C F3B1      2988           jmp  jx150
                         2989   ;
                         2990   ;close an serial file
                         2991   ;
     F3AE   20 F6DA      2992   jx120   jsr  clsei
                         2993   ;
                         2994   ;entry to remove a give logical file
                         2995   ;from table of logical, primary, and secondary addresses
                         2996   ;
     F3B1   68           2997   jx150   pla     ; get table index off stack
                         2998   ;
                         2999   ; jxrmv - entry to use as an rs-232 subroutine
                         3000   ;
     F3B2   AA           3001   jxrmv   tax
     F3B3   C6 98        3002           dec  ldtnd
     F3B5   E4 98        3003           cpx  ldtnd      ; is deleted file at end?

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 31-2
CLOSE   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     F3B7   F0 14        3004           beq  jx170      ; yes...done
                         3005   ;
                         3006   ;delete entry in middle by moving
                         3007   ;last entry to that position.
                         3008   ;
     F3B9   A4 98        3009           ldy  ldtnd
     F3BB   B9 0259      3010           lda  lat,y
     F3BE   9D 0259      3011           sta  lat,x
     F3C1   B9 0263      3012           lda  fat,y
     F3C4   9D 0263      3013           sta  fat,x
     F3C7   B9 026D      3014           lda  sat,y
     F3CA   9D 026D      3015           sta  sat,x
                         3016   ;
     F3CD   18           3017   jx170   clc     ; close exit
     F3CE   60           3018           rts
                                
                                
                                
                                
                                
                         3020   ;lookup tablized logical file data
                         3021   ;
     F3CF   A9 00        3022   lookup  lda  #0
     F3D1   85 90        3023           sta  status
     F3D3   8A           3024           txa
     F3D4   A6 98        3025   jltlk   ldx  ldtnd
     F3D6   CA           3026   jx600   dex
     F3D7   30 15        3027           bmi  jz101
     F3D9   DD 0259      3028           cmp  lat,x
     F3DC   D0 F8        3029           bne  jx600
     F3DE   60           3030           rts
                                
                                
                                
                                
                                
                         3032   ;routine to fetch table entries
                         3033   ;
     F3DF   BD 0259      3034   jz100   lda  lat,x
     F3E2   85 B8        3035           sta  la
     F3E4   BD 0263      3036           lda  fat,x
     F3E7   85 BA        3037           sta  fa
     F3E9   BD 026D      3038           lda  sat,x
     F3EC   85 B9        3039           sta  sa
     F3EE   60           3040   jz101   rts
                         3041   
                         3042   ;.end
                         3043   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 32
CLALL   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         3045   	.subttl CLALL
                         3046   ;***************************************
                         3047   ;* clall -- close all logical files  *
                         3048   ;*      deletes all table entries and*
                         3049   ;* restores default i/o channels     *
                         3050   ;* and clears ieee port devices      *
                         3051   ;*************************************
                         3052   ;
     F3EF   A9 00        3053   nclall  lda  #0
     F3F1   85 98        3054           sta  ldtnd      ; forget all files
                                
                                
                                
                         3056   ;********************************************
                         3057   ;* clrch -- clear channels                  *
                         3058   ;*   unlisten or untalk ieee devices, but   *
                         3059   ;* leave others alone.  default channels    *
                         3060   ;* are restored.                            *
                         3061   ;********************************************
                         3062   ;
     F3F3   A2 03        3063   nclrch  ldx  #3
     F3F5   E4 9A        3064           cpx  dflto      ; is output channel ieee?
     F3F7   B0 03        3065           bcs  jx750      ; no...
                         3066   ;
     F3F9   20 EF04      3067           jsr  unlsn      ; yes...unlisten it
                         3068   ;
     F3FC   E4 99        3069   jx750   cpx  dfltn      ; is input channel ieee?
     F3FE   B0 03        3070           bcs  clall2     ; no...
                         3071   ;
     F400   20 EEF6      3072           jsr  untlk      ; yes...untalk it
                         3073   ;
                         3074   ;restore default values
                         3075   ;
                         3076   ;
     F403   86 9A        3077   clall2  stx  dflto      ; output chan=3=screen
     F405   A9 00        3078           lda  #0
     F407   85 99        3079           sta  dfltn      ; input chan=0=keyboard
     F409   60           3080           rts
                         3081   
                         3082   ;.end
                         3083   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 33
OPEN   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         3085   	.subttl OPEN
                         3086   ;***********************************
                         3087   ;*                                 *
                         3088   ;* open function                   *
                         3089   ;*                                 *
                         3090   ;* creates an entry in the logical *
                         3091   ;* files tables consisting of      *
                         3092   ;* logical file number--la, device *
                         3093   ;* number--fa, and secondary cmd-- *
                         3094   ;* sa.                             *
                         3095   ;*                                 *
                         3096   ;* a file name descriptor, fnadr & *
                         3097   ;* fnlen are passed to this routine*
                         3098   ;*                                 *
                         3099   ;***********************************
                         3100   ;
     F40A   A6 B8        3101   nopen   ldx  la         ; check file #
     F40C   D0 03        3102           bne  op98       ; is not the keyboard
                         3103   ;
     F40E   4C F78D      3104           jmp  error6     ; not input file...
                         3105   ;
     F411   20 F3CF      3106   op98    jsr  lookup     ; see if in table
     F414   D0 03        3107           bne  op100      ; not found...o.k.
                         3108   ;
     F416   4C F781      3109           jmp  error2     ; file open
                         3110   ;
     F419   A6 98        3111   op100   ldx  ldtnd      ; logical device table end
     F41B   E0 0A        3112           cpx  #10        ; maximum # of open files
     F41D   90 03        3113           bcc  op110      ; less than 10...o.k.
                         3114   ;
     F41F   4C F77E      3115           jmp  error1     ; too many files
                         3116   ;
     F422   E6 98        3117   op110   inc  ldtnd      ; new file
     F424   A5 B8        3118           lda  la
     F426   9D 0259      3119           sta  lat,x      ; store logical file #
     F429   A5 B9        3120           lda  sa
     F42B   09 60        3121           ora  #$60       ; make sa an serial command
     F42D   85 B9        3122           sta  sa
     F42F   9D 026D      3123           sta  sat,x      ; store command #
     F432   A5 BA        3124           lda  fa
     F434   9D 0263      3125           sta  fat,x      ; store device #
                         3126   ;
                         3127   ;perform device specific open tasks
                         3128   ;
     F437   F0 5A        3129           beq  op175      ; is keyboard...done.
     F439   C9 03        3130           cmp  #3
     F43B   F0 56        3131           beq  op175      ; is screen...done.
     F43D   90 05        3132           bcc  op150      ; are cassettes 1 & 2
                         3133   ;
     F43F   20 F495      3134           jsr  openi      ; is on serial...open it

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 33-1
OPEN   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     F442   90 4F        3135           bcc  op175      ; branch always...done
                         3136   ;
                         3137   ;perform tape open stuff
                         3138   ;
     F444   C9 02        3139   op150   cmp  #2
     F446   D0 03        3140           bne  op152
                         3141   ;
     F448   4C F4C7      3142           jmp  opn232
                         3143   ;
     F44B   20 F84D      3144   op152   jsr  zzz        ; see if tape buffer
     F44E   B0 03        3145           bcs  op155      ; yes
                         3146   ;
     F450   4C F796      3147           jmp  error9     ; no...deallocated
                         3148   ;
     F453   A5 B9        3149   op155   lda  sa
     F455   29 0F        3150           and  #$f        ; mask off command
     F457   D0 1F        3151           bne  op200      ; non zero is tape write
                         3152   ;
                         3153   ;open cassete tape file to read
                         3154   ;
     F459   20 F894      3155           jsr  cste1      ; tell "press play"
     F45C   B0 36        3156           bcs  op180      ; stop key pressed
                         3157   ;
     F45E   20 F647      3158           jsr  luking     ; tell user "searching"
                         3159   ;
     F461   A5 B7        3160           lda  fnlen
     F463   F0 0A        3161           beq  op170      ; looking for any file
                         3162   ;
     F465   20 F867      3163           jsr  faf        ; looking for named file
     F468   90 18        3164           bcc  op171      ; found it!!!
     F46A   F0 28        3165           beq  op180      ; stop key pressed
                         3166   ;
     F46C   4C F787      3167   op160   jmp  error4     ; file not found
                         3168   ;
     F46F   20 F7AF      3169   op170   jsr  fah        ; get any old header
     F472   F0 20        3170           beq  op180      ; stop key pressed
     F474   90 0C        3171           bcc  op171      ; all o.k.
     F476   B0 F4        3172           bcs  op160      ; file not found...
                         3173   ;
                         3174   ;open cassette tape for write
                         3175   ;
     F478   20 F8B7      3176   op200   jsr  cste2      ; tell "press play and record"
     F47B   B0 17        3177           bcs  op180      ; stop key pressed
     F47D   A9 04        3178           lda  #bdfh      ; data file header type
     F47F   20 F7E7      3179           jsr  tapeh      ; write it
                         3180   ;
                         3181   ;finish open for tape read/write
                         3182   ;
     F482   A9 BF        3183   op171   lda  #bufsz-1   ; assume force read
                         3184   ;

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 33-2
OPEN   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     F484   A4 B9        3185           ldy  sa
     F486   C0 60        3186           cpy  #$60       ; open for read?
     F488   F0 07        3187           beq  op172
                         3188   ;
                         3189   ;set pointers for buffering data
                         3190   ;
     F48A   A0 00        3191           ldy  #0
     F48C   A9 02        3192           lda  #bdf       ; type flag for block
     F48E   91 B2        3193           sta  (tape1),y          ; to begin of buffer
     F490   98           3194           tya
                         3195   ;
     F491   85 A6        3196   op172   sta  bufpt      ; point to data
     F493   18           3197   op175   clc     ; flag good open
     F494   60           3198   op180   rts     ; exit in peace
                                
                                
                                
                                
                                
     F495   A5 B9        3200   openi   lda  sa
     F497   30 2C        3201           bmi  op50       ; no sa...done
                         3202   ;
     F499   A4 B7        3203           ldy  fnlen
     F49B   F0 28        3204           beq  op50       ; no file name...done
                         3205   ;
     F49D   A5 BA        3206           lda  fa
     F49F   20 EE17      3207           jsr  listn      ; device la to listen
                         3208   ;
     F4A2   A5 B9        3209           lda  sa
     F4A4   09 F0        3210           ora  #$f0
     F4A6   20 EEC0      3211           jsr  secnd
                         3212   ;
     F4A9   A5 90        3213           lda  status     ; anybody home?
     F4AB   10 05        3214           bpl  op35       ; yes...continue
                         3215   ;
                         3216   ;this routine is called by other
                         3217   ;kernal routines which are called
                         3218   ;directly by os.  kill return
                         3219   ;address to return to os.
                         3220   ;
     F4AD   68           3221           pla
     F4AE   68           3222           pla
     F4AF   4C F78A      3223           jmp  error5     ; device not present
                         3224   ;
     F4B2   A5 B7        3225   op35    lda  fnlen
     F4B4   F0 0C        3226           beq  op45       ; no name...done sequence
                         3227   ;
                         3228   ;send file name over serial
                         3229   ;
     F4B6   A0 00        3230           ldy  #0

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 33-3
OPEN   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     F4B8   B1 BB        3231   op40    lda  (fnadr),y
     F4BA   20 EEE4      3232           jsr  ciout
     F4BD   C8           3233           iny
     F4BE   C4 B7        3234           cpy  fnlen
     F4C0   D0 F6        3235           bne  op40
                         3236   ;
     F4C2   20 EF04      3237   op45    jsr  unlsn
                         3238   ;
     F4C5   18           3239   op50    clc     ; no  error
     F4C6   60           3240           rts
                         3241   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 34
OPEN   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         3243   ; opn232 - open an rs-232 or parallel port file
                         3244   ;
                         3245   ; variables initilized
                         3246   ;   bitnum - # of bits to be sent calc from m51ctr
                         3247   ;   baudof - baud rate full
                         3248   ;   rsstat - rs-232 status reg
                         3249   ;   m51ctr - 6551 control reg
                         3250   ;   m51cdr - 6551 command reg
                         3251   ;   m51ajb - user time ####not implemented###
                         3252   ;
     F4C7                3253   opn232
                         3254   ;
                         3255   ; set up ddrb and cb2 for rs-232
                         3256   ;
     F4C7   A9 06        3257           lda  #%00000110         ; ddrb
     F4C9   8D 9112      3258           sta  d1ddrb
     F4CC   8D 9110      3259           sta  d1orb      ; dtr,rts high
     F4CF   A9 EE        3260           lda  #%11101110         ; cass off,tr mark,cb1 htl
     F4D1   8D 911C      3261           sta  d1pcr
                         3262   ;
                         3263   ; pass prams to m51regs
     F4D4   A0 00        3264           ldy  #00
     F4D6   8C 0297      3265           sty  rsstat     ; clear status
                         3266   ;
     F4D9   C4 B7        3267   opn020  cpy  fnlen      ; check if at end of filename
     F4DB   F0 0A        3268           beq  opn025     ; yes...
                         3269   ;
     F4DD   B1 BB        3270           lda  (fnadr),y          ; move data
     F4DF   99 0293      3271           sta  m51ctr,y   ; to m51regs
     F4E2   C8           3272           iny
     F4E3   C0 04        3273           cpy  #4         ; only 4 possible prams
     F4E5   D0 F2        3274           bne  opn020
                         3275   ;
                         3276   ; calc # of bits
                         3277   ;
     F4E7   20 F027      3278   opn025  jsr  bitcnt
     F4EA   8E 0298      3279           stx  bitnum
                         3280   ;
                         3281   ; calc baud rate
                         3282   ;
     F4ED   AD 0293      3283           lda  m51ctr
     F4F0   29 0F        3284           and  #$0f
     F4F2   D0 00        3285           bne  opn010
                         3286   ;
                         3287   ; get baud rate from else where ###need code###
                         3288   ;
     F4F4   0A           3289   opn010  asl  a          ; get index into baudo
     F4F5   AA           3290           tax
     F4F6   BD FF5A      3291           lda  baudo-2,x
     F4F9   0A           3292           asl  a          ; baudo*2+200 is rate

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 34-1
OPEN   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     F4FA   A8           3293           tay
     F4FB   BD FF5B      3294           lda  baudo-1,x
     F4FE   2A           3295           rol  a
     F4FF   48           3296           pha
     F500   98           3297           tya
     F501   69 C8        3298           adc  #cbit+cbit         ; table has cb1 adjst offset
     F503   8D 0299      3299           sta  baudof
     F506   68           3300           pla
     F507   69 00        3301           adc  #0         ; get carry in
     F509   8D 029A      3302           sta  baudof+1
                         3303   ;
                         3304   ; check for 3/x line response
                         3305   ;
     F50C   AD 0294      3306   opn030  lda  m51cdr     ; bit 0 of m51cdr
     F50F   4A           3307           lsr  a
     F510   90 09        3308           bcc  opn050     ; ...3 line
                         3309   ;
                         3310   ; check for x line proper states
                         3311   ;
     F512   AD 9120      3312           lda  d2orb
     F515   0A           3313           asl  a
     F516   B0 03        3314           bcs  opn050
     F518   4C F016      3315           jmp  dsrerr     ; no data set
                         3316   ;
                         3317   ; set up buffer pointers (dbe=dbs)
                         3318   ;
     F51B   AD 029B      3319   opn050  lda  ridbe
     F51E   8D 029C      3320           sta  ridbs
     F521   AD 029E      3321           lda  rodbe
     F524   8D 029D      3322           sta  rodbs
                         3323   ;
                         3324   ; allocate buffers
                         3325   ;
     F527   20 FE75      3326   opn055  jsr  gettop     ; get memsiz
     F52A   A5 F8        3327           lda  ribuf+1    ; in allocation...
     F52C   D0 05        3328           bne  opn060     ; already
     F52E   88           3329           dey     ; there goes 256 bytes
     F52F   84 F8        3330           sty  ribuf+1
     F531   86 F7        3331           stx  ribuf
     F533   A5 FA        3332   opn060  lda  robuf+1    ; out allocation...
     F535   D0 05        3333           bne  memtcf     ; alreay
     F537   88           3334           dey     ; there goes 256 bytes
     F538   84 FA        3335           sty  robuf+1
     F53A   86 F9        3336           stx  robuf
     F53C   38           3337   memtcf  sec     ; signal top of memory change
     F53D   A9 F0        3338           lda  #$f0
     F53F   4C FE7B      3339           jmp  settop     ; top changed
                         3340   
                         3341   ;.end
                         3342   ; rsr 8/25/80 add rs-232 code

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 34-2
OPEN   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         3343   ; rsr 8/26/80 top of memory handler
                         3344   ; rsr 8/29/80 add filename to m51regs
                         3345   ; rsr 9/2/80 fix ordering of rs-232 routines
                         3346   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 35
LOAD   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         3348   	.subttl LOAD
                         3349   ;**********************************
                         3350   ;* load ram function              *
                         3351   ;*                                *
                         3352   ;* loads from cassette 1 or 2, or *
                         3353   ;* serial bus devices >=4 to 31   *
                         3354   ;* as determined by contents of   *
                         3355   ;* variable fa. verify flag in .a *
                         3356   ;*                                *
                         3357   ;* alt load if sa=0, normal sa=1  *
                         3358   ;* .x , .y load address if sa=0   *
                         3359   ;* .a=0 performs load,<> is verify*
                         3360   ;*                                *
                         3361   ;* high load return in x,y.       *
                         3362   ;*                                *
                         3363   ;**********************************
                                
                                
                                
     F542   86 C3        3365   loadsp  stx  memuss     ; .x has low alt start
     F544   84 C4        3366           sty  memuss+1
     F546   6C 0330      3367   load    jmp  (iload)    ; monitor load entry
                         3368   ;
     F549   85 93        3369   nload   sta  verck      ; store verify flag
     F54B   A9 00        3370           lda  #0
     F54D   85 90        3371           sta  status
                         3372   ;
     F54F   A5 BA        3373           lda  fa         ; check device number
     F551   D0 03        3374           bne  ld20
                         3375   ;
     F553   4C F796      3376   ld10    jmp  error9     ; bad device #-keyboard
                         3377   ;
     F556   C9 03        3378   ld20    cmp  #3
     F558   F0 F9        3379           beq  ld10       ; disallow screen load
     F55A   90 6E        3380           bcc  ld100      ; handle tapes different
                         3381   ;
                         3382   ;load from cbm ieee device
                         3383   ;
     F55C   A4 B7        3384           ldy  fnlen      ; must have file name
     F55E   D0 03        3385           bne  ld25       ; yes...ok
                         3386   ;
     F560   4C F793      3387           jmp  error8     ; missing file name
                         3388   ;
     F563   20 E4BC      3389   ld25    jsr  patch2     ; tell user looking
     F566   A9 60        3390           lda  #$60       ; special load command
     F568   85 B9        3391           sta  sa
     F56A   20 F495      3392           jsr  openi      ; open the file
                         3393   ;
     F56D   A5 BA        3394           lda  fa
     F56F   20 EE14      3395           jsr  talk       ; establish the channel

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 35-1
LOAD   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     F572   A5 B9        3396           lda  sa
     F574   20 EECE      3397           jsr  tksa       ; tell it to load
                         3398   ;
     F577   20 EF19      3399           jsr  acptr      ; get first byte
     F57A   85 AE        3400           sta  eal
                         3401   ;
     F57C   A5 90        3402           lda  status     ; test status for error
     F57E   4A           3403           lsr  a
     F57F   4A           3404           lsr  a
     F580   B0 45        3405           bcs  ld90       ; file not found...
     F582   20 EF19      3406           jsr  acptr
     F585   85 AF        3407           sta  eah
                         3408   ;
     F587   20 E4C1      3409           jsr  patch3     ; tell user loading
                         3410   ;
                         3411   ;
     F58A   A9 FD        3412   ld40    lda  #$fd       ; mask off timeout
     F58C   25 90        3413           and  status
     F58E   85 90        3414           sta  status
                         3415   ;
     F590   20 FFE1      3416           jsr  stop       ; stop key?
     F593   D0 03        3417           bne  ld45       ; no...
                         3418   ;
     F595   4C F6CB      3419           jmp  break      ; stop key pressed
                         3420   ;
     F598   20 EF19      3421   ld45    jsr  acptr      ; get byte off ieee
     F59B   AA           3422           tax
     F59C   A5 90        3423           lda  status     ; was there a timeout?
     F59E   4A           3424           lsr  a
     F59F   4A           3425           lsr  a
     F5A0   B0 E8        3426           bcs  ld40       ; yes...try again
     F5A2   8A           3427           txa
     F5A3   A4 93        3428           ldy  verck      ; performing verify?
     F5A5   F0 0C        3429           beq  ld50       ; no...load
     F5A7   A0 00        3430           ldy  #0
     F5A9   D1 AE        3431           cmp  (eal),y    ; verify it
     F5AB   F0 08        3432           beq  ld60       ; o.k....
     F5AD   A9 10        3433           lda  #sperr     ; no good...verify error
     F5AF   20 FE6A      3434           jsr  udst       ; update status
     F5B2   2C           3435   	.byte   $2c    ; skip next store
                         3436   ;
     F5B3   91 AE        3437   ld50    sta  (eal),y
     F5B5   E6 AE        3438   ld60    inc  eal        ; increment store addr
     F5B7   D0 02        3439           bne  ld64
     F5B9   E6 AF        3440           inc  eah
     F5BB   24 90        3441   ld64    bit  status     ; eoi?
     F5BD   50 CB        3442           bvc  ld40       ; no...continue load
                         3443   ;
     F5BF   20 EEF6      3444           jsr  untlk      ; close channel
     F5C2   20 F6DA      3445           jsr  clsei      ; close the file

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 35-2
LOAD   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     F5C5   90 7A        3446           bcc  ld180      ; branch always
                         3447   ;
     F5C7   4C F787      3448   ld90    jmp  error4     ; file not found
                         3449   ;
                         3450   ;load from tape
                         3451   ;
     F5CA   C9 02        3452   ld100   cmp  #2
     F5CC   D0 03        3453           bne  ld102
                         3454   ;
     F5CE   4C F0B9      3455           jmp  rs232
                         3456   ;
     F5D1   20 F84D      3457   ld102   jsr  zzz        ; set pointers at tape
     F5D4   B0 03        3458           bcs  ld104
     F5D6   4C F796      3459           jmp  error9     ; deallocated...
                         3460   
     F5D9   20 F894      3461   ld104   jsr  cste1      ; tell user about buttons
     F5DC   B0 68        3462           bcs  ld190      ; stop key pressed?
     F5DE   20 F647      3463           jsr  luking     ; tell user searching
                         3464   ;
     F5E1   A5 B7        3465   ld112   lda  fnlen      ; is there a name?
     F5E3   F0 09        3466           beq  ld150      ; none...load anything
     F5E5   20 F867      3467           jsr  faf        ; find a file on tape
     F5E8   90 0B        3468           bcc  ld170      ; got it!
     F5EA   F0 5A        3469           beq  ld190      ; stop key pressed
     F5EC   B0 D9        3470   	bcs ld90 	; nope...end of tape
                         3471   ;
     F5EE   20 F7AF      3472   ld150   jsr  fah        ; find any header
     F5F1   F0 53        3473           beq  ld190      ; stop key pressed
     F5F3   B0 D2        3474           bcs  ld90       ; no header
                         3475   ;
     F5F5   A5 90        3476   ld170   lda  status
     F5F7   29 10        3477           and  #sperr     ; must got header right
     F5F9   38           3478           sec
     F5FA   D0 4A        3479           bne  ld190      ; is bad
                         3480   ;
     F5FC   E0 01        3481           cpx  #blf       ; is it a movable program...
     F5FE   F0 11        3482           beq  ld178      ; yes
                         3483   ;
     F600   E0 03        3484           cpx  #plf       ; is it a program
     F602   D0 DD        3485           bne  ld112      ; no...its something else
                         3486   ;
     F604   A0 01        3487   ld177   ldy  #1         ; fixed load...
     F606   B1 B2        3488           lda  (tape1),y          ; ...the address in the...
     F608   85 C3        3489           sta  memuss     ; ...buffer is the start address
     F60A   C8           3490           iny
     F60B   B1 B2        3491           lda  (tape1),y
     F60D   85 C4        3492           sta  memuss+1
     F60F   B0 04        3493           bcs  ld179      ; jmp ..carry set by cpx's
                         3494   ;
     F611   A5 B9        3495   ld178   lda  sa         ; check for monitor load...

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 35-3
LOAD   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     F613   D0 EF        3496           bne  ld177      ; ...yes we want fixed type
                         3497   ;
     F615   A0 03        3498   ld179   ldy  #3         ; tapea - tapesta
                         3499   ;carry set by cpx's
     F617   B1 B2        3500           lda  (tape1),y
     F619   A0 01        3501           ldy  #1
     F61B   F1 B2        3502           sbc  (tape1),y
     F61D   AA           3503           tax     ; low to .x
     F61E   A0 04        3504           ldy  #4
     F620   B1 B2        3505           lda  (tape1),y
     F622   A0 02        3506           ldy  #2
     F624   F1 B2        3507           sbc  (tape1),y
     F626   A8           3508           tay     ; high to .y
                         3509   ;
     F627   18           3510           clc     ; ea = sta+(tapea-tapesta)
     F628   8A           3511           txa
     F629   65 C3        3512           adc  memuss     ;
     F62B   85 AE        3513           sta  eal
     F62D   98           3514           tya
     F62E   65 C4        3515           adc  memuss+1
     F630   85 AF        3516           sta  eah
     F632   A5 C3        3517           lda  memuss     ; set up starting address
     F634   85 C1        3518           sta  stal
     F636   A5 C4        3519           lda  memuss+1
     F638   85 C2        3520           sta  stah
     F63A   20 F66A      3521           jsr  loding     ; tell user loading
     F63D   20 F8C9      3522           jsr  trd        ; do tape block load
     F640   24           3523   	.byte   $24    ; carry from trd
                         3524   ;
     F641   18           3525   ld180   clc     ; good exit
                         3526   ;
                         3527   ; set up end load address
                         3528   ;
     F642   A6 AE        3529           ldx  eal
     F644   A4 AF        3530           ldy  eah
                         3531   ;
     F646   60           3532   ld190   rts
                                
                                
                                
                                
                                
                         3534   ;subroutine to print to console:
                         3535   ;
                         3536   ;searching [for name]
                         3537   ;
     F647   A5 9D        3538   luking  lda  msgflg     ; supposed to print?
     F649   10 1E        3539           bpl  ld115      ; ...no
     F64B   A0 0C        3540           ldy  #ms5-ms1   ; "searching"
     F64D   20 F1E6      3541           jsr  msg

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 35-4
LOAD   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     F650   A5 B7        3542           lda  fnlen
     F652   F0 15        3543           beq  ld115
     F654   A0 17        3544           ldy  #ms6-ms1   ; "for"
     F656   20 F1E6      3545           jsr  msg
                                
                                
                                
                         3547   ;subroutine to output file name
                         3548   ;
     F659   A4 B7        3549   outfn   ldy  fnlen      ; is there a name?
     F65B   F0 0C        3550           beq  ld115      ; no...done
     F65D   A0 00        3551           ldy  #0
     F65F   B1 BB        3552   ld110   lda  (fnadr),y
     F661   20 FFD2      3553           jsr  bsout
     F664   C8           3554           iny
     F665   C4 B7        3555           cpy  fnlen
     F667   D0 F6        3556           bne  ld110
                         3557   ;
     F669   60           3558   ld115   rts
                                
                                
                                
                         3560   ;subroutine to print:
                         3561   ;
                         3562   ;loading/verifing
                         3563   ;
     F66A   A0 49        3564   loding  ldy  #ms10-ms1          ; assume 'loading'
     F66C   A5 93        3565           lda  verck      ; check flag
     F66E   F0 02        3566           beq  ld410      ; are doing load
     F670   A0 59        3567           ldy  #ms21-ms1          ; are 'verifying'
     F672   4C F1E2      3568   ld410   jmp  spmsg
                         3569   
            =F675        3570   skipby   = *
                         3571   
                         3572   ;
                         3573   ; patches for disk auto-offset load
                         3574   ;
                         3575   
            =E4BC        3576   	* = ksp2   ; kernal space for patch 2
                         3577   
     E4BC   A6 B9        3578   patch2  ldx  sa         ; save sa in .x
     E4BE   4C F647      3579           jmp  luking     ; go tell user
                         3580   
     E4C1   8A           3581   patch3  txa     ; find out how to load
     E4C2   D0 08        3582           bne  patch4     ; use programs load address
     E4C4   A5 C3        3583           lda  memuss     ; else move where i want
     E4C6   85 AE        3584           sta  eal
     E4C8   A5 C4        3585           lda  memuss+1
     E4CA   85 AF        3586           sta  eah
     E4CC   4C F66A      3587   patch4  jmp  loding     ; tell user loading

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 35-5
LOAD   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         3588   ;
                         3589   
            =E4CF        3590   ksp3	= *     ; kernal space for patch 3
            =F675        3591   	* = skipby
                         3592   
                         3593   ;.end
                         3594   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 36
SAVE   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         3596   	.subttl SAVE
                         3597   ;***********************************
                         3598   ;* save                            *
                         3599   ;*                                 *
                         3600   ;* saves to cassette 1 or 2, or    *
                         3601   ;* ieee devices 4>=n>=31 as select-*
                         3602   ;* ed by variable fa.              *
                         3603   ;*                                 *
                         3604   ;*start of save is indirect at .a  *
                         3605   ;*end of save is .x,.y             *
                         3606   ;***********************************
                                
                                
                                
     F675   86 AE        3608   savesp  stx  eal
     F677   84 AF        3609           sty  eah
     F679   AA           3610           tax     ; set up start
     F67A   B5 00        3611           lda  $00,x
     F67C   85 C1        3612           sta  stal
     F67E   B5 01        3613           lda  $01,x
     F680   85 C2        3614           sta  stah
                         3615   ;
     F682   6C 0332      3616   save    jmp  (isave)
                         3617   
     F685   A5 BA        3618   nsave   lda  fa  	;***monitor  entry
     F687   D0 03        3619           bne  sv20
                         3620   ;
     F689   4C F796      3621   sv10    jmp  error9     ; bad device #
                         3622   ;
     F68C   C9 03        3623   sv20    cmp  #3
     F68E   F0 F9        3624           beq  sv10
     F690   90 5F        3625           bcc  sv100
     F692   A9 61        3626           lda  #$61
     F694   85 B9        3627           sta  sa
     F696   A4 B7        3628           ldy  fnlen
     F698   D0 03        3629           bne  sv25
                         3630   ;
     F69A   4C F793      3631           jmp  error8     ; missing file name
                         3632   ;
     F69D   20 F495      3633   sv25    jsr  openi
     F6A0   20 F728      3634           jsr  saving
     F6A3   A5 BA        3635           lda  fa
     F6A5   20 EE17      3636           jsr  listn
     F6A8   A5 B9        3637           lda  sa
     F6AA   20 EEC0      3638           jsr  secnd
     F6AD   A0 00        3639           ldy  #0
     F6AF   20 FBD2      3640           jsr  rd300
     F6B2   A5 AC        3641           lda  sal
     F6B4   20 EEE4      3642           jsr  ciout
     F6B7   A5 AD        3643           lda  sah

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 36-1
SAVE   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     F6B9   20 EEE4      3644           jsr  ciout
     F6BC   20 FD11      3645   sv30    jsr  cmpste     ; compare start to end
     F6BF   B0 16        3646           bcs  sv50       ; have reached end
     F6C1   B1 AC        3647           lda  (sal),y
     F6C3   20 EEE4      3648           jsr  ciout
     F6C6   20 FFE1      3649           jsr  stop
     F6C9   D0 07        3650           bne  sv40
                         3651   ;
     F6CB   20 F6DA      3652   break   jsr  clsei
     F6CE   A9 00        3653           lda  #0
     F6D0   38           3654           sec
     F6D1   60           3655           rts
                         3656   ;
     F6D2   20 FD1B      3657   sv40    jsr  incsal     ; increment current addr.
     F6D5   D0 E5        3658           bne  sv30
     F6D7   20 EF04      3659   sv50    jsr  unlsn
                                
                                
                                
                                
                                
     F6DA   24 B9        3661   clsei   bit  sa
     F6DC   30 11        3662           bmi  clsei2
     F6DE   A5 BA        3663           lda  fa
     F6E0   20 EE17      3664           jsr  listn
     F6E3   A5 B9        3665           lda  sa
     F6E5   29 EF        3666           and  #$ef
     F6E7   09 E0        3667           ora  #$e0
     F6E9   20 EEC0      3668           jsr  secnd
     F6EC   20 EF04      3669           jsr  unlsn
                         3670   ;
     F6EF   18           3671   clsei2  clc
     F6F0   60           3672           rts
                                
                                
                                
                                
                                
     F6F1   C9 02        3674   sv100   cmp  #2
     F6F3   D0 03        3675           bne  sv102
                         3676   ;
     F6F5   4C F0B9      3677           jmp  rs232
                         3678   ;
     F6F8   20 F84D      3679   sv102   jsr  zzz        ; get addr of tape
     F6FB   90 8C        3680           bcc  sv10       ; buffer is deallocated
     F6FD   20 F8B7      3681           jsr  cste2
     F700   B0 25        3682           bcs  sv115      ; stop key pressed
     F702   20 F728      3683           jsr  saving     ; tell user 'saving'
     F705   A2 03        3684   sv105   ldx  #plf       ; decide type to save
     F707   A5 B9        3685           lda  sa         ; 1-plf 0-blf

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 36-2
SAVE   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     F709   29 01        3686           and  #01
     F70B   D0 02        3687           bne  sv106
     F70D   A2 01        3688           ldx  #blf
     F70F   8A           3689   sv106   txa
     F710   20 F7E7      3690           jsr  tapeh
     F713   B0 12        3691           bcs  sv115      ; stop key pressed
     F715   20 F8E6      3692           jsr  twrt
     F718   B0 0D        3693           bcs  sv115      ; stop key pressed
     F71A   A5 B9        3694           lda  sa
     F71C   29 02        3695           and  #2         ; write end of tape?
     F71E   F0 06        3696           beq  sv110      ; no...
                         3697   ;
     F720   A9 05        3698           lda  #eot
     F722   20 F7E7      3699           jsr  tapeh
     F725   24           3700   	.byte   $24    ; skip 1 byte
                         3701   ;
     F726   18           3702   sv110   clc
     F727   60           3703   sv115   rts
                                
                                
                                
                         3705   ;subroutine to output:
                         3706   ;'saving <file name>'
                         3707   ;
     F728   A5 9D        3708   saving  lda  msgflg
     F72A   10 FB        3709           bpl  sv115      ; no print
                         3710   ;
     F72C   A0 51        3711           ldy  #ms11-ms1          ; 'saving'
     F72E   20 F1E6      3712           jsr  msg
     F731   4C F659      3713           jmp  outfn      ; <file name>
                         3714   
                         3715   ;.end
                         3716   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 37
TIME   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         3718   	.subttl TIME
                         3719   ;***********************************
                         3720   ;*                                 *
                         3721   ;* time                            *
                         3722   ;*                                 *
                         3723   ;*consists of three functions:     *
                         3724   ;* (1) udtim-- update time. usually*
                         3725   ;*     called every 60th second.   *
                         3726   ;* (2) settim-- set time. .y=msd,  *
                         3727   ;*     .x=next significant,.a=lsd  *
                         3728   ;* (3) rdtim-- read time. .y=msd,  *
                         3729   ;*     .x=next significant,.a=lsd  *
                         3730   ;*                                 *
                         3731   ;***********************************
                         3732   
                         3733   ;interrupts are coming from tv horizontal
                         3734   ;which is close to 60hz but a little over.
                         3735   ;crfac counts up then skips one update
                         3736   ;of the time register.
                         3737   ;
     F734   A2 00        3738   udtim   ldx  #0         ; pre-load for later
                         3739   ; inc crfac
                         3740   ; lda crfac
                         3741   ; bne ud10
                         3742   ; inc crfac+1
                         3743   ; ud10 cmp #$6f
                         3744   ; bne ud20
                         3745   ; lda crfac+1
                         3746   ; cmp #2
                         3747   ; beq ud50
                         3748   ;
                         3749   ;here we proceed with an increment
                         3750   ;of the time register.
                         3751   ;
     F736   E6 A2        3752   ud20    inc  time+2
     F738   D0 06        3753           bne  ud30
     F73A   E6 A1        3754           inc  time+1
     F73C   D0 02        3755           bne  ud30
     F73E   E6 A0        3756           inc  time
                         3757   ;
                         3758   ;here we check for roll-over 23:59:59
                         3759   ;and reset the clock to zero if true
                         3760   ;
                         3761   ;24:00:00 = 5184000 jiffies
                         3762   ;=79*65536+26*256+0
                         3763   ;=$4f*65536+$1a*256+$0+correction
                         3764   ;
                         3765   ;final correction is +1/60th in
                         3766   ;24 hours.
                         3767   ;

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 37-1
TIME   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     F740   38           3768   ud30    sec
     F741   A5 A2        3769           lda  time+2
     F743   E9 01        3770           sbc  #$01
     F745   A5 A1        3771           lda  time+1
     F747   E9 1A        3772           sbc  #$1a
     F749   A5 A0        3773           lda  time
     F74B   E9 4F        3774           sbc  #$4f
     F74D   90 06        3775           bcc  ud60
                         3776   ;
                         3777   ;time has rolled--zero register
                         3778   ;
     F74F   86 A0        3779           stx  time
     F751   86 A1        3780           stx  time+1
     F753   86 A2        3781           stx  time+2
                         3782   ; bcs ud60 ;branch always
                         3783   ;
                         3784   ;cor. factor rolled--zero it
                         3785   ;
                         3786   ; ud50 stx crfac
                         3787   ; stx crfac+1
                         3788   ;
                         3789   ;set stop key flag here
                         3790   ;
     F755   AD 912F      3791   ud60    lda  d2ora      ; wait for it to settle
     F758   CD 912F      3792           cmp  d2ora
     F75B   D0 F8        3793           bne  ud60       ; still bouncing
     F75D   4C E4CF      3794           jmp  stptch     ; jump to patch checking for both shift keys
                         3795   ;
                         3796   ; the following 3 bytes were replaced with the preceeding jmp
                         3797   ;
                         3798   ;  sta stkey ;save for other routines
                         3799   ;  rts
                                
                                
                                
                                
                                
     F760   78           3801   rdtim   sei     ; keep time from rolling
     F761   A5 A2        3802           lda  time+2     ; get lsd
     F763   A6 A1        3803           ldx  time+1     ; get next most sig.
     F765   A4 A0        3804           ldy  time       ; get msd
                                
                                
                                
                                
                                
     F767   78           3806   settim  sei     ; keep time from changing
     F768   85 A2        3807           sta  time+2     ; store lsd
     F76A   86 A1        3808           stx  time+1     ; next most significant
     F76C   84 A0        3809           sty  time       ; store msd

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 37-2
TIME   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     F76E   58           3810           cli
     F76F   60           3811           rts
                         3812   
            =F770        3813   skipit	= *        ; go around this patch
                         3814   
                         3815   ;
                         3816   ;*********************************************************************
                         3817   ;
                         3818   ;   patch to check for right shift key  on stop key check
                         3819   ;
                         3820   ;*********************************************************************
                         3821   ;
            =E4CF        3822   	* = ksp3
     E4CF                3823   stptch
     E4CF   AA           3824           tax     ; save stop key row
     E4D0   38           3825           sec
     E4D1   2E 9120      3826           rol  colm       ; look at next row for this column
     E4D4   AD 9121      3827           lda  rows
     E4D7   6E 9120      3828           ror  colm       ; put it back the way it was
     E4DA   29 40        3829           and  #$40       ; check right shift key bit
     E4DC   F0 03        3830           beq  itsset     ; branch if right shift is down
                         3831   ;
     E4DE   86 91        3832           stx  stkey      ; else leave it as it is
     E4E0   60           3833           rts
                         3834   ;
     E4E1   8A           3835   itsset  txa
     E4E2   29 FD        3836           and  #$fd       ; clear the shift bit
     E4E4   85 91        3837           sta  stkey      ; its not the stop key alone
     E4E6   60           3838           rts
                         3839   ;
            =E4E7        3840   ksp4	= *
            =F770        3841   	* = skipit
                         3842   ;.end
                         3843   ; rsr 8/21/80 remove crfac change stop
                         3844   ; jm 1/21/80 fix so shit/stop give run from right
                         3845   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 38
ERRORHANDLER   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         3847   	.subttl ERRORHANDLER
                         3848   ;***************************************
                         3849   ;* stop -- check stop key flag and     *
                         3850   ;* return z flag set if flag true.     *
                         3851   ;* also closes active channels and     *
                         3852   ;* flushes keyboard queue.             *
                         3853   ;* also returns key downs from last    *
                         3854   ;* keyboard row in .a.                 *
                         3855   ;***************************************
     F770   A5 91        3856   nstop   lda  stkey      ; value of last row
     F772   C9 FE        3857           cmp  #$fe       ; check stop key position
     F774   D0 07        3858           bne  stop2      ; not down
     F776   08           3859           php
     F777   20 FFCC      3860           jsr  clrch      ; clear channels
     F77A   85 C6        3861           sta  ndx        ; flush queue
     F77C   28           3862           plp
     F77D   60           3863   stop2   rts
                                
                                
                                
                                
                                
                         3865   ;************************************
                         3866   ;*                                  *
                         3867   ;* error handler                    *
                         3868   ;*                                  *
                         3869   ;* prints kernal error message if   *
                         3870   ;* bit 6 of msgflg set.  returns    *
                         3871   ;* with error # in .a and carry.    *
                         3872   ;*                                  *
                         3873   ;************************************
                         3874   ;
     F77E   A9 01        3875   error1  lda  #1         ; too many files
     F780   2C           3876   	.byte   $2c
     F781   A9 02        3877   error2  lda  #2         ; file open
     F783   2C           3878   	.byte   $2c
     F784   A9 03        3879   error3  lda  #3         ; file not open
     F786   2C           3880   	.byte   $2c
     F787   A9 04        3881   error4  lda  #4         ; file not found
     F789   2C           3882   	.byte   $2c
     F78A   A9 05        3883   error5  lda  #5         ; device not present
     F78C   2C           3884   	.byte   $2c
     F78D   A9 06        3885   error6  lda  #6         ; not input file
     F78F   2C           3886   	.byte   $2c
     F790   A9 07        3887   error7  lda  #7         ; not output file
     F792   2C           3888   	.byte   $2c
     F793   A9 08        3889   error8  lda  #8         ; missing file name
     F795   2C           3890   	.byte   $2c
     F796   A9 09        3891   error9  lda  #9         ; bad device #
                         3892   ;

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 38-1
ERRORHANDLER   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     F798   48           3893           pha     ; error number on stack
     F799   20 FFCC      3894           jsr  clrch      ; restore i/o channels
                         3895   ;
     F79C   A0 00        3896           ldy  #ms1-ms1
     F79E   24 9D        3897           bit  msgflg     ; are we printing error?
     F7A0   50 0A        3898           bvc  erexit     ; no...
                         3899   ;
     F7A2   20 F1E6      3900           jsr  msg        ; print "cbm i/o error #"
     F7A5   68           3901           pla
     F7A6   48           3902           pha
     F7A7   09 30        3903           ora  #$30       ; make error # ascii
     F7A9   20 FFD2      3904           jsr  bsout      ; print it
                         3905   ;
     F7AC   68           3906   erexit  pla
     F7AD   38           3907           sec
     F7AE   60           3908           rts
                         3909   
                         3910   ;.end
                         3911   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 39
TAPEFILES   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         3913   	.subttl TAPEFILES
                         3914   ;fah -- find any header
                         3915   ;
                         3916   ;reads tape device until one of following
                         3917   ;block types found: bdfh--basic data
                         3918   ;file header, blf--basic load file
                         3919   ;for success carry is clear on return.
                         3920   ;for failure carry is set on return.
                         3921   ;in addition accumulator is 0 if stop
                         3922   ;key was pressed.
                         3923   
     F7AF   A5 93        3924   fah     lda  verck      ; save old verify
     F7B1   48           3925           pha
     F7B2   20 F8C0      3926           jsr  rblk       ; read tape block
     F7B5   68           3927           pla
     F7B6   85 93        3928           sta  verck      ; restore verify flag
     F7B8   B0 2C        3929           bcs  fah40      ; read terminated
                         3930   ;
     F7BA   A0 00        3931           ldy  #0
     F7BC   B1 B2        3932           lda  (tape1),y          ; get header type
                         3933   ;
     F7BE   C9 05        3934           cmp  #eot       ; check end of tape?
     F7C0   F0 24        3935           beq  fah40      ; yes...failure
                         3936   ;
     F7C2   C9 01        3937           cmp  #blf       ; basic load file?
     F7C4   F0 08        3938           beq  fah50      ; yes...success
                         3939   ;
     F7C6   C9 03        3940           cmp  #plf       ; fixed load file?
     F7C8   F0 04        3941           beq  fah50      ; yes...success
                         3942   ;
     F7CA   C9 04        3943           cmp  #bdfh      ; basic data file?
     F7CC   D0 E1        3944           bne  fah        ; no...keep trying
                         3945   ;
     F7CE   AA           3946   fah50   tax     ; return file type in .x
     F7CF   24 9D        3947           bit  msgflg     ; printing messages?
     F7D1   10 11        3948           bpl  fah45      ; no...
                         3949   ;
     F7D3   A0 63        3950           ldy  #ms17-ms1          ; print "found"
     F7D5   20 F1E6      3951           jsr  msg
                         3952   ;
                         3953   ;output complete file name
                         3954   ;
     F7D8   A0 05        3955           ldy  #5
     F7DA   B1 B2        3956   fah55   lda  (tape1),y
     F7DC   20 FFD2      3957           jsr  bsout
     F7DF   C8           3958           iny
     F7E0   C0 15        3959           cpy  #21
     F7E2   D0 F6        3960           bne  fah55
     F7E4   18           3961   fah45   clc     ; success flag
     F7E5   88           3962           dey     ; make nonzero for okay return

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 39-1
TAPEFILES   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         3963   ;
     F7E6   60           3964   fah40   rts
                                
                                
                                
                                
                                
                         3966   ;tapeh--write tape header
                         3967   ;error if tape buffer de-allocated
                         3968   ;carry clear if o.k.
                         3969   ;
     F7E7   85 9E        3970   tapeh   sta  t1
                         3971   ;
                         3972   ;determine address of buffer
                         3973   ;
     F7E9   20 F84D      3974           jsr  zzz
     F7EC   90 5E        3975           bcc  th40       ; buffer was de-allocated
                         3976   ;
                         3977   ;preserve start and end addresses
                         3978   ;for case of header for load file
                         3979   ;
     F7EE   A5 C2        3980           lda  stah
     F7F0   48           3981           pha
     F7F1   A5 C1        3982           lda  stal
     F7F3   48           3983           pha
     F7F4   A5 AF        3984           lda  eah
     F7F6   48           3985           pha
     F7F7   A5 AE        3986           lda  eal
     F7F9   48           3987           pha
                         3988   ;
                         3989   ;put blanks in tape buffer
                         3990   ;
     F7FA   A0 BF        3991           ldy  #bufsz-1
     F7FC   A9 20        3992           lda  #' '
     F7FE   91 B2        3993   blnk2   sta  (tape1),y
     F800   88           3994           dey
     F801   D0 FB        3995           bne  blnk2
                         3996   ;
                         3997   ;put block type in header
                         3998   ;
     F803   A5 9E        3999           lda  t1
     F805   91 B2        4000           sta  (tape1),y
                         4001   ;
                         4002   ;put start load address in header
                         4003   ;
     F807   C8           4004           iny
     F808   A5 C1        4005           lda  stal
     F80A   91 B2        4006           sta  (tape1),y
     F80C   C8           4007           iny
     F80D   A5 C2        4008           lda  stah

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 39-2
TAPEFILES   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     F80F   91 B2        4009           sta  (tape1),y
                         4010   ;
                         4011   ;put end load address in header
                         4012   ;
     F811   C8           4013           iny
     F812   A5 AE        4014           lda  eal
     F814   91 B2        4015           sta  (tape1),y
     F816   C8           4016           iny
     F817   A5 AF        4017           lda  eah
     F819   91 B2        4018           sta  (tape1),y
                         4019   ;
                         4020   ;put file name in header
                         4021   ;
     F81B   C8           4022           iny
     F81C   84 9F        4023           sty  t2
     F81E   A0 00        4024           ldy  #0
     F820   84 9E        4025           sty  t1
     F822   A4 9E        4026   th20    ldy  t1
     F824   C4 B7        4027           cpy  fnlen
     F826   F0 0C        4028           beq  th30
     F828   B1 BB        4029           lda  (fnadr),y
     F82A   A4 9F        4030           ldy  t2
     F82C   91 B2        4031           sta  (tape1),y
     F82E   E6 9E        4032           inc  t1
     F830   E6 9F        4033           inc  t2
     F832   D0 EE        4034           bne  th20
                         4035   ;
                         4036   ;set up start and end address of header
                         4037   ;
     F834   20 F854      4038   th30    jsr  ldad1
                         4039   ;
                         4040   ;set up time for leader
                         4041   ;
     F837   A9 69        4042           lda  #$69
     F839   85 AB        4043           sta  shcnh
                         4044   ;
     F83B   20 F8EA      4045           jsr  twrt2      ; write header on tape
                         4046   ;
                         4047   ;restore start and end address of
                         4048   ;load file.
                         4049   ;
     F83E   A8           4050           tay     ; save error code in .y
     F83F   68           4051           pla
     F840   85 AE        4052           sta  eal
     F842   68           4053           pla
     F843   85 AF        4054           sta  eah
     F845   68           4055           pla
     F846   85 C1        4056           sta  stal
     F848   68           4057           pla
     F849   85 C2        4058           sta  stah

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 39-3
TAPEFILES   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     F84B   98           4059           tya     ; restore error code for return
                         4060   ;
     F84C   60           4061   th40    rts
                                
                                
                                
                                
                                
                         4063   ;function to return tape buffer
                         4064   ;address in tape1
                         4065   ;
     F84D   A6 B2        4066   zzz     ldx  tape1      ; assume tape1
     F84F   A4 B3        4067           ldy  tape1+1
     F851   C0 02        4068           cpy  #>buf      ; check for allocation...
                         4069   			;...[tape1+1]=0 or 1 means deallocated
                         4070   			;...c clr => deallocated
     F853   60           4071           rts
                                
                                
                                
                                
                                
     F854   20 F84D      4073   ldad1   jsr  zzz        ; get ptr to cassette
     F857   8A           4074           txa
     F858   85 C1        4075           sta  stal       ; save start low
     F85A   18           4076           clc
     F85B   69 C0        4077           adc  #bufsz     ; compute pointer to end
     F85D   85 AE        4078           sta  eal        ; save end low
     F85F   98           4079           tya
     F860   85 C2        4080           sta  stah       ; save start high
     F862   69 00        4081           adc  #0         ; compute pointer to end
     F864   85 AF        4082           sta  eah        ; save end high
     F866   60           4083           rts
                                
                                
                                
                                
                                
     F867   20 F7AF      4085   faf     jsr  fah        ; find any header
     F86A   B0 1D        4086           bcs  faf40      ; failed
                         4087   ;
                         4088   ;success...see if right name
                         4089   ;
     F86C   A0 05        4090           ldy  #5         ; offset into tape header
     F86E   84 9F        4091           sty  t2
     F870   A0 00        4092           ldy  #0         ; offset into file name
     F872   84 9E        4093           sty  t1
     F874   C4 B7        4094   faf20   cpy  fnlen      ; compare this many
     F876   F0 10        4095           beq  faf30      ; done
                         4096   ;

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 39-4
TAPEFILES   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     F878   B1 BB        4097           lda  (fnadr),y
     F87A   A4 9F        4098           ldy  t2
     F87C   D1 B2        4099           cmp  (tape1),y
     F87E   D0 E7        4100           bne  faf        ; mismatch--try next header
     F880   E6 9E        4101           inc  t1
     F882   E6 9F        4102           inc  t2
     F884   A4 9E        4103           ldy  t1
     F886   D0 EC        4104           bne  faf20      ; branch always
                         4105   ;
     F888   18           4106   faf30   clc     ; success flag
     F889   60           4107   faf40   rts
                         4108   
                         4109   ;.end
                         4110   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 40
TAPECONTROL   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         4112   	.subttl TAPECONTROL
     F88A   20 F84D      4113   jtp20   jsr  zzz
     F88D   E6 A6        4114           inc  bufpt
     F88F   A4 A6        4115           ldy  bufpt
     F891   C0 C0        4116           cpy  #bufsz
     F893   60           4117           rts
                                
                                
                                
                                
                                
                         4119   ;stays in routine d2t1ll play switch
                         4120   ;
     F894   20 F8AB      4121   cste1   jsr  cs10
     F897   F0 1C        4122           beq  cs25
     F899   A0 1B        4123           ldy  #ms7-ms1   ; "press play..."
     F89B   20 F1E6      4124   cs30    jsr  msg
     F89E   20 F94B      4125   cs40    jsr  tstop      ; watch for stop key
     F8A1   20 F8AB      4126           jsr  cs10       ; watch cassette switches
     F8A4   D0 F8        4127           bne  cs40
     F8A6   A0 6A        4128           ldy  #ms18-ms1          ; "ok"
     F8A8   4C F1E6      4129           jmp  msg
                                
                                
                                
                                
                                
                         4131   ;subr returns <> for cassette switch
                         4132   ;
     F8AB   A9 40        4133   cs10    lda  #$40       ; check port
     F8AD   2C 911F      4134           bit  d1ora      ; closed?...
     F8B0   D0 03        4135           bne  cs25       ; no. . .
     F8B2   2C 911F      4136           bit  d1ora      ; check again to debounce
     F8B5   18           4137   cs25    clc     ; good return
     F8B6   60           4138           rts
                                
                                
                                
                                
                                
                         4140   ;checks for play & record
                         4141   ;
     F8B7   20 F8AB      4142   cste2   jsr  cs10
     F8BA   F0 F9        4143           beq  cs25
     F8BC   A0 2E        4144           ldy  #ms8-ms1   ; "record"
     F8BE   D0 DB        4145           bne  cs30
                                
                                
                                
                                

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 40-1
TAPECONTROL   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                                
                         4147   ;read header block entry
                         4148   ;
     F8C0   A9 00        4149   rblk    lda  #0
     F8C2   85 90        4150           sta  status
     F8C4   85 93        4151           sta  verck
     F8C6   20 F854      4152           jsr  ldad1
                                
                                
                                
                         4154   ;read load block entry
                         4155   ;
     F8C9   20 F894      4156   trd     jsr  cste1      ; say 'press play'
     F8CC   B0 1F        4157           bcs  twrt3      ; stop key pressed
     F8CE   78           4158           sei
     F8CF   A9 00        4159           lda  #0         ; clear flags...
     F8D1   85 AA        4160           sta  rdflg
     F8D3   85 B4        4161           sta  snsw1
     F8D5   85 B0        4162           sta  cmp0
     F8D7   85 9E        4163           sta  ptr1
     F8D9   85 9F        4164           sta  ptr2
     F8DB   85 9C        4165           sta  dpsw
     F8DD   A9 82        4166           lda  #$82       ; enable for ca1 irq...read line
     F8DF   A2 0E        4167           ldx  #14        ; point irq vector to read
     F8E1   D0 11        4168           bne  tape       ; jmp
                                
                                
                                
                                
                                
                         4170   ;write header block entry
                         4171   ;
     F8E3   20 F854      4172   wblk    jsr  ldad1
                         4173   ;
                         4174   ;write load block entry
                         4175   ;
     F8E6   A9 14        4176   twrt    lda  #20        ; between block shorts
     F8E8   85 AB        4177           sta  shcnh
     F8EA   20 F8B7      4178   twrt2   jsr  cste2      ; say 'press play & record'
     F8ED   B0 68        4179   twrt3   bcs  stop3      ; stop key pressed
     F8EF   78           4180           sei
     F8F0   A9 A0        4181           lda  #$a0       ; enable t2 irqs...write time
     F8F2   A2 08        4182           ldx  #8         ; vector irq to wrtz
                                
                                
                                
                                
                                
                         4184   ;start tape operation entry point
                         4185   ;

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 40-2
TAPECONTROL   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     F8F4   A0 7F        4186   tape    ldy  #$7f       ; kill unwanted irq's
     F8F6   8C 912E      4187           sty  d2ier
     F8F9   8D 912E      4188           sta  d2ier      ; turn on wanted
                         4189   ; wait for rs-232 to finish
     F8FC   20 F160      4190           jsr  rsp232
                         4191   ; move irq to irqtemp for cass ops
     F8FF   AD 0314      4192           lda  cinv
     F902   8D 029F      4193           sta  irqtmp
     F905   AD 0315      4194           lda  cinv+1
     F908   8D 02A0      4195           sta  irqtmp+1
     F90B   20 FCFB      4196           jsr  bsiv       ; go change irq vector
     F90E   A9 02        4197           lda  #2         ; fsblk starts at 2
     F910   85 BE        4198           sta  fsblk
     F912   20 FBDB      4199           jsr  newch      ; prep local counters and flags
     F915   AD 911C      4200           lda  d1pcr      ; turn motor on
     F918   29 FD        4201           and  #$fd       ; low turns on
     F91A   09 0C        4202           ora  #$0c       ; make sure
     F91C   8D 911C      4203           sta  d1pcr
     F91F   85 C0        4204           sta  cas1       ; flag internal control of cass motor
     F921   A2 FF        4205           ldx  #$ff       ; delay between blocks
     F923   A0 FF        4206   tp32    ldy  #$ff
     F925   88           4207   tp35    dey
     F926   D0 FD        4208           bne  tp35
     F928   CA           4209           dex
     F929   D0 F8        4210           bne  tp32
     F92B   8D 9129      4211           sta  d2t2h
     F92E   58           4212           cli
     F92F   AD 02A0      4213   tp40    lda  irqtmp+1   ; check for interrupt vector...
     F932   CD 0315      4214           cmp  cinv+1     ; ...pointing at key routine
     F935   18           4215           clc
     F936   F0 1F        4216           beq  stop3      ; ...yes return
     F938   20 F94B      4217           jsr  tstop      ; ...no check for stop key
     F93B   AD 912D      4218           lda  d2ifr
     F93E   29 40        4219           and  #$40       ;  check for t1 irq
     F940   F0 ED        4220           beq  tp40       ; ...no
     F942   AD 9114      4221           lda  d1t1l      ;  kill t1 irq request
     F945   20 F734      4222           jsr  udtim      ;  stop key check
     F948   4C F92F      4223           jmp  tp40       ; stay in loop untill tapes are done
                                
                                
                                
                                
                                
     F94B   20 FFE1      4225   tstop   jsr  stop       ; stop key down?
     F94E   18           4226           clc     ; assume no stop
     F94F   D0 0B        4227           bne  stop4      ; we were right
                         4228   ;
                         4229   ;stop key down...
                         4230   ;
     F951   20 FCCF      4231           jsr  tnif       ; turn off cassettes

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 40-3
TAPECONTROL   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     F954   38           4232           sec     ; failure flag
     F955   68           4233           pla     ; back one square...
     F956   68           4234           pla
                         4235   ; lda #0 ;stop key flag
                         4236   ;
     F957   A9 00        4237   stop3   lda  #0         ; deallocate irqtmp
     F959   8D 02A0      4238           sta  irqtmp+1   ; if c-set then stop key
     F95C   60           4239   stop4   rts
                                
                                
                                
                                
                                
                         4241   ;
                         4242   ; stt1 - set up timeout watch for next dipole
                         4243   ;
     F95D   86 B1        4244   stt1    stx  temp       ; .x has constant for timeout
     F95F   A5 B0        4245           lda  cmp0       ; cmp0*5
     F961   0A           4246           asl  a
     F962   0A           4247           asl  a
     F963   18           4248           clc
     F964   65 B0        4249           adc  cmp0
     F966   18           4250           clc
     F967   65 B1        4251           adc  temp       ; adjust long byte count
     F969   85 B1        4252           sta  temp
     F96B   A9 00        4253           lda  #0
     F96D   24 B0        4254           bit  cmp0       ; check cmp0 ...
     F96F   30 01        4255           bmi  stt2       ; ...minus, no adjust
     F971   2A           4256           rol  a          ; ...plus so adjust pos
     F972   06 B1        4257   stt2    asl  temp       ; multiply corrected value by 4
     F974   2A           4258           rol  a
     F975   06 B1        4259           asl  temp
     F977   2A           4260           rol  a
     F978   AA           4261           tax
     F979   AD 9128      4262   stt3    lda  d2t2l      ; watch out for d2t2h rollover...
     F97C   C9 15        4263           cmp  #21        ; ...time for routine...!!!...
     F97E   90 F9        4264           bcc  stt3       ; ...too close so wait und2t1ll past
     F980   65 B1        4265           adc  temp       ; calculate and...
     F982   8D 9124      4266           sta  d2t1l      ; ...store adusted time count
     F985   8A           4267           txa
     F986   6D 9129      4268           adc  d2t2h      ; adjust for high time count
     F989   8D 9125      4269           sta  d2t1h
     F98C   58           4270           cli     ; allow for re-entry code
     F98D   60           4271           rts
                         4272   
                         4273   ;.end
                         4274   ; rsr 8/25/80 modify i/o for mod2 hardware
                         4275   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 41
CASSETTE READ   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         4277   	.subttl CASSETTE READ
                         4278   ; variables used in cassette read routines
                         4279   ;
                         4280   ;  rez - counts zeros (if z then correct # of dipoles)
                         4281   ;  rer - flags errors (if z then no error)
                         4282   ;  diff - used to preserve syno (outside of bit routines)
                         4283   ;  syno - flags if we have block sync (16 zero dipoles)
                         4284   ;  snsw1 - flags if we have byte sync (a longlong)
                         4285   ;  data - holds most recent dipole bit value
                         4286   ;  mych - holds input byte being built
                         4287   ;  firt - used to indicate which half of dipole we're in
                         4288   ;  svxt - temp used to adjust software servo
                         4289   ;  temp - used to hold dipole time during type calculations
                         4290   ;  prty - holds current calculated parity bit
                         4291   ;  prp - has combined error values from bit routines
                         4292   ;  fsblk - indicate which block we're looking at (0 to exit)
                         4293   ;  shcnl - holds fsblk, used to direct routines, because of exit case
                         4294   ;  rdflg - holds function mode
                         4295   ;     mi - waiting for block sync
                         4296   ;     vs - in data block reading data
                         4297   ;     ne - waiting for byte sync
                         4298   ;  sal - indirect to data storage area
                         4299   ;  shcnh - left over from debugging
                         4300   ;  bad - storage space for bad read locations (bottom of stack)
                         4301   ;  ptr1 - count of read locations in error (pointer into bad, max 61)
                         4302   
                         4303   ;  ptr2 - count of re-read locations (pointer into bad, during re-read)
                         4304   ;  verchk - verify or load flag (z - loading)
                         4305   ;

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 42
CASSETTE READ   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     F98E   AE 9129      4307   read    ldx  d2t2h      ; get time since last interrupt
     F991   A0 FF        4308           ldy  #$ff       ; compute counter difference
     F993   98           4309           tya
     F994   ED 9128      4310           sbc  d2t2l
     F997   EC 9129      4311           cpx  d2t2h      ; check for timer high rollover...
     F99A   D0 F2        4312           bne  read       ; ...yes then recompute
     F99C   86 B1        4313           stx  temp
     F99E   AA           4314           tax
     F99F   8C 9128      4315           sty  d2t2l      ; reload timer2 (count down from $ffff)
     F9A2   8C 9129      4316           sty  d2t2h
     F9A5   98           4317           tya
     F9A6   E5 B1        4318           sbc  temp       ; calculate high
     F9A8   86 B1        4319           stx  temp
     F9AA   4A           4320           lsr  a          ; move two bits from high to temp
     F9AB   66 B1        4321           ror  temp
     F9AD   4A           4322           lsr  a
     F9AE   66 B1        4323           ror  temp
     F9B0   A5 B0        4324           lda  cmp0       ; calc min pulse value
     F9B2   18           4325           clc
     F9B3   69 3C        4326           adc  #60
     F9B5   2C 9121      4327           bit  d2orah     ; clear read interrupt flag
     F9B8   C5 B1        4328           cmp  temp       ; if pulse less than min...
     F9BA   B0 4A        4329           bcs  rdbk       ; ...then ignore as noise
     F9BC   A6 9C        4330           ldx  dpsw       ; check if last bit...
     F9BE   F0 03        4331           beq  rjdj       ; ...no then continue
     F9C0   4C FAAD      4332           jmp  radj       ; ...yes then go finish byte
                                
                                
     F9C3   A6 A3        4334   rjdj    ldx  pcntr      ; if 9 bits read...
     F9C5   30 1B        4335           bmi  jrad2      ; ... then goto ending
     F9C7   A2 00        4336           ldx  #0         ; set bit value to zero
     F9C9   69 30        4337           adc  #48        ; add up to half way between...
     F9CB   65 B0        4338           adc  cmp0       ; ...short pulse and sync pulse
     F9CD   C5 B1        4339           cmp  temp       ; check for short...
     F9CF   B0 1C        4340           bcs  radx2      ; ...yes it's a short
     F9D1   E8           4341           inx     ; set bit value to one
     F9D2   69 26        4342           adc  #38        ; move to middle of high
     F9D4   65 B0        4343           adc  cmp0
     F9D6   C5 B1        4344           cmp  temp       ; check for one...
     F9D8   B0 17        4345           bcs  radl       ; ...yes it's a one
     F9DA   69 2C        4346           adc  #44        ; move to longlong
     F9DC   65 B0        4347           adc  cmp0
     F9DE   C5 B1        4348           cmp  temp       ; check for longlong...
     F9E0   90 03        4349           bcc  srer       ; ...greater than is error
     F9E2   4C FA60      4350   jrad2   jmp  rad2       ; ...it's a longlong
                                
                                
     F9E5   A5 B4        4352   srer    lda  snsw1      ; if not syncronized...
     F9E7   F0 1D        4353           beq  rdbk       ; ...then no error
     F9E9   85 A8        4354           sta  rer        ; ...else flag rer

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 42-1
CASSETTE READ   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     F9EB   D0 19        4355           bne  rdbk       ; jmp
                                
                                
     F9ED   E6 A9        4357   radx2   inc  rez        ; count rez up on zeros
     F9EF   B0 02        4358           bcs  rad5       ; jmp
     F9F1   C6 A9        4359   radl    dec  rez        ; count rez down on ones
     F9F3   38           4360   rad5    sec     ; calc actual value for compare store
     F9F4   E9 13        4361           sbc  #19
     F9F6   E5 B1        4362           sbc  temp       ; subtract input value from constant...
     F9F8   65 92        4363           adc  svxt       ; ...add difference to temp storage...
     F9FA   85 92        4364           sta  svxt       ; ...used later to adjust soft servo
     F9FC   A5 A4        4365           lda  firt       ; flip dipole flag
     F9FE   49 01        4366           eor  #1
     FA00   85 A4        4367           sta  firt
     FA02   F0 21        4368           beq  rad3       ; second half of dipole
     FA04   86 D7        4369           stx  data       ; first half so store its value
                                
                                
                                
     FA06   A5 B4        4371   rdbk    lda  snsw1      ; if no byte start...
     FA08   F0 18        4372           beq  radbk      ; ...then return
     FA0A   2C 912D      4373           bit  d2ifr      ; check to see if timer1 irqd us...
     FA0D   50 13        4374           bvc  radbk      ; ...no, so exit
     FA0F   A9 00        4375           lda  #0         ; ...yes, set dipole flag for first half
     FA11   85 A4        4376           sta  firt
     FA13   A5 A3        4377           lda  pcntr      ; check where we are in byte...
     FA15   10 30        4378           bpl  rad4       ; ...doing data
     FA17   30 C9        4379           bmi  jrad2      ; ...process parity
                                
                                
     FA19   A2 A6        4381   radp    ldx  #166       ; set up for longlong timeout
     FA1B   20 F95D      4382           jsr  stt1
     FA1E   A5 9B        4383           lda  prty       ; if parity not even...
     FA20   D0 C3        4384           bne  srer       ; ...then go set error
     FA22   4C FF56      4385   radbk   jmp  prend      ; go restore regs and rti
                                
                                
                                
     FA25   A5 92        4387   rad3    lda  svxt       ; adjust the software servo (cmp0)
     FA27   F0 07        4388           beq  rout1      ; no adjust
     FA29   30 03        4389           bmi  rout2      ; adjust for more base time
     FA2B   C6 B0        4390           dec  cmp0       ; adjust for less base time
     FA2D   2C           4391   	.byte   $2c    ; skip two bytes
     FA2E   E6 B0        4392   rout2   inc  cmp0
     FA30   A9 00        4393   rout1   lda  #0         ; clear difference value
     FA32   85 92        4394           sta  svxt
                         4395   ;check for consecutive like values in dipole...
     FA34   E4 D7        4396           cpx  data
     FA36   D0 0F        4397           bne  rad4       ; ...no, go process info
     FA38   8A           4398           txa     ; ...yes so check the values...

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 42-2
CASSETTE READ   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     FA39   D0 AA        4399           bne  srer       ; if they were ones then  error
                         4400   ; consecutive zeros
     FA3B   A5 A9        4401           lda  rez        ; ...check how many zeros have happened
     FA3D   30 C7        4402           bmi  rdbk       ; ...if many don't check
     FA3F   C9 10        4403           cmp  #16        ; ... do we have 16 yet?...
     FA41   90 C3        4404           bcc  rdbk       ; ....no so continue
     FA43   85 96        4405           sta  syno       ; ....yes so flag syno (between blocks)
     FA45   B0 BF        4406           bcs  rdbk       ; jmp
                                
                                
                                
     FA47   8A           4408   rad4    txa     ; move read data to .a
     FA48   45 9B        4409           eor  prty       ; calculate parity
     FA4A   85 9B        4410           sta  prty
     FA4C   A5 B4        4411           lda  snsw1      ; real data?...
     FA4E   F0 D2        4412           beq  radbk      ; ...no so forget by exiting
     FA50   C6 A3        4413           dec  pcntr      ; dec bit count
     FA52   30 C5        4414           bmi  radp       ; if minus then  time for parity
     FA54   46 D7        4415           lsr  data       ; shift bit from data...
     FA56   66 BF        4416           ror  mych       ; ...into byte storage (mych) buffer
     FA58   A2 DA        4417           ldx  #218       ; set up for next dipole
     FA5A   20 F95D      4418           jsr  stt1
     FA5D   4C FF56      4419           jmp  prend      ; restore regs and rti
                                
                                
                                
                         4421   ; rad2 - longlong handler (could be a long one)
     FA60   A5 96        4422   rad2    lda  syno       ; have we gotten block sync...
     FA62   F0 04        4423           beq  rad2y      ; ...no
     FA64   A5 B4        4424           lda  snsw1      ; check if we've had a real byte start...
     FA66   F0 04        4425           beq  rad2x      ; ...no
     FA68   A5 A3        4426   rad2y   lda  pcntr      ; are we at end of byte...
     FA6A   10 85        4427           bpl  radl       ; ...no so treat it as a long one read
                                
                                
     FA6C   46 B1        4429   rad2x   lsr  temp       ; adjust timeout for...
     FA6E   A9 93        4430           lda  #147       ; ...longlong pulse value
     FA70   38           4431           sec
     FA71   E5 B1        4432           sbc  temp
     FA73   65 B0        4433           adc  cmp0
     FA75   0A           4434           asl  a
     FA76   AA           4435           tax     ; and set timeout for last bit
     FA77   20 F95D      4436           jsr  stt1
     FA7A   E6 9C        4437           inc  dpsw       ; set bit throw away flag
     FA7C   A5 B4        4438           lda  snsw1      ; if byte syncronized....
     FA7E   D0 11        4439           bne  radq2      ; ...then skip to pass char
     FA80   A5 96        4440           lda  syno       ; throws out data untill block sync...
     FA82   F0 26        4441           beq  rdbk2      ; ...no block sync
     FA84   85 A8        4442           sta  rer        ; flag data as error
     FA86   A9 00        4443           lda  #0         ; kill 16 sync flag

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 42-3
CASSETTE READ   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     FA88   85 96        4444           sta  syno
     FA8A   A9 C0        4445           lda  #$c0       ; set up for timer1 interrupts
     FA8C   8D 912E      4446           sta  d2ier
     FA8F   85 B4        4447           sta  snsw1      ; flag that we have byte syncronized
                         4448   ;
     FA91   A5 96        4449   radq2   lda  syno       ; save syno status
     FA93   85 B5        4450           sta  diff
     FA95   F0 09        4451           beq  radk       ; no block sync, no byte looking
     FA97   A9 00        4452           lda  #0         ; turn off byte sync switch
     FA99   85 B4        4453           sta  snsw1
     FA9B   A9 40        4454           lda  #$40       ; disable timer1 interrupts
     FA9D   8D 912E      4455           sta  d2ier
     FAA0   A5 BF        4456   radk    lda  mych       ; pass character to byte routine
     FAA2   85 BD        4457           sta  ochar
     FAA4   A5 A8        4458           lda  rer        ; combine error values with zero count...
     FAA6   05 A9        4459           ora  rez
     FAA8   85 B6        4460           sta  prp        ; ...and save in prp
     FAAA   4C FF56      4461   rdbk2   jmp  prend      ; go back and get last byte
                                
                                
     FAAD   20 FBDB      4463   radj    jsr  newch      ; finish byte, clr flags
     FAB0   85 9C        4464           sta  dpsw       ; clear bit throw away flag
     FAB2   A2 DA        4465           ldx  #218       ; initilize for next dipole
     FAB4   20 F95D      4466           jsr  stt1
     FAB7   A5 BE        4467           lda  fsblk      ; check for last value
     FAB9   F0 02        4468           beq  rd15
     FABB   85 A7        4469           sta  shcnl
                         4470   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 43
CASSETTE READ   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         4472   ;*************************************************
                         4473   ;* byte handler of cassette read                 *
                         4474   ;*                                               *
                         4475   ;* this portion of in line code is passed the    *
                         4476   ;* byte assembled from reading tape in ochar.    *
                         4477   ;* rer is set if the byte read is in error.      *
                         4478   ;* rez is set if the interrupt program is reading*
                         4479   ;* zeros.  rdflg tells us what we are doing.     *
                         4480   ;* bit 7 says to ignore bytes until rez is set   *
                         4481   ;* bit 6 says to load the byte. otherwise rdflg  *
                         4482   ;* is a countdown after sync.  if verck is set   *
                         4483   ;* we do a compare instead of a store and set    *
                         4484   ;* status.  fsblk counts the two blocks. ptr1 is *
                         4485   ;* index to error table for pass1.  ptr2 is index*
                         4486   ;* to correction table for pass2.                *
                         4487   ;*************************************************
                         4488   ;
            =0010        4489   sperr	= 16
            =0020        4490   ckerr	= 32
            =0004        4491   sberr	= 4
            =0008        4492   lberr	= 8
                         4493   ;
     FABD   A9 0F        4494   rd15    lda  #$f
                         4495   ;
     FABF   24 AA        4496           bit  rdflg      ; test function mode
     FAC1   10 17        4497           bpl  rd20       ; not waiting for zeros
                         4498   ;
     FAC3   A5 B5        4499           lda  diff       ; zeros yet?
     FAC5   D0 0C        4500           bne  rd12       ; yes...wait for sync
     FAC7   A6 BE        4501           ldx  fsblk      ; is pass over?
     FAC9   CA           4502           dex     ; ...if fsblk zero then no error (first good)
     FACA   D0 0B        4503           bne  rd10       ; no...
                         4504   ;
     FACC   A9 08        4505           lda  #lberr
     FACE   20 FE6A      4506           jsr  udst       ; yes...long block error
     FAD1   D0 04        4507           bne  rd10       ; branch always
                         4508   ;
     FAD3   A9 00        4509   rd12    lda  #0
     FAD5   85 AA        4510           sta  rdflg      ; new mode is wait for sync
     FAD7   4C FF56      4511   rd10    jmp  prend      ; exit...done
                         4512   ;
     FADA   70 31        4513   rd20    bvs  rd60       ; we are loading
     FADC   D0 18        4514           bne  rd200      ; we are syncing
                         4515   ;
     FADE   A5 B5        4516           lda  diff       ; do we have block sync...
     FAE0   D0 F5        4517           bne  rd10       ; ...yes, exit
     FAE2   A5 B6        4518           lda  prp        ; if first byte has error...
     FAE4   D0 F1        4519           bne  rd10       ; ...then skip (exit)
     FAE6   A5 A7        4520           lda  shcnl      ; move fsblk to carry...
     FAE8   4A           4521           lsr  a

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 43-1
CASSETTE READ   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     FAE9   A5 BD        4522           lda  ochar      ;  should be a header count char
     FAEB   30 03        4523           bmi  rd22       ; if neg then firstblock data
     FAED   90 18        4524           bcc  rd40       ; ...expecting firstblock data...yes
     FAEF   18           4525           clc
     FAF0   B0 15        4526   rd22    bcs  rd40       ; expecting second block?...yes
     FAF2   29 0F        4527           and  #$f        ; mask off high store header count...
     FAF4   85 AA        4528           sta  rdflg      ; ...in mode flag (have correct block)
     FAF6   C6 AA        4529   rd200   dec  rdflg      ; wait untill we get real data...
     FAF8   D0 DD        4530           bne  rd10       ; ...9876543210 real
     FAFA   A9 40        4531           lda  #$40       ; next up is real data...
     FAFC   85 AA        4532           sta  rdflg      ; ...set data mode
     FAFE   20 FBD2      4533           jsr  rd300      ; go setup address pointers
     FB01   A9 00        4534           lda  #0         ; debug code####################################
     FB03   85 AB        4535           sta  shcnh
     FB05   F0 D0        4536           beq  rd10       ; jmp to continue
                                
                                
     FB07   A9 80        4538   rd40    lda  #$80       ; we want to...
     FB09   85 AA        4539           sta  rdflg      ; ignore bytes mode
     FB0B   D0 CA        4540           bne  rd10       ; jmp
                                
                                
     FB0D   A5 B5        4542   rd60    lda  diff       ; check for end of block...
     FB0F   F0 0A        4543           beq  rd70       ; ...okay
                         4544   ;
     FB11   A9 04        4545           lda  #sberr     ; short block error
     FB13   20 FE6A      4546           jsr  udst
     FB16   A9 00        4547           lda  #0         ; force rdflg for an end
     FB18   4C FB97      4548           jmp  rd161
                                
                                
     FB1B   20 FD11      4550   rd70    jsr  cmpste     ; check for end of storage area
     FB1E   90 03        4551           bcc  *+5        ; not done yet
     FB20   4C FB95      4552           jmp  rd160
                         4553   
     FB23   A6 A7        4554           ldx  shcnl      ; check which pass...
     FB25   CA           4555           dex
     FB26   F0 2D        4556           beq  rd58       ; ...second pass
     FB28   A5 93        4557           lda  verck      ; check if load or verify...
     FB2A   F0 0C        4558           beq  rd80       ; ...loading
     FB2C   A0 00        4559           ldy  #0         ; ...just verifying
     FB2E   A5 BD        4560           lda  ochar
     FB30   D1 AC        4561           cmp  (sal),y    ; compare with data in pet
     FB32   F0 04        4562           beq  rd80       ; ...good so continue
     FB34   A9 01        4563           lda  #1         ; ...bad so flag...
     FB36   85 B6        4564           sta  prp        ; ...as an error
                                
                         4566   ; store bad locations for second pass re-try
     FB38   A5 B6        4567   rd80    lda  prp        ; chk for errors...
     FB3A   F0 4B        4568           beq  rd59       ; ...no errors

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 43-2
CASSETTE READ   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     FB3C   A2 3D        4569           ldx  #61        ; max allowed is 30
     FB3E   E4 9E        4570           cpx  ptr1       ; are we at max?...
     FB40   90 3E        4571           bcc  rd55       ; ...yes, flag as second pass error
     FB42   A6 9E        4572           ldx  ptr1       ; get index into bad...
     FB44   A5 AD        4573           lda  sah        ; ...and store the bad location
     FB46   9D 0101      4574           sta  bad+1,x    ; ...in bad table
     FB49   A5 AC        4575           lda  sal
     FB4B   9D 0100      4576           sta  bad,x
     FB4E   E8           4577           inx     ; advance pointer to next
     FB4F   E8           4578           inx
     FB50   86 9E        4579           stx  ptr1
     FB52   4C FB87      4580           jmp  rd59       ; go store character
                                
                                
                         4582   ; check bad table for re-try (second pass)
     FB55   A6 9F        4583   rd58    ldx  ptr2       ; have we done all in the table?...
     FB57   E4 9E        4584           cpx  ptr1
     FB59   F0 35        4585           beq  rd90       ; ...yes
     FB5B   A5 AC        4586           lda  sal        ; see if this is next in the table...
     FB5D   DD 0100      4587           cmp  bad,x
     FB60   D0 2E        4588           bne  rd90       ; ...no
     FB62   A5 AD        4589           lda  sah
     FB64   DD 0101      4590           cmp  bad+1,x
     FB67   D0 27        4591           bne  rd90       ; ...no
     FB69   E6 9F        4592           inc  ptr2       ; we found next one, so advance pointer
     FB6B   E6 9F        4593           inc  ptr2
     FB6D   A5 93        4594           lda  verck      ; doing a load or verify?...
     FB6F   F0 0B        4595           beq  rd52       ; ...loading
     FB71   A5 BD        4596           lda  ochar      ; ...verifying, so check
     FB73   A0 00        4597           ldy  #0
     FB75   D1 AC        4598           cmp  (sal),y
     FB77   F0 17        4599           beq  rd90       ; ...okay
     FB79   C8           4600           iny     ; make .y= 1
     FB7A   84 B6        4601           sty  prp        ; flag it as an error
                                
                                
     FB7C   A5 B6        4603   rd52    lda  prp        ; a second pass error?...
     FB7E   F0 07        4604           beq  rd59       ; ...no
                         4605   ;second pass err
     FB80   A9 10        4606   rd55    lda  #sperr
     FB82   20 FE6A      4607           jsr  udst
     FB85   D0 09        4608           bne  rd90       ; jmp
                                
                                
     FB87   A5 93        4610   rd59    lda  verck      ; load or verify?...
     FB89   D0 05        4611           bne  rd90       ; ...verify, don't store
     FB8B   A8           4612           tay     ; make y zero
     FB8C   A5 BD        4613           lda  ochar
     FB8E   91 AC        4614           sta  (sal),y    ; store character
     FB90   20 FD1B      4615   rd90    jsr  incsal     ; increment addr.

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 43-3
CASSETTE READ   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     FB93   D0 3A        4616           bne  rd180      ; branch always
                                
                                
                                
     FB95   A9 80        4618   rd160   lda  #$80       ; set mode skip next data
     FB97   85 AA        4619   rd161   sta  rdflg
     FB99   A6 BE        4620           ldx  fsblk      ; dec fsblk for next pass...
     FB9B   CA           4621           dex
     FB9C   30 02        4622           bmi  rd167      ; we are done...fsblk=0
     FB9E   86 BE        4623           stx  fsblk      ; ...else fsblk=next
     FBA0   C6 A7        4624   rd167   dec  shcnl      ; dec pass calc...
     FBA2   F0 08        4625           beq  rd175      ; ...all done
     FBA4   A5 9E        4626           lda  ptr1       ; check for first pass errors...
     FBA6   D0 27        4627           bne  rd180      ; ...yes so continue
     FBA8   85 BE        4628           sta  fsblk      ; clear fsblk if no errors...
     FBAA   F0 23        4629           beq  rd180      ; jmp to exit
                                
                                
     FBAC   20 FCCF      4631   rd175   jsr  tnif       ; read it all...exit
     FBAF   20 FBD2      4632           jsr  rd300      ; restore sal & sah
     FBB2   A0 00        4633           ldy  #0         ; set shcnh to zero...
     FBB4   84 AB        4634           sty  shcnh      ; ...used to calc parity byte
                         4635   ;
                         4636   ;compute parity over load
                         4637   ;
     FBB6   B1 AC        4638   vprty   lda  (sal),y    ; calc block bcc
     FBB8   45 AB        4639           eor  shcnh
     FBBA   85 AB        4640           sta  shcnh
     FBBC   20 FD1B      4641           jsr  incsal     ; increment address
     FBBF   20 FD11      4642           jsr  cmpste     ; test against end
     FBC2   90 F2        4643           bcc  vprty      ; not done yet...
     FBC4   A5 AB        4644           lda  shcnh      ; check for bcc char match...
     FBC6   45 BD        4645           eor  ochar
     FBC8   F0 05        4646           beq  rd180      ; ...yes, exit
                         4647   ;chksum error
     FBCA   A9 20        4648           lda  #ckerr
     FBCC   20 FE6A      4649           jsr  udst
     FBCF   4C FF56      4650   rd180   jmp  prend
                                
                                
                                
                                
     FBD2   A5 C2        4652   rd300   lda  stah       ;  restore starting address...
     FBD4   85 AD        4653           sta  sah        ; ...pointers (sah & sal)
     FBD6   A5 C1        4654           lda  stal
     FBD8   85 AC        4655           sta  sal
     FBDA   60           4656           rts
                                
                                
                                

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 43-4
CASSETTE READ   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                                
     FBDB   A9 08        4658   newch   lda  #8         ; set up for 8 bits+parity
     FBDD   85 A3        4659           sta  pcntr
     FBDF   A9 00        4660           lda  #0         ; initilize...
     FBE1   85 A4        4661           sta  firt       ; ..dipole counter
     FBE3   85 A8        4662           sta  rer        ; ..error flag
     FBE5   85 9B        4663           sta  prty       ; ..parity bit
     FBE7   85 A9        4664           sta  rez        ; ..zero count
     FBE9   60           4665           rts     ; .a=0 on return
                         4666   
                         4667   ;.end
                         4668   ; rsr 7/31/80 add comments
                         4669   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 44
CASSETTE WRITE   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         4671   	.subttl CASSETTE WRITE
                         4672   ; cassette info - fsblk is block counter for record
                         4673   ;       fsblk = 2 -first header
                         4674   ;             = 1 -first data
                         4675   ;             = 0 -second data
                         4676   ;
                         4677   ; write - toggle write bit according to lsb in ochar
                         4678   ;
     FBEA   A5 BD        4679   write   lda  ochar      ; shift bit to write into carry
     FBEC   4A           4680           lsr  a
     FBED   A9 60        4681           lda  #96        ; ...c clr write short
     FBEF   90 02        4682           bcc  wrt1
     FBF1   A9 B0        4683   wrtw    lda  #176       ; ...c set write long
     FBF3   A2 00        4684   wrt1    ldx  #0         ; set and store time
     FBF5   8D 9128      4685   wrtx    sta  d2t2l
     FBF8   8E 9129      4686           stx  d2t2h
     FBFB   AD 9120      4687           lda  d2orb      ; toggle write bit
     FBFE   49 08        4688           eor  #$08
     FC00   8D 9120      4689           sta  d2orb
     FC03   29 08        4690           and  #$08       ; leave only write bit
     FC05   60           4691           rts
                         4692   ;
     FC06   38           4693   wrtl3   sec     ; flag sah for end of block
     FC07   66 AD        4694           ror  sah
     FC09   30 3C        4695           bmi  wrt3       ;  jmp
                         4696   ;
                         4697   ; wrtn - called at the end of each byte
                         4698   ;   to write a long rer    rez
                         4699   ;              hhhhhhllllllhhhlll...
                         4700   ;
     FC0B   A5 A8        4701   wrtn    lda  rer        ; check for one long
     FC0D   D0 12        4702           bne  wrtn1
     FC0F   A9 10        4703           lda  #16        ; write a long bit
     FC11   A2 01        4704           ldx  #1
     FC13   20 FBF5      4705           jsr  wrtx
     FC16   D0 2F        4706           bne  wrt3
     FC18   E6 A8        4707           inc  rer
     FC1A   A5 AD        4708           lda  sah        ; if end of block(bit set by wrtl3)...
     FC1C   10 29        4709           bpl  wrt3       ; ...no end continue
     FC1E   4C FC95      4710   	jmp wrnc 	;...end ...finish off
                         4711   ;
     FC21   A5 A9        4712   wrtn1   lda  rez        ; check for a one bit
     FC23   D0 09        4713           bne  wrtn2
     FC25   20 FBF1      4714           jsr  wrtw
     FC28   D0 1D        4715           bne  wrt3
     FC2A   E6 A9        4716           inc  rez
     FC2C   D0 19        4717           bne  wrt3
                         4718   ;
     FC2E   20 FBEA      4719   wrtn2   jsr  write
     FC31   D0 14        4720           bne  wrt3       ; on bit low exit

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 44-1
CASSETTE WRITE   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     FC33   A5 A4        4721           lda  firt       ; check for first of dipole
     FC35   49 01        4722           eor  #1
     FC37   85 A4        4723           sta  firt
     FC39   F0 0F        4724           beq  wrt2       ; dipole done
     FC3B   A5 BD        4725           lda  ochar      ; flips bit for complementary right
     FC3D   49 01        4726           eor  #1
     FC3F   85 BD        4727           sta  ochar
     FC41   29 01        4728           and  #1         ; toggle parity
     FC43   45 9B        4729           eor  prty
     FC45   85 9B        4730           sta  prty
     FC47   4C FF56      4731   wrt3    jmp  prend      ; restore regs and rti exit
                         4732   ;
     FC4A   46 BD        4733   wrt2    lsr  ochar      ; move to next bit
     FC4C   C6 A3        4734           dec  pcntr      ; dec counter for # of bits
     FC4E   A5 A3        4735           lda  pcntr      ; check for 8 bits sent...
     FC50   F0 3A        4736           beq  wrt4       ; ...if yes move in parity
     FC52   10 F3        4737           bpl  wrt3       ; ...else send rest
                         4738   ;
     FC54   20 FBDB      4739   wrts    jsr  newch      ; clean up counters
     FC57   58           4740           cli     ; allow for interrupts to nest
     FC58   A5 A5        4741           lda  cntdn      ; are we writing header counters?...
     FC5A   F0 12        4742           beq  wrt6       ; ...no
                         4743   ; write header counters (9876543210 to help with read)
     FC5C   A2 00        4744           ldx  #0         ; clear bcc
     FC5E   86 D7        4745           stx  data
     FC60   C6 A5        4746   wrts1   dec  cntdn
     FC62   A6 BE        4747           ldx  fsblk      ; check for first block header
     FC64   E0 02        4748           cpx  #2
     FC66   D0 02        4749           bne  wrt61      ; ...no
     FC68   09 80        4750           ora  #$80       ; ...yes mark first block header
     FC6A   85 BD        4751   wrt61   sta  ochar      ; write characters in header
     FC6C   D0 D9        4752           bne  wrt3
                         4753   ;
     FC6E   20 FD11      4754   wrt6    jsr  cmpste     ; compare start:end
     FC71   90 0A        4755           bcc  wrt7       ; not done
     FC73   D0 91        4756           bne  wrtl3      ; go mark end
     FC75   E6 AD        4757           inc  sah
     FC77   A5 D7        4758           lda  data       ; write out bcc
     FC79   85 BD        4759           sta  ochar
     FC7B   B0 CA        4760           bcs  wrt3       ; jmp
                         4761   ;
     FC7D   A0 00        4762   wrt7    ldy  #0         ; get next character
     FC7F   B1 AC        4763           lda  (sal),y
     FC81   85 BD        4764           sta  ochar      ; store in output character
     FC83   45 D7        4765           eor  data       ; update bcc
     FC85   85 D7        4766           sta  data
     FC87   20 FD1B      4767           jsr  incsal     ; increment fetch address
     FC8A   D0 BB        4768           bne  wrt3       ; branch always
                         4769   ;
     FC8C   A5 9B        4770   wrt4    lda  prty       ; move parity into ochar...

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 44-2
CASSETTE WRITE   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     FC8E   49 01        4771           eor  #1
     FC90   85 BD        4772           sta  ochar      ; ...to be written as next bit
     FC92   4C FF56      4773   wrtbk   jmp  prend      ; restore regs and rti exit
                         4774   ;
     FC95   C6 BE        4775   wrnc    dec  fsblk      ; check for end
     FC97   D0 03        4776           bne  wrend      ; ...block only
     FC99   20 FD08      4777           jsr  tnof       ; ...write, so turn off motor
     FC9C   A9 50        4778   wrend   lda  #80        ; put 80 cassette syncs at end
     FC9E   85 A7        4779           sta  shcnl
     FCA0   A2 08        4780           ldx  #8
     FCA2   78           4781           sei
     FCA3   20 FCFB      4782           jsr  bsiv       ; set vector to write zeros
     FCA6   D0 EA        4783           bne  wrtbk      ; jmp
                         4784   ;
     FCA8   A9 78        4785   wrtz    lda  #120       ; write leading zeros for sync
     FCAA   20 FBF3      4786           jsr  wrt1
     FCAD   D0 E3        4787           bne  wrtbk
     FCAF   C6 A7        4788           dec  shcnl      ; check if done with low sync...
     FCB1   D0 DF        4789           bne  wrtbk      ; ...no
     FCB3   20 FBDB      4790           jsr  newch      ; ...yes clear up counters
     FCB6   C6 AB        4791           dec  shcnh      ; check if done with sync...
     FCB8   10 D8        4792           bpl  wrtbk      ; ...no
     FCBA   A2 0A        4793           ldx  #10        ; ...yes so set vector for data
     FCBC   20 FCFB      4794           jsr  bsiv
     FCBF   58           4795           cli
     FCC0   E6 AB        4796           inc  shcnh      ; zero shcnh
     FCC2   A5 BE        4797           lda  fsblk      ; if done then...
     FCC4   F0 30        4798           beq  stky       ; ...goto system restore
     FCC6   20 FBD2      4799           jsr  rd300
     FCC9   A2 09        4800           ldx  #9         ; set up for header count
     FCCB   86 A5        4801           stx  cntdn
     FCCD   D0 85        4802           bne  wrts       ; jmp
                         4803   ;
     FCCF   08           4804   tnif    php     ; clean up interrupts and restore pia's
     FCD0   78           4805           sei
     FCD1   20 FD08      4806           jsr  tnof       ; turn off motor
     FCD4   A9 7F        4807           lda  #$7f       ; clear interrupts
     FCD6   8D 912E      4808           sta  d2ier
     FCD9   A9 F7        4809           lda  #$f7       ; restore keyboard col for stop check
     FCDB   8D 9120      4810           sta  d2orb
     FCDE   A9 40        4811           lda  #%01000000         ; d2acr=free running t1, t2 one shot...
     FCE0   8D 912B      4812           sta  d2acr      ; ...shift disabled, and no latching
     FCE3   20 FE39      4813           jsr  iokeys     ; restore keyboard irq from timmer1
     FCE6   AD 02A0      4814           lda  irqtmp+1   ; restore keyboard interrupt vector
     FCE9   F0 09        4815           beq  tniq       ; no irq (irq vector cannot be z-page)
     FCEB   8D 0315      4816           sta  cinv+1
     FCEE   AD 029F      4817           lda  irqtmp
     FCF1   8D 0314      4818           sta  cinv
     FCF4   28           4819   tniq    plp
     FCF5   60           4820           rts

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 44-3
CASSETTE WRITE   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         4821   ;
     FCF6   20 FCCF      4822   stky    jsr  tnif       ; go restore system interrupts
     FCF9   F0 97        4823           beq  wrtbk      ; came for cassette irq so rti
                         4824   ;
                         4825   ; bsiv - subroutine to change irq vectors
                         4826   ;  entrys - .x = 8 write zeros to tape
                         4827   ;           .x = 10 write data to tape
                         4828   ;           .x = 12 restore to keyscan
                         4829   ;           .x = 14 read data from tape
                         4830   ;
     FCFB   BD FDE9      4831   bsiv    lda  bsit-8,x   ; move irq vectors, table to indirect
     FCFE   8D 0314      4832           sta  cinv
     FD01   BD FDEA      4833           lda  bsit+1-8,x
     FD04   8D 0315      4834           sta  cinv+1
     FD07   60           4835           rts
                         4836   ;
     FD08   AD 911C      4837   tnof    lda  d1pcr      ; turn off cassette motor
     FD0B   09 0E        4838           ora  #$0e       ; ...on ca2
     FD0D   8D 911C      4839           sta  d1pcr
     FD10   60           4840           rts
                                
                                
                                
                         4842   ;compare start and end load/save
                         4843   ;addresses.  subroutine called by
                         4844   ;tape read, save, tape write
                         4845   ;
     FD11   38           4846   cmpste  sec
     FD12   A5 AC        4847           lda  sal
     FD14   E5 AE        4848           sbc  eal
     FD16   A5 AD        4849           lda  sah
     FD18   E5 AF        4850           sbc  eah
     FD1A   60           4851           rts
                                
                                
                                
                         4853   ;increment address pointer sal
                         4854   ;
     FD1B   E6 AC        4855   incsal  inc  sal
     FD1D   D0 02        4856           bne  incr
     FD1F   E6 AD        4857           inc  sah
     FD21   60           4858   incr    rts
                         4859   
                         4860   ;.end
                         4861   ; rsr 7/28/80 add comments
                         4862   ; rsr 8/4/80 changed i/o for vixen
                         4863   ; rsr 8/21/80 changed i/o for vixen mod
                         4864   ; rsr 8/25/80 changed i/o for vixen mod2
                         4865   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 45
INIT   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         4867   	.subttl INIT
                         4868   ; start - system reset
                         4869   ; will goto rom at $a000...
                         4870   ; if locs $a004-$a008
                         4871   ; = 'a0cbm'
                         4872   ;      ^^^> these have msb set
                         4873   ; kernal expects...
                         4874   ; $a000- .word initilize (hard start)
                         4875   ; $a002- .word panic (warm start)
                         4876   ; ... else basic system used
                         4877   
     FD22   A2 FF        4878   start   ldx  #$ff
     FD24   78           4879           sei
     FD25   9A           4880           txs
     FD26   D8           4881           cld
     FD27   20 FD3F      4882           jsr  a0int      ; test for $a0 rom in
     FD2A   D0 03        4883           bne  start1
     FD2C   6C A000      4884           jmp  ($a000)    ;  go init as $a000 rom wants
                         4885   
     FD2F   20 FD8D      4886   start1  jsr  ramtas     ; go ram test and set
     FD32   20 FD52      4887           jsr  restor     ; go set up os vectors
     FD35   20 FDF9      4888           jsr  ioinit     ; go initilize i/o devices
     FD38   20 E518      4889           jsr  cint       ; go initilize screen
     FD3B   58           4890           cli     ; interrupts okay now
     FD3C   6C C000      4891           jmp  ($c000)    ; go to basic system
                                
                                
                                
                                
                         4893   ; a0int - test for an $a000 rom
                         4894   ;  returns z - $a000 in
                         4895   ;
     FD3F   A2 05        4896   a0int   ldx  #tbla0e-tbla0r     ; check for $a000
     FD41   BD FD4C      4897   a0in1   lda  tbla0r-1,x
     FD44   DD A003      4898           cmp  $a004-1,x
     FD47   D0 03        4899           bne  a0in2
     FD49   CA           4900           dex
     FD4A   D0 F5        4901           bne  a0in1
     FD4C   60           4902   a0in2   rts
                         4903   ;
     FD4D   41 30 C3     4904   tbla0r   .byte  'A0',$c3,$c2,$cd        ; ..A0CBM..
     FD50   C2 CD               
     FD52                4905   tbla0e
                                
                                
                                
                                
                         4907   ; restor - set kernal indirects and vectors (system)
                         4908   ;
     FD52   A2 6D        4909   restor  ldx  #<vectss

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 45-1
INIT   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     FD54   A0 FD        4910           ldy  #>vectss
     FD56   18           4911           clc
                         4912   ;
                         4913   ; vector - set kernal indirect and vectors (user)
                         4914   ;
     FD57   86 C3        4915   vector  stx  tmp2
     FD59   84 C4        4916           sty  tmp2+1
     FD5B   A0 1F        4917           ldy  #vectse-vectss-1
     FD5D   B9 0314      4918   movos1  lda  cinv,y     ; get from storage
     FD60   B0 02        4919           bcs  movos2     ; c...want storage to user
     FD62   B1 C3        4920           lda  (tmp2),y   ; ...want user to storage
     FD64   91 C3        4921   movos2  sta  (tmp2),y   ; put in user
     FD66   99 0314      4922           sta  cinv,y     ; put in storage
     FD69   88           4923           dey
     FD6A   10 F1        4924           bpl  movos1
     FD6C   60           4925           rts
                         4926   ;
     FD6D   EABF FED2    4927   vectss   .word  key,timb,nnmi
     FD71   FEAD                
     FD73   F40A F34A    4928   	.word   nopen,nclose,nchkin
     FD77   F2C7                
     FD79   F309 F3F3    4929   	.word   nckout,nclrch,nbasin
     FD7D   F20E                
     FD7F   F27A F770    4930   	.word   nbsout,nstop,ngetin
     FD83   F1F5                
     FD85   F3EF FED2    4931   	.word   nclall,timb    ; goto break on a usrcmd jmp
     FD89   F549 F685    4932   	.word   nload,nsave
     FD8D                4933   vectse
                         4934   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 46
INIT   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         4936   ; ramtas - memory size check and set
                         4937   ;
     FD8D   A9 00        4938   ramtas  lda  #0         ; zero low memory
     FD8F   AA           4939           tax     ; start at 00
     FD90   95 00        4940   ramtz0  sta  $00,x      ; zero page
     FD92   9D 0200      4941           sta  $200,x     ; user buffers and vars
     FD95   9D 0300      4942           sta  $300,x     ; system space and user space
     FD98   E8           4943           inx
     FD99   D0 F5        4944           bne  ramtz0
                         4945   ;
                         4946   ;allocate tape buffers
                         4947   ;
     FD9B   A2 3C        4948           ldx  #<tbuffr
     FD9D   A0 03        4949           ldy  #>tbuffr
     FD9F   86 B2        4950           stx  tape1
     FDA1   84 B3        4951           sty  tape1+1
                         4952   ;
                         4953   ; set top and bottom of memory
                         4954   ;
     FDA3   85 C1        4955   ramtbt  sta  tmp0       ; set low inital index
     FDA5   85 97        4956           sta  xsav       ; set top/bottom flag
     FDA7   8D 0281      4957           sta  memstr     ; set low bottom on a page
     FDAA   A8           4958           tay     ; move zero to .y
     FDAB   A9 04        4959           lda  #4         ; set high inital index
     FDAD   85 C2        4960           sta  tmp0+1
                         4961   ;
     FDAF   E6 C1        4962   ramtz1  inc  tmp0       ; move index thru memory
     FDB1   D0 02        4963           bne  ramtz2
     FDB3   E6 C2        4964           inc  tmp0+1
                         4965   ;
     FDB5   20 FE91      4966   ramtz2  jsr  chkmem     ; go check
     FDB8   A5 97        4967           lda  xsav       ; top/bottom check...
     FDBA   F0 22        4968           beq  ramtz5     ; ...bottom
                         4969   ;
     FDBC   B0 F1        4970           bcs  ramtz1     ; top & still good
     FDBE   A4 C2        4971           ldy  tmp0+1     ; else found bad
     FDC0   A6 C1        4972           ldx  tmp0
     FDC2   C0 20        4973           cpy  #$20       ; check if memory good
     FDC4   90 25        4974           bcc  badram     ; no...bad system ram
     FDC6   C0 21        4975           cpy  #$21       ; check for screen location
     FDC8   B0 08        4976           bcs  ramtz4     ; screen to bottom
     FDCA   A0 1E        4977           ldy  #$1e       ; screen to top
     FDCC   8C 0288      4978           sty  hibase     ; set system screen base
     FDCF   4C FE7B      4979   ramtz3  jmp  settop     ; go set top of system memory
                         4980   ;
     FDD2   A9 12        4981   ramtz4  lda  #$12       ; set new bottom
     FDD4   8D 0282      4982           sta  memstr+1
     FDD7   A9 10        4983           lda  #$10       ; screen to bottom
     FDD9   8D 0288      4984           sta  hibase
     FDDC   D0 F1        4985           bne  ramtz3     ; jmp & save a byte

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 46-1
INIT   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         4986   ;
     FDDE   90 CF        4987   ramtz5  bcc  ramtz1     ; bottom & still bad
     FDE0   A5 C2        4988           lda  tmp0+1     ; do this way so .y still good
     FDE2   8D 0282      4989           sta  memstr+1   ; set bottom
     FDE5   85 97        4990           sta  xsav       ; flag to top
     FDE7   C9 11        4991           cmp  #$11
     FDE9   90 C4        4992           bcc  ramtz1     ; go find top if system ram is good
                         4993   ;
     FDEB   20 E5C3      4994   badram  jsr  initv      ; initilize vic  ram is bad
     FDEE   4C FDEB      4995           jmp  badram
                                
                                
                                
     FDF1   FCA8 FC0B    4997   bsit     .word  wrtz,wrtn,key,read      ; table of indirects for cassette irq's
     FDF5   EABF F98E           
                         4998   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 47
INIT   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         5000   ; ioinit - initilize io devices
                         5001   ;
     FDF9   A9 7F        5002   ioinit  lda  #$7f       ; kill iers
     FDFB   8D 911E      5003           sta  d1ier
     FDFE   8D 912E      5004           sta  d2ier
     FE01   A9 40        5005           lda  #%01000000         ; free running t1 d2
     FE03   8D 912B      5006           sta  d2acr
     FE06   A9 40        5007           lda  #%01000000         ; free running t1 t2 oneshot d1
     FE08   8D 911B      5008           sta  d1acr
     FE0B   A9 FE        5009           lda  #%11111110         ; d1 ca2 high,cb2 high,ca1 neg,cb1 pos
     FE0D   8D 911C      5010           sta  d1pcr
     FE10   A9 DE        5011           lda  #%11011110         ; d2 ca2 high,cb2 low,ca1 neg,cb1 pos
     FE12   8D 912C      5012           sta  d2pcr
     FE15   A2 00        5013           ldx  #$00
     FE17   8E 9112      5014           stx  d1ddrb     ; user port (no rs-232)
     FE1A   A2 FF        5015           ldx  #%11111111
     FE1C   8E 9122      5016           stx  d2ddrb     ; keyboard cols are outputs
     FE1F   A2 00        5017           ldx  #$00
     FE21   8E 9123      5018           stx  d2ddra     ; keyboard rows are inputs
     FE24   A2 80        5019           ldx  #%10000000         ; sclk sdata 4joy cassw satn
     FE26   8E 9113      5020           stx  d1ddra     ; ...cass motor, cass switch, ack
     FE29   A2 00        5021           ldx  #%00000000         ; satn low
     FE2B   8E 911F      5022           stx  d1ora
     FE2E   20 EF84      5023           jsr  clkhi      ; clkhi to release serial device
     FE31   A9 82        5024           lda  #$82       ; enable panic button
     FE33   8D 911E      5025           sta  d1ier
     FE36   20 EF8D      5026           jsr  clklo      ; clklo to restore clock line
                         5027   ;
     FE39   A9 C0        5028   iokeys  lda  #$c0       ; enable t1 interrupts
     FE3B   8D 912E      5029           sta  d2ier
     FE3E   A9 89        5030           lda  #<sixty    ; ...at 60 hz rate
     FE40   8D 9124      5031           sta  d2t1l
     FE43   A9 42        5032           lda  #>sixty
     FE45   8D 9125      5033           sta  d2t1h
     FE48   60           5034           rts
                         5035   ;
                         5036   ; sixty hertz value
                         5037   ;
            =4289        5038   sixty    =  17033
                         5039   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 48
INIT   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     FE49   85 B7        5041   setnam  sta  fnlen
     FE4B   86 BB        5042           stx  fnadr
     FE4D   84 BC        5043           sty  fnadr+1
     FE4F   60           5044           rts
                                
                                
                                
                                
                                
     FE50   85 B8        5046   setlfs  sta  la
     FE52   86 BA        5047           stx  fa
     FE54   84 B9        5048           sty  sa
     FE56   60           5049           rts
                                
                                
                                
                                
                                
     FE57   A5 BA        5051   readss  lda  fa         ; see which devices' to read
     FE59   C9 02        5052           cmp  #2         ; is it rs-232?
     FE5B   D0 0B        5053           bne  readst     ; no...read serial/cass
     FE5D   AD 0297      5054           lda  rsstat     ; yes...get rs-232 up
     FE60   A9 00        5055           lda  #00        ; clear rs232 status when read
     FE62   8D 0297      5056           sta  rsstat
     FE65   60           5057           rts
                         5058   
     FE66   85 9D        5059   setmsg  sta  msgflg
     FE68   A5 90        5060   readst  lda  status
     FE6A   05 90        5061   udst    ora  status
     FE6C   85 90        5062           sta  status
     FE6E   60           5063           rts
                                
                                
                                
                                
                                
     FE6F   8D 0285      5065   settmo  sta  timout
     FE72   60           5066           rts
                                
                                
                                
                                
                                
     FE73   90 06        5068   memtop  bcc  settop
                         5069   ;
                         5070   ;carry set--read top of memory
                         5071   ;
     FE75   AE 0283      5072   gettop  ldx  memsiz
     FE78   AC 0284      5073           ldy  memsiz+1
                         5074   ;

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 48-1
INIT   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         5075   ;carry clear--set top of memory
                         5076   ;
     FE7B   8E 0283      5077   settop  stx  memsiz
     FE7E   8C 0284      5078           sty  memsiz+1
     FE81   60           5079           rts
                                
                                
                                
                                
                                
                         5081   ;manage bottom of memory
                         5082   ;
     FE82   90 06        5083   membot  bcc  setbot
                         5084   ;
                         5085   ;carry set--read bottom of memory
                         5086   ;
     FE84   AE 0281      5087           ldx  memstr
     FE87   AC 0282      5088           ldy  memstr+1
                         5089   ;
                         5090   ;carry clear--set bottom of memory
                         5091   ;
     FE8A   8E 0281      5092   setbot  stx  memstr
     FE8D   8C 0282      5093           sty  memstr+1
     FE90   60           5094           rts
                                
                                
                                
                                
                                
                         5096   ;********************************
                         5097   ;
                         5098   ; c h e c k   m e m o r y
                         5099   ;
                         5100   ; check for the existence of
                         5101   ; ram at the location specified
                         5102   ; in tmp0
                         5103   ;
                         5104   ; c=0 if there is no ram at tmp0
                         5105   ; c=1 if there is ram at tmp0
                         5106   ;
                         5107   ; (tmp0) is preserved
                         5108   ;*******************************
                         5109   ;
     FE91   B1 C1        5110   chkmem  lda  (tmp0),y
     FE93   AA           5111           tax     ; save byte at test location
     FE94   A9 55        5112           lda  #$55       ; test all bits
     FE96   91 C1        5113           sta  (tmp0),y
     FE98   D1 C1        5114           cmp  (tmp0),y   ; do they match
     FE9A   D0 08        5115           bne  nomem      ; branch if not
     FE9C   6A           5116           ror  a          ; try the other bits

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 48-2
INIT   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     FE9D   91 C1        5117           sta  (tmp0),y
     FE9F   D1 C1        5118           cmp  (tmp0),y   ; do they match
     FEA1   D0 01        5119           bne  nomem      ; branch if not
     FEA3   A9           5120   	.byte    $a9    ; carry is set so skip
     FEA4   18           5121   nomem   clc     ; no ram flag
     FEA5   8A           5122           txa     ; restore in case of ram
     FEA6   91 C1        5123           sta  (tmp0),y
     FEA8   60           5124           rts
                         5125   
                         5126   ;.end
                         5127   ; rsr 8/5/80 change io structure
                         5128   ; rsr 8/15/80 add memory test
                         5129   ; rsr 8/21/80 change i/o for mod
                         5130   ; rsr 8/25/80 change i/o for mod2
                         5131   ; rsr 8/29/80 change ramtest for hardware mistake
                         5132   ; rsr 9/22/80 change so ram hang rs232 status read
                         5133   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 49
NMI HANDLER   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         5135   	.subttl NMI HANDLER
     FEA9   78           5136   nmi     sei     ; no irq's allowed...
     FEAA   6C 0318      5137           jmp  (nminv)    ; ...could mess up cassettes
                         5138   
     FEAD   48           5139   nnmi    pha     ; save 6502 regs
     FEAE   8A           5140           txa
     FEAF   48           5141           pha
     FEB0   98           5142           tya
     FEB1   48           5143           pha
     FEB2   AD 911D      5144   nnmi10  lda  d1ifr      ; check if real nmi...
     FEB5   10 48        5145           bpl  nmirtn     ; ...no
                         5146   ;
     FEB7   2D 911E      5147           and  d1ier      ; show only enables
     FEBA   AA           5148           tax     ; save in .x for latter
     FEBB   29 02        5149           and  #$02       ; check if restore key...
     FEBD   F0 1F        5150           beq  nnmi20     ; ...no
                         5151   ;
     FEBF   20 FD3F      5152   nnmi18  jsr  a0int      ; check if $a0 in...
     FEC2   D0 03        5153           bne  nnmi19     ; ...no
     FEC4   6C A002      5154           jmp  ($a002)    ; ...yes
                         5155   ;
                         5156   ; check for stop key down
                         5157   ;
     FEC7   2C 9111      5158   nnmi19  bit  d1orah     ; clr ca1 flag
     FECA   20 F734      5159           jsr  udtim
     FECD   20 FFE1      5160           jsr  stop
     FED0   D0 2D        5161           bne  nmirtn     ; no stop key
                         5162   ;
                         5163   ; timb - where system goes on a brk instruction
                         5164   ;
     FED2   20 FD52      5165   timb    jsr  restor     ; restore system indirects
     FED5   20 FDF9      5166           jsr  ioinit     ; restore i/o for basic
     FED8   20 E518      5167           jsr  cint       ; restore screen for basic
     FEDB   6C C002      5168           jmp  ($c002)    ; ...no, so basic warm start
                                
                                
                         5170   ; disable nmi's untill ready
                         5171   ;  save on stack
                         5172   ;
     FEDE   AD 911E      5173   nnmi20  lda  d1ier      ; save current enables...
     FEE1   09 80        5174           ora  #$80       ; so we can enable on restore
     FEE3   48           5175           pha
     FEE4   A9 7F        5176           lda  #$7f       ; kill the rest
     FEE6   8D 911E      5177           sta  d1ier
                         5178   ;
                         5179   ;
                         5180   ; t1 nmi check - transmitt a bit
                         5181   ;
     FEE9   8A           5182           txa
     FEEA   29 40        5183           and  #$40       ; check for t1

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 49-1
NMI HANDLER   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     FEEC   F0 14        5184           beq  nnmi30     ; no...
                         5185   ;
     FEEE   A9 CE        5186           lda  #$ce       ; fixed pcr here
                         5187   ; will turn off your cass motor!
     FEF0   05 B5        5188           ora  nxtbit     ; load data and...
     FEF2   8D 911C      5189           sta  d1pcr      ; ...send it
                         5190   ;
     FEF5   AD 9114      5191           lda  d1t1l      ; kill request
                         5192   ;
     FEF8   68           5193           pla     ; restore nmi's
     FEF9   8D 911E      5194           sta  d1ier      ; ready for next...
                         5195   ;
     FEFC   20 EFA3      5196           jsr  rstrab     ; go calc info (code could be in line)
     FEFF   4C FF56      5197   nmirtn  jmp  nmirti
                         5198   ;
                                
                                
                         5200   ; t2 nmi check - recieve a bit
                         5201   ;
     FF02   8A           5202   nnmi30  txa
     FF03   29 20        5203           and  #$20       ; mask to t2
     FF05   F0 25        5204           beq  nnmi40     ; no...
                         5205   ;
     FF07   AD 9110      5206           lda  d1orb      ; get data in
     FF0A   29 01        5207           and  #01        ; mask off...
     FF0C   85 A7        5208           sta  inbit      ; ...save for latter
                         5209   ;
                         5210   ; update t2 for mid bit check
                         5211   ;   (worst case <255 us to here)
                         5212   ;
     FF0E   AD 9118      5213           lda  d1t2l      ; calc new time & clr nmi
     FF11   E9 16        5214           sbc  #22        ; time for this loop
     FF13   6D 0299      5215           adc  baudof
     FF16   8D 9118      5216           sta  d1t2l
     FF19   AD 9119      5217           lda  d1t2h
     FF1C   6D 029A      5218           adc  baudof+1
     FF1F   8D 9119      5219           sta  d1t2h
                         5220   ;
                         5221   ;
     FF22   68           5222           pla     ; restore nmi's
     FF23   8D 911E      5223           sta  d1ier
                         5224   ;
     FF26   20 F036      5225           jsr  rsrcvr     ; go shift in...
     FF29   4C FF56      5226           jmp  nmirti
                                
                                
                         5228   ; cb1 nmi handler - recieve a start bit
                         5229   ;
     FF2C   8A           5230   nnmi40  txa     ; check for edge
     FF2D   29 10        5231           and  #$10       ; on cb1...

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 49-2
NMI HANDLER   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     FF2F   F0 25        5232           beq  nmirti     ; no...
                         5233   ;
                         5234   ; check for noise ?
                         5235   ;
     FF31   AD 0293      5236           lda  m51ctr     ; get length to check for
     FF34   29 0F        5237           and  #$0f
     FF36   D0 00        5238           bne  nnmi42     ; use tables
                         5239   ;
                         5240   ; get baud rate from else where ###need code###
                         5241   ;
     FF38   0A           5242   nnmi42  asl  a          ; get data from baud table
     FF39   AA           5243           tax
     FF3A   BD FF5A      5244           lda  baudo-2,x          ; move to timer
     FF3D   8D 9118      5245           sta  d1t2l
     FF40   BD FF5B      5246           lda  baudo-1,x
     FF43   8D 9119      5247           sta  d1t2h
                         5248   ;
     FF46   AD 9110      5249           lda  d1orb      ; kill cb1 edge nmi
     FF49   68           5250           pla     ; restore nmi's
     FF4A   09 20        5251           ora  #$20       ; enable t2 nmi
     FF4C   29 EF        5252           and  #$ef       ; disable edge on cb1
     FF4E   8D 911E      5253           sta  d1ier
                         5254   ;
     FF51   AE 0298      5255           ldx  bitnum     ; get #of bits in
     FF54   86 A8        5256           stx  bitci      ; put in rcvrcnt
                         5257   ;
                                
                                
     FF56                5259   nmirti          ; restore 6502 regs
     FF56   68           5260   prend   pla     ; because of missing screen editor
     FF57   A8           5261           tay
     FF58   68           5262           pla
     FF59   AA           5263           tax
     FF5A   68           5264           pla
     FF5B   40           5265           rti
                                
                                
                                
                                
                         5267   ; baudo table contains values
                         5268   ;  for 1.023e6/baud rate/2
                         5269   ;
     FF5C   2792         5270   baudo    .word  10230-cbit      ;  50 baud
     FF5E   1A40         5271   	.word    6820-cbit      ;    75   baud
     FF60   11C6         5272   	.word    4650-cbit      ;   110   baud
     FF62   0E74         5273   	.word    3800-cbit      ;   134.6 baud
     FF64   0CEE         5274   	.word    3410-cbit      ;   150   baud
     FF66   0645         5275   	.word    1705-cbit      ;   300   baud
     FF68   02F1         5276   	.word    853-cbit       ;   600   baud
     FF6A   0146         5277   	.word    426-cbit       ;  1200   baud

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 49-3
NMI HANDLER   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

     FF6C   00B8         5278   	.word    284-cbit       ;  1800   baud
     FF6E   0071         5279   	.word    213-cbit       ;  2400   baud
     FF70   002A         5280   	.word    142-cbit       ;  3600   baud
                         5281   ;
                         5282   ; cbit - an adjustment to make next t2 hit near center
                         5283   ;   of the next bit.
                         5284   ;   aprox the time to service a cb1 nmi
                         5285   
            =0064        5286   cbit     = 100   ; us
                         5287   
                         5288   ;.end
                         5289   ; rsr 8/2/80 - routine for panic
                         5290   ; rsr 8/8/80 - panic & stop key
                         5291   ; rsr 8/12/80 - change for a0int a subroutine
                         5292   ; rsr 8/19/80 - add rs-232 checks
                         5293   ; rsr 8/21/80 - modify rs-232
                         5294   ; rsr 8/29/80 - change panic order for jack
                         5295   ; rsr 8/30/80 - add t2
                         5296   ; rsr 9/22/80 - add 1800 baud opps!
                         5297   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 50
IRQ HANDLER   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         5299   	.subttl IRQ HANDLER
                         5300   ; puls - checks for real irq's or breaks
                         5301   ;
     FF72   48           5302   puls    pha
     FF73   8A           5303           txa
     FF74   48           5304           pha
     FF75   98           5305           tya
     FF76   48           5306           pha
     FF77   BA           5307           tsx
     FF78   BD 0104      5308           lda  $104,x     ; get old p status
     FF7B   29 10        5309           and  #$10       ; break flag?
     FF7D   F0 03        5310           beq  puls1      ; ...no
     FF7F   6C 0316      5311           jmp  (cbinv)    ; ...yes...break instr
                         5312   
     FF82   6C 0314      5313   puls1   jmp  (cinv)     ; ...irq
                         5314   
                         5315   ;.end
                         5316   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page 51
VECTORS   VKERNAL.SRC

Error Addr  Code          Seq   Source statement

                         5318   	.subttl VECTORS
            =FF8A        5319   	* = $ff8a         ; new vectors for basic
                         5320   
     FF8A   4C FD52      5321           jmp  restor     ; restore vectors to initial system
     FF8D   4C FD57      5322           jmp  vector     ; change vectors for user
                         5323   
            =FF90        5324           * = $ff90
                         5325   
     FF90   4C FE66      5326           jmp  setmsg     ; control o.s. messages
     FF93   4C EEC0      5327           jmp  secnd      ; send sa after listen
     FF96   4C EECE      5328           jmp  tksa       ; send sa after talk
     FF99   4C FE73      5329           jmp  memtop     ; set/read top of memory
     FF9C   4C FE82      5330           jmp  membot     ; set/read bottom of memory
     FF9F   4C EB1E      5331           jmp  scnkey     ; scan keyboard
     FFA2   4C FE6F      5332           jmp  settmo     ; set timeout in ieee
     FFA5   4C EF19      5333           jmp  acptr      ; handshake ieee byte in
     FFA8   4C EEE4      5334           jmp  ciout      ; handshake ieee byte out
     FFAB   4C EEF6      5335           jmp  untlk      ; send untalk out ieee
     FFAE   4C EF04      5336           jmp  unlsn      ; send unlisten out ieee
     FFB1   4C EE17      5337           jmp  listn      ; send listen out ieee
     FFB4   4C EE14      5338           jmp  talk       ; send talk out ieee
     FFB7   4C FE57      5339           jmp  readss     ; return i/o status byte
     FFBA   4C FE50      5340           jmp  setlfs     ; set la, fa, sa
     FFBD   4C FE49      5341           jmp  setnam     ; set length and fn adr
     FFC0   6C 031A      5342   open	jmp  (iopen)	; open logical file
     FFC3   6C 031C      5343   close   jmp  (iclose)   ; close logical file
     FFC6   6C 031E      5344   chkin   jmp  (ichkin)   ; open channel in
     FFC9   6C 0320      5345   ckout   jmp  (ickout)   ; open channel out
     FFCC   6C 0322      5346   clrch   jmp  (iclrch)   ; close i/o channel
     FFCF   6C 0324      5347   basin   jmp  (ibasin)   ; input from channel
     FFD2   6C 0326      5348   bsout   jmp  (ibsout)   ; output to channel
     FFD5   4C F542      5349           jmp  loadsp     ; load from file
     FFD8   4C F675      5350           jmp  savesp     ; save to file
     FFDB   4C F767      5351           jmp  settim     ; set internal clock
     FFDE   4C F760      5352           jmp  rdtim      ; read internal clock
     FFE1   6C 0328      5353   stop    jmp  (istop)    ; scan stop key
     FFE4   6C 032A      5354   getin   jmp  (igetin)   ; get char from q
     FFE7   6C 032C      5355   clall   jmp  (iclall)   ; close all files
     FFEA   4C F734      5356           jmp  udtim      ; increment clock
     FFED   4C E505      5357   jscrog  jmp  scrorg     ; screen org
     FFF0   4C E50A      5358   jplot   jmp  plot       ; read/set x,y coord
     FFF3   4C E500      5359   jiobas  jmp  iobase     ; return i/o base
                         5360   
            =FFFA        5361   	* = $fffa
                         5362   
     FFFA   FEA9         5363   	.word   nmi    ; program defineable
     FFFC   FD22         5364   	.word   start          ; initialization code
     FFFE   FF72         5365   	.word   puls   ; interrupt handler
                         5366   
                         5367   	.end

     No errors detected

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page X-1
VECTORS   VKERNAL.SRC

                     * * Cross Reference * *

Reference flags  (# = Definition, $ = Write, <BLANK> = Read)

Symbol  Value          References

A0IN1   FD41           4897#   4901    
A0IN2   FD4C           4899    4902#   
A0INT   FD3F           4882    4896#   5152    
ACC     0003           92#     
ACP00   EF2E           1952#   1956    
ACP00A  EF21           1946#   1947    
ACP00B  EF3C           1954    1959#   
ACP00C  EF45           1960    1966#   
ACP01   EF54           1957    1975#   
ACP03   EF58           1978#   1980    1982    1992    
ACP03A  EF66           1986#   1988    1990    
ACP04   EF7F           1996    2000#   
ACPTR   EF19           1941#   2664    3399    3406    3421    5333    
AROUND =EF96           2017#   2045    
AUTODN  0292           236#    554$    587$    702     
BACK    E8F7           993     1000#   
BAD     0100           205#    4574$   4576$   4587    4590    
BADRAM  FDEB           4974    4994#   4995    
BAK1UP  E785           786     790#    
BAKBAK  E8AB           948     954#    
BASIN   FFCF           5347#   
BASZPT  00FF           202#    
BAUDO   FF5C           3291    3294    5244    5246    5270#   
BAUDOF  0299           245#    2413    2415    3299$   3302$   5215    5218    
BDF    =0002           349#    2727    3192    
BDFH   =0004           351#    3178    3943    
BIT010  F031           2198    2200#   
BIT020  F035           2200    2203#   
BITCI   00A8           133#    2230$   2252$   2259    5256$   
BITCNT  F027           2195#   3278    
BITNUM  0298           244#    2166    2291    3279$   5255    
BITTS   00B4           148#    2091    2105$   2128$   2131$   2135$   2147$   2167$   
BK1     E78B           793#    
BK15    E78E           794#    804     
BK2     E79F           788     805#    
BKLN    E72D           736#    787     954     
BKLN1   E737           737     743#    
BLF    =0001           348#    3481    3688    3937    
BLNCT   00CD           181#    455$    1300$   1320$   1323$   
BLNK2   F7FE           3993#   3995    
BLNON   00CF           183#    441$    557     562$    1325$   1330$   
BLNSW   00CC           180#    456$    553$    1318    
BLUE   =0006           360#    450     
BMT1    E9F0           704     1179#   1181    
BN10    F21D           2572    2596    2606#   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page X-2
VECTORS   VKERNAL.SRC

                     * * Cross Reference * *

Reference flags  (# = Definition, $ = Write, <BLANK> = Read)

Symbol  Value          References

BN20    F22A           2607    2614#   
BN30    F264           2614    2658#   
BN31    F26A           2566    2661#   
BN32    F26B           2647    2662#   
BN35    F26C           2659    2664#   
BN50    F26F           2616    2668#   2671    
BN52    F279           2669    2673#   
BO10    F285           2689    2696#   
BO20    F28B           2697    2706#   
BO50    F2B9           2707    2753#   
BREAK   F6CB           3419    3652#   
BREAKE  F0A5           2321#   2332    
BSI010  F15D           2487    2496#   
BSI232  F14F           2485#   2575    
BSIT    FDF1           4831    4833    4997#   
BSIV    FCFB           4196    4782    4794    4831#   
BSO100  F0FC           2407#   
BSO110  F102           2408    2413#   
BSO232  F0ED           2397#   2400    2756    
BSOUR   0095           108#    1781$   1832$   1872$   1884$   1909$   
BSOUR1  00A4           126#    1984$   2000    
BSOUT   FFD2           2541    3553    3904    3957    5348#   
BUF     0200           208#    4068    
BUFPT   00A6           130#    2629$   2649$   2734$   3196$   4114$   4115    
BUFSZ  =00C0           352#    3183    3991    4077    4116    
C3P0    0094           107#    1766    1776$   1899    1903$   
CAS1    00C0           163#    1346$   1352    4204$   
CASOUT  F290           2710#   2978    
CBINV   0316           273#    5311    
CBIT   =0064           3298    3298    5270    5271    5272    5273    5274    5275    5276    5277    5278    5279    5280    
                       5286#   
CCTTA2  ED21           1556    1618#   
CCTTA3  ED69           1551    1557    1558    1661#   
CHK1A   E914           1024#   1027    
CHK1B   E91D           1025    1030#   
CHKBAK  E8E8           790     949     990#    
CHKCOL  E912           852     964     1022#   
CHKDWN  E8FA           695     823     1005#   
CHKIN   FFC6           5344#   
CHKLUP  E8EC           992#    997     
CHKMEM  FE91           4966    5110#   
CI2     EEED           1900    1906#   
CI4     EEF2           1904    1909#   
CINT    E518           418#    4889    5167    
CINV    0314           272#    4192    4194    4214    4816$   4818$   4832$   4834$   4918    4922$   5313    

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page X-3
VECTORS   VKERNAL.SRC

                     * * Cross Reference * *

Reference flags  (# = Definition, $ = Write, <BLANK> = Read)

Symbol  Value          References

CIOUT   EEE4           1899#   2702    3232    3642    3644    3648    5334    
CK10    F31B           2858    2864#   
CK15    F328           2868    2875#   
CK20    F318           2860#   2877    
CK30    F32E           2865    2879#   2897    
CK40    F332           2866    2884#   
CK5     F311           2851    2855#   
CK50    F33F           2888    2893#   
CK60    F342           2891    2895#   
CKDSRX  F0E8           2360    2387#   2444    
CKERR  =0020           4490#   4648    
CKI010  F12B           2449#   2450    
CKI020  F138           2460#   2462    
CKI080  F13F           2466#   2476    
CKI090  F144           2445    2468#   
CKI100  F146           2433    2436    2474#   
CKI232  F116           2429#   2800    
CKIT    EB63           1401    1414#   
CKIT1   EB71           1416    1423#   
CKIT2   EBBA           1433    1439    1459#   
CKIT3   EBC4           1464#   
CKO020  F0CD           2366#   2368    
CKO030  F0D4           2372#   2373    
CKO040  F0E1           2383#   2385    
CKO100  F0EB           2352    2361    2384    2389#   
CKO232  F0BC           2349#   2870    
CKOUT   FFC9           5345#   
CKUT    EB62           1410    1413#   
CLALL   FFE7           5355#   
CLALL2  F403           3070    3077#   
CLEAR1  E57B           473#    475     
CLKHI   EF84           1785    1802    1837    1891    1936    1945    2005#   5023    
CLKLO   EF8D           1793    1817    1915    2011#   5026    
CLOSE   FFC3           5343#   
CLP1    E6A8           639     651#    
CLP2    E691           601     640#    
CLP21   E6A6           648     650#    
CLP2A   E6A3           645     649#    
CLP5    E621           579#    583     
CLP6    E62A           581     584#    
CLP7    E6B6           658     660#    
CLR10   EA95           1287#   1292    
CLRCH   FFCC           3860    3894    5346#   
CLRLN   EA8D           473     1125    1213    1284#   
CLS010  F37F           2960    2962#   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page X-4
VECTORS   VKERNAL.SRC

                     * * Cross Reference * *

Reference flags  (# = Definition, $ = Write, <BLANK> = Read)

Symbol  Value          References

CLS020  F384           2963    2965#   
CLSEI   F6DA           2992    3445    3652    3661#   
CLSEI2  F6EF           3662    3671#   
CLSR    E55F           457#    959     
CMP0    00B0           145#    4162$   4245    4249    4254    4324    4338    4343    4347    4390$   4392$   4433    
CMPSTE  FD11           3645    4550    4642    4754    4846#   
CNC3    E7AE           812#    
CNC3X   E778           780     783#    
CNTDN   00A5           129#    4741    4746$   4801$   
COLM    9120           322#    1147$   1152$   1378$   1390$   1420$   1476$   3826$   3828$   
COLOR   0286           225#    451$    678     807     918     1031$   1335    
COLR1   E7FA           835     852#    
COLTAB  E921           1024    1034#   
CONTRL  EDA3           1545    1552    1559    1677#   
COUNT   00A5           128#    1822$   1846$   1944$   1959    1970$   1976$   1991$   
CR     =000D           361#    
CRSW    00D0           184#    578$    609     641$    759$    2609$   
CS10    F8AB           4121    4126    4133#   4142    
CS25    F8B5           4122    4135    4137#   4143    
CS30    F89B           4124#   4145    
CS40    F89E           4125#   4127    
CSBERR  EEB9           1864#   1962    
CSTE1   F894           3155    3461    4121#   4156    
CSTE2   F8B7           3176    3681    4142#   4178    
CTSERR  F019           2159    2182#   
CURS10  E7EC           845#    848     
D1ACR   911B           315#    5008$   
D1DDRA  9113           307#    5020$   
D1DDRB  9112           306#    3258$   5014$   
D1IER   911E           318#    1358    2189$   2265$   2269$   2366    2407    2421$   2449    2467$   2474    2502    2504    
                       2508$   2947$   5003$   5025$   5147    5173    5177$   5194$   5223$   5253$   
D1IFR   911D           317#    5144    
D1ORA   911F           319#    1341    1787    1789$   1825    1826    1877    1879$   1916    1918$   1978    1979    1986    
                       1987    2037    2038    4134    4136    5022$   
D1ORAH  9111           305#    5158    
D1ORB   9110           304#    394     395     2359    2372    2377    2379$   2383    2443    2454    2456$   2460    2952$   
                       3259$   5206    5249    
D1PCR   911C           316#    1348    1355    1360$   2954$   3261$   4200    4203$   4837    4839$   5010$   5189$   
D1SR    911A           314#    
D1T1H   9115           309#    2416$   
D1T1L   9114           308#    2414$   4221    5191    
D1T1LH  9117           311#    
D1T1LL  9116           310#    
D1T2H   9119           313#    5217    5219$   5247$   
D1T2L   9118           312#    5213    5216$   5245$   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page X-5
VECTORS   VKERNAL.SRC

                     * * Cross Reference * *

Reference flags  (# = Definition, $ = Write, <BLANK> = Read)

Symbol  Value          References

D2ACR   912B           335#    4812$   5006$   
D2DDRA  9123           327#    5018$   
D2DDRB  9122           326#    5016$   
D2IER   912E           338#    4187$   4188$   4446$   4455$   4808$   5004$   5029$   
D2IFR   912D           337#    1850    1952    2051    4218    4373    
D2ORA   912F           339#    3791    3792    
D2ORAH  9121           325#    4327    
D2ORB   9120           323#    2157    3312    4687    4689$   4810$   
D2PCR   912C           336#    1842    1845$   2006    2008$   2012    2014$   2026    2028$   2032    2034$   5012$   
D2SR    912A           334#    
D2T1H   9125           329#    4269$   5033$   
D2T1L   9124           328#    1364    4266$   5031$   
D2T1LH  9127           331#    
D2T1LL  9126           330#    
D2T2H   9129           333#    1849$   1951$   2049$   4211$   4268    4307    4311    4316$   4686$   
D2T2L   9128           332#    4262    4310    4315$   4685$   
DATA    00D7           191#    625$    627$    628     651$    656     753$    761     4369$   4396    4415$   4745$   4758    
                       4765    4766$   
DATAHI  E4A0           1782    1794    1798    1836    1937    1948    2025#   
DATALO  E4A9           1834    1889    1966    1994    2031#   
DEBPIA  E4B2           1799    1806    1810    1814    1853    1892    1946    1955    2037#   2039    
DELAY   028C           231#    449$    1432$   1448    1450$   
DFLTN   0099           112#    524$    643     2429$   2562    2595    2810$   3069    3079$   
DFLTO   009A           113#    522$    646     2349$   2687    2879$   3064    3077$   
DIFF    00B5           151#    4450$   4499    4516    4542    
DLABYE  EF09           1867    1928#   
DLAD00  EF0F           1933#   1934    
DLADLH  EF0C           1931#   1967    1998    
DNLINE  E909           1008    1015#   
DPSW    009C           115#    4165$   4330    4437$   4464$   
DSPP    EAA1           563     679     1298#   
DSPP2   EAAA           1303#   1339    
DSRERR  F016           2158    2180#   2387    3315    
DWNBYE  E911           1017    1020#   
DWNCHK  E8FE           1007#   1012    
EAH     00AF           144#    1104    1167$   1199    1231$   3407$   3440$   3516$   3530    3586$   3609$   3984    4017    
                       4054$   4082$   4850    
EAL     00AE           143#    1102    1169$   1197    1233$   1252    1264$   1268$   3400$   3431    3437$   3438$   3513$   
                       3529    3584$   3608$   3986    4014    4052$   4078$   4848    
EOIACP  EF29           1950#   1971    
EOT    =0005           347#    2986    3698    3934    
EREXIT  F7AC           3898    3906#   
ERR232  F0AA           2324#   
ERROR1  F77E           3115    3875#   
ERROR2  F781           3109    3877#   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page X-6
VECTORS   VKERNAL.SRC

                     * * Cross Reference * *

Reference flags  (# = Definition, $ = Write, <BLANK> = Read)

Symbol  Value          References

ERROR3  F784           2785    2853    3879#   
ERROR4  F787           3167    3448    3881#   
ERROR5  F78A           2831    2899    3223    3883#   
ERROR6  F78D           2808    3104    3885#   
ERROR7  F790           2860    3887#   
ERROR8  F793           3387    3631    3889#   
ERROR9  F796           2336    3147    3376    3459    3621    3891#   
FA      00BA           157#    2789    2857    2930    3037$   3124    3206    3373    3394    3618    3635    3663    5047$   
                       5051    
FAF     F867           3163    3467    4085#   4100    
FAF20   F874           4094#   4104    
FAF30   F888           4095    4106#   
FAF40   F889           4086    4107#   
FAH     F7AF           3169    3472    3924#   3944    4085    
FAH40   F7E6           3929    3935    3964#   
FAH45   F7E4           3948    3961#   
FAH50   F7CE           3938    3941    3946#   
FAH55   F7DA           3956#   3960    
FAT     0263           213#    3012    3013$   3036    3125$   
FINDST  E719           593     721#    725     
FINX    E720           723     726#    
FIRT    00A4           127#    4365    4367$   4376$   4661$   4721    4723$   
FLGS    0002           91#     
FNADR   00BB           158#    3231    3270    3552    4029    4097    5042$   5043$   
FNDEND  E5A8           506#    511     
FNDSTR  E58B           488#    494     
FNLEN   00B7           154#    3160    3203    3225    3234    3267    3384    3465    3542    3549    3555    3628    4027    
                       4094    5041$   
FRAMEE  F0A8           2323#   2331    
FREKZP  00FB           201#    
FRMERR  EEB7           1830    1852    1862#   
FSBLK   00BE           161#    4198$   4467    4501    4620    4623$   4628$   4747    4775$   4797    
GDBLN   00CE           182#    559     1331$   1336    
GDCOL   0287           226#    560     1326    1334$   
GETIN   FFE4           5354#   
GETTOP  FE75           2958    3326    5072#   
GN10    F201           2563    2571#   
GN232   F205           2574#   2668    
GOTDWN  E7F4           846     849#    
HIBASE  0288           227#    425     432     457     499     1245    1278    4978$   4984$   
IBASIN  0324           280#    5347    
IBSOUT  0326           281#    5348    
ICHKIN  031E           277#    5344    
ICKOUT  0320           278#    5345    
ICLALL  032C           284#    5355    

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page X-7
VECTORS   VKERNAL.SRC

                     * * Cross Reference * *

Reference flags  (# = Definition, $ = Write, <BLANK> = Read)

Symbol  Value          References

ICLOSE  031C           276#    5343    
ICLRCH  0322           279#    5346    
IGETIN  032A           283#    5354    
ILOAD   0330           286#    3367    
INBIT   00A7           131#    2236    2242$   2253    2274    2309    5208$   
INCR    FD21           4856    4858#   
INCSAL  FD1B           3657    4615    4641    4767    4855#   
INDX    00C8           176#    585$    599     638     2611$   
INITV   E5C3           528#    4994    
INS1    E84C           899     903#    
INS2    E851           905#    915     
INS3    E845           897     900#    
INSEXT  E86D           901     921#    
INSRT   00D8           192#    675     677$    683     779     920$    923     980$    
INVH    0007           96#     
INVL    0008           97#     
IOBASE  E500           394#    5359    
IOINIT  FDF9           4888    5002#   5166    
IOKEYS  FE39           4813    5028#   
IOPEN   031A           275#    5342    
IRQTMP  029F           266#    4193$   4195$   4213    4238$   4814    4817    
ISAVE   0332           287#    3616    
ISOUR   EE49           1774    1797#   1907    
ISOURA  EE40           1792#   1873    1885    
ISR01   EE73           1824#   1827    1847    
ISR02   EE5A           1806#   1808    
ISR03   EE60           1810#   1812    
ISR04   EEA5           1850#   1855    
ISRCLK  EE8B           1835    1837#   
ISRHI   EE88           1833    1836#   
ISTOP   0328           282#    5353    
ITSSET  E4E1           3830    3835#   
JIOBAS  FFF3           5359#   
JLTLK   F3D4           2921    3025#   
JPL2    E8B8           931     938     940     960#    
JPL3    E7F7           809     850#    
JPL4    E7D4           831#    842     843     
JPL5    E8E5           985#    
JPLOT   FFF0           5358#   
JRAD2   F9E2           4335    4350#   4379    
JSCROG  FFED           5357#   
JTG10   F260           2645    2652#   
JTG35   F244           2626    2629#   
JTG36   F24A           2625    2635#   
JTG37   F24D           2622    2638#   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page X-8
VECTORS   VKERNAL.SRC

                     * * Cross Reference * *

Reference flags  (# = Definition, $ = Write, <BLANK> = Read)

Symbol  Value          References

JTGET   F250           2621    2624    2644#   2650    
JTP10   F2AA           2721    2736#   
JTP20   F88A           2644    2720    4113#   
JX050   F351           2922    2926#   
JX115   F38D           2936    2972#   
JX120   F3AE           2934    2992#   
JX150   F3B1           2931    2933    2974    2984    2988    2997#   
JX170   F3CD           2980    3004    3017#   
JX310   F2CF           2783    2787#   
JX315   F2E3           2798    2804#   
JX320   F2EC           2790    2795    2806    2810#   2829    
JX330   F2F0           2796    2817#   
JX340   F2FE           2821    2825#   
JX350   F301           2823    2827#   
JX600   F3D6           3026#   3029    
JX750   F3FC           3065    3069#   
JXRMV   F3B2           2942    3001#   
JZ100   F3DF           2787    2855    2926    3034#   
JZ101   F3EE           3027    3040#   
KEEPIT  E815           872#    
KEY     EABF           1317#   4927    4997    
KEY3    EB01           1343    1352#   
KEY4    EAEF           1319    1321    1341#   
KEY5    EAEA           1328    1338#   
KEYCOD  EC46           1530    1532    1541#   
KEYD    0277           218#    538     540     541$    571$    1471$   
KEYLG2  EC0F           1485    1507#   
KEYLOG  028F           234#    444$    446$    1424    
KEYTAB  00F5           196#    1393$   1395$   1403    1427    1531$   1533$   
KL2     EB12           1353    1359    1362#   
KL24    EB0A           1350    1358#   
KOUNT   028B           230#    453$    1452$   1455$   
KPREND  EB15           1364#   
KSP2   =E4BC           2043#   3576    
KSP3   =E4CF           3590#   3822    
KSP4   =E4E7           3840#   
LA      00B8           155#    3035$   3101    3118    5046$   
LAT     0259           212#    3010    3011$   3028    3034    3119$   
LBERR  =0008           4492#   4505    
LD10    F553           3376#   3379    
LD100   F5CA           3380    3452#   
LD102   F5D1           3453    3457#   
LD104   F5D9           3458    3461#   
LD110   F65F           3552#   3556    
LD112   F5E1           3465#   3485    

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page X-9
VECTORS   VKERNAL.SRC

                     * * Cross Reference * *

Reference flags  (# = Definition, $ = Write, <BLANK> = Read)

Symbol  Value          References

LD115   F669           3539    3543    3550    3558#   
LD150   F5EE           3466    3472#   
LD170   F5F5           3468    3476#   
LD177   F604           3487#   3496    
LD178   F611           3482    3495#   
LD179   F615           3493    3498#   
LD180   F641           3446    3525#   
LD190   F646           3462    3469    3473    3479    3532#   
LD20    F556           3374    3378#   
LD25    F563           3385    3389#   
LD40    F58A           3412#   3426    3442    
LD410   F672           3566    3568#   
LD45    F598           3417    3421#   
LD50    F5B3           3429    3437#   
LD60    F5B5           3432    3438#   
LD64    F5BB           3439    3441#   
LD90    F5C7           3405    3448#   3470    3474    
LDAD1   F854           4038    4073#   4152    4172    
LDTB1   00D9           193#    462$    471$    488     497     506     713$    714$    722     973     1120    1128    1130    
                       1133$   1138    1140$   1141    1180    1209    1218    1220    1223$   1276    1653    1655$   
LDTB2   EDFD           501     1118    1207    1274    1725#   
LDTND   0098           111#    3002$   3003    3009    3025    3054$   3111    3117$   
LINTMP  00F2           194#    1112$   1145$   1182$   1188    1204    1216    1227    
LINZ0  =1000           1697#   1698    1726    
LINZ1  =1016           1698#   1699    1727    
LINZ10 =10DC           1707#   1708    1736    
LINZ11 =10F2           1708#   1709    1737    
LINZ12 =1108           1709#   1710    1738    
LINZ13 =111E           1710#   1711    1739    
LINZ14 =1134           1711#   1712    1740    
LINZ15 =114A           1712#   1713    1741    
LINZ16 =1160           1713#   1714    1742    
LINZ17 =1176           1714#   1715    1743    
LINZ18 =118C           1715#   1716    1744    
LINZ19 =11A2           1716#   1717    1745    
LINZ2  =102C           1699#   1700    1728    
LINZ20 =11B8           1717#   1718    1746    
LINZ21 =11CE           1718#   1719    1747    
LINZ22 =11E4           1719#   1748    
LINZ3  =1042           1700#   1701    1729    
LINZ4  =1058           1701#   1702    1730    
LINZ5  =106E           1702#   1703    1731    
LINZ6  =1084           1703#   1704    1732    
LINZ7  =109A           1704#   1705    1733    
LINZ8  =10B0           1705#   1706    1734    

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page X-10
VECTORS   VKERNAL.SRC

                     * * Cross Reference * *

Reference flags  (# = Definition, $ = Write, <BLANK> = Read)

Symbol  Value          References

LINZ9  =10C6           1706#   1707    1735    
LIST1   EE1C           1763#   1925    
LIST2   EE2B           1767    1780#   
LIST5   EE38           1784    1787#   
LISTN   EE17           1761#   2885    3207    3636    3664    5337    
LLEN   =0016           356#    401     464     491     504     509     719     838     845     935     995     1006    1010    
                       1248    1284    1698    1699    1700    1701    1702    1703    1704    1705    1706    1707    1708    
                       1709    1710    1711    1712    1713    1714    1715    1716    1717    1718    1719    
LLEN2  =002C           357#    
LNMX    00D5           189#    513$    577     697     720$    746     803     826     841     894     903     1657    2610    
LOAD    F546           3367#   
LOADSP  F542           3365#   5349    
LOCK    ED3F           1629    1635#   
LODING  F66A           3521    3564#   3587    
LOOKUP  F3CF           2782    2850    3022#   3106    
LOOP2   E6DC           681#    741     832     850     921     952     955     960     985     1625    1633    
LOOP3   E5E8           552#    555     574     610     
LOOP4   E5E5           551#    576     
LOOP5   E64F           605#    2604    2612    
LOP2    E6E4           684     686#    
LOP5    E657           591     595     596     600     611#    
LOP51   E674           626#    
LOP52   E684           631     634#    
LOP53   E688           633     634     636#    
LOP54   E67E           629     631#    
LOWER   ED21           853     1619#   
LP1     E5D4           540#    544     
LP2     E5CF           538#    564     2569    
LP21    E602           558     564#    
LP22    E619           566     575#    
LP23    E60E           570#    573     
LPS1    E568           462#    469     
LPS2    E570           465     467#    
LSTP    00CA           178#    597     2601$   
LSTSHF  028E           233#    1463$   1486    
LSTX    00C5           172#    1429    1461$   
LSXP    00C9           177#    590     594     967$    1111$   2603$   
LUKING  F647           3158    3463    3538#   3579    
M51AJB  0295           242#    
M51CDR  0294           241#    2118    2154    2303    2350    2431    3306    
M51CTR  0293           240#    2129    2197    2256    3271$   3283    5236    
MAXCHR =0058           374#    700     900     
MEMBOT  FE82           5083#   5330    
MEMSIZ  0283           220#    5072    5073    5077$   5078$   
MEMSTR  0281           219#    4957$   4982$   4989$   5087    5088    5092$   5093$   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page X-11
VECTORS   VKERNAL.SRC

                     * * Cross Reference * *

Reference flags  (# = Definition, $ = Write, <BLANK> = Read)

Symbol  Value          References

MEMTCF  F53C           2968    3333    3337#   
MEMTOP  FE73           5068#   5329    
MEMUSS  00C3           167#    3365$   3366$   3489$   3492$   3512    3515    3517    3519    3583    3585    
MLP4    E9D6           1157#   1159    1161    
MLP42   E9DF           1154    1164#   
MODE    0291           235#    440$    1488    1639    1640$   1647    1648$   
MODE1   EC5E           1392    1394    1542    1549    1562#   
MODE2   EC9F           1543    1550    1581#   
MODE3   ECE0           1544    1600#   
MOVOS1  FD5D           4918#   4924    
MOVOS2  FD64           4919    4921#   
MS1     F174           2519#   2538    3540    3544    3564    3567    3711    3896    3896    3950    4123    4128    4144    
MS10    F1BD           2524#   3564    
MS11    F1C5           2525#   3711    
MS17    F1D7           2527#   3950    
MS18    F1DE           2528#   4128    
MS21    F1CD           2526#   3567    
MS5     F180           2520#   3540    
MS6     F18B           2521#   3544    
MS7     F18F           2522#   4123    
MS8     F1A2           2523#   4144    
MSG     F1E6           2538#   2544    3541    3545    3712    3900    3951    4124    4129    
MSG10   F1F3           2537    2545#   
MSGFLG  009D           116#    2536    3538    3708    3897    3947    5059$   
MYCH    00BF           162#    4416$   4456    
NBASIN  F20E           2595#   4929    
NBSOUT  F27A           2686#   4930    
NC1     E7B7           815     817#    
NC2     E7BE           818     820#    
NC3     E6CB           674#    781     812     926     
NC3W    E7B1           811     814#    
NCHKIN  F2C7           2782#   4928    
NCKOUT  F309           2850#   4929    
NCLALL  F3EF           3053#   4931    
NCLOSE  F34A           2921#   4928    
NCLRCH  F3F3           3063#   4929    
NCTRL   EC18           1510    1514#   
NCX2    E7D9           821     834#    
NCZ2    E7D6           827     832#    
NDX     00C6           174#    543     545$    552     569$    1162$   1456    1467    1473$   2565    3861$   
NEWCH   FBDB           4199    4463    4658#   4739    4790    
NEWLIN  E9EE           902     1177#   
NEWLX   EA08           1185    1186    1193#   
NGETIN  F1F5           2562#   4930    
NJT1    E75D           766     769#    

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page X-12
VECTORS   VKERNAL.SRC

                     * * Cross Reference * *

Reference flags  (# = Definition, $ = Write, <BLANK> = Read)

Symbol  Value          References

NJT8    E769           772     775#    
NJT9    E76B           774     776#    
NLINES =0017           358#    468     472     708     970     1016    1115    1135    1138    1140$   1184    1201    1214    
NLOAD   F549           3369#   4932    
NMI     FEA9           5136#   5363    
NMINV   0318           274#    5137    
NMIRTI  FF56           5197    5226    5232    5259#   
NMIRTN  FEFF           5145    5161    5197#   
NNMI    FEAD           4927    5139#   
NNMI10  FEB2           5144#   
NNMI18  FEBF           5152#   
NNMI19  FEC7           5153    5158#   
NNMI20  FEDE           5150    5173#   
NNMI30  FF02           5184    5202#   
NNMI40  FF2C           5204    5230#   
NNMI42  FF38           5238    5242#   
NODEV   EEB4           1801    1859#   
NOEOI   EE66           1804    1814#   1816    
NOHALF  E536           434     438#    
NOMEM   FEA4           5115    5119    5121#   
NOPEN   F40A           3101#   4928    
NOTKAT  EC33           1526#   
NOTONE  E672           624#    
NSAVE   F685           3618#   4932    
NSTOP   F770           3856#   4930    
NTCN    E771           770     779#    
NTCN1   E7AA           784     810#    
NVS     E6CD           673     675#    
NVS1    E6D3           676     678#    
NWRAP  =0004           375#    990     1005    
NXLN    E8C3           730     829     849     967#    984     
NXLN1   E8CF           971     973#    
NXLN2   E8C7           969#    974     
NXT1    E8D8           767     888     978#    
NXT2    E893           929     941#    
NXT3    E6C7           672#    777     
NXT33   E6C5           671#    883     
NXT6    E89B           942     945#    
NXT61   E8B1           946     957#    
NXTBIT  00B5           150#    2110$   2165$   5188    
NXTD    E581           479#    519     819     
NXTX    E800           763     860#    
NXTX1   E81D           875     877#    
NXTXA   E823           880#    
OCHAR   00BD           160#    4457$   4522    4560    4596    4613    4645    4679    4725    4727$   4733$   4751$   4759$   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page X-13
VECTORS   VKERNAL.SRC

                     * * Cross Reference * *

Reference flags  (# = Definition, $ = Write, <BLANK> = Read)

Symbol  Value          References

                       4764$   4772$   
OP100   F419           3107    3111#   
OP110   F422           3113    3117#   
OP150   F444           3132    3139#   
OP152   F44B           3140    3144#   
OP155   F453           3145    3149#   
OP160   F46C           3167#   3172    
OP170   F46F           3161    3169#   
OP171   F482           3164    3171    3183#   
OP172   F491           3187    3196#   
OP175   F493           3129    3131    3135    3197#   
OP180   F494           3156    3165    3170    3177    3198#   
OP200   F478           3151    3176#   
OP35    F4B2           3214    3225#   
OP40    F4B8           3231#   3235    
OP45    F4C2           3226    3237#   
OP50    F4C5           3201    3204    3239#   
OP98    F411           3102    3106#   
OPEN    FFC0           5342#   
OPENI   F495           3134    3200#   3392    3633    
OPN010  F4F4           3285    3289#   
OPN020  F4D9           3267#   3274    
OPN025  F4E7           3268    3278#   
OPN030  F50C           3306#   
OPN050  F51B           3308    3314    3319#   
OPN055  F527           3326#   
OPN060  F533           3328    3332#   
OPN232  F4C7           3142    3253#   
OUTFN   F659           3549#   3713    
OUTHRE  ED3C           1633#   1641    1645    1649    
PANIC   E5BB           423     518     521#    
PATCH2  E4BC           3389    3578#   
PATCH3  E4C1           3409    3581#   
PATCH4  E4CC           3582    3587#   
PATCHX  ED5B           716     1651#   
PATOUT  E715           717#    1659    
PCH     0000           89#     
PCL     0001           90#     
PCNTR   00A3           124#    4334    4377    4413$   4426    4659$   4734$   4735    
PLF    =0003           350#    3484    3684    3940    
PLOT    E50A           408#    5358    
PLOT10  E513           408     412#    
PNT     00D1           185#    500$    502$    579     612     795     797$    806$    895     906     908$    917$    1251$   
                       1275$   1279$   1288$   1304$   1309    1311    1327    
PNTR    00D3           187#    410$    413     480$    487     492$    588$    598$    611     636$    696$    698     732$    

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page X-14
VECTORS   VKERNAL.SRC

                     * * Cross Reference * *

Reference flags  (# = Definition, $ = Write, <BLANK> = Read)

Symbol  Value          References

                       738$    747$    760     792$    824$    831$    847$    898     914     933     937$    951$    983$    
                       992     1007    1303    1324    2600    
PREND   FF56           4385    4419    4461    4511    4650    4731    4773    5260#   
PRP     00B6           153#    4460$   4518    4564$   4567    4601$   4603    
PRT     E742           551     649     752#    2694    
PRTY    009B           114#    4383    4409    4410$   4663$   4729    4730$   4770    
PTR1    009E           117#    4163$   4570    4572    4579$   4584    4626    
PTR2    009F           120#    4164$   4583    4592$   4593$   
PULS    FF72           5302#   5365    
PULS1   FF82           5310    5313#   
PUTQUE  EBD0           1470#   
PX4     E5C5           529#    532     
QTSW    00D4           188#    589$    632     665     667$    685$    810     890     982$    
QTSWC   E6B8           637     663#    776     
QTSWL   E6C4           664     669#    
R2D2    00A3           123#    1772$   1777$   1803    
RAD2    FA60           4350    4422#   
RAD2X   FA6C           4425    4429#   
RAD2Y   FA68           4423    4426#   
RAD3    FA25           4368    4387#   
RAD4    FA47           4378    4397    4408#   
RAD5    F9F3           4358    4360#   
RADBK   FA22           4372    4374    4385#   4412    
RADJ    FAAD           4332    4463#   
RADK    FAA0           4451    4456#   
RADL    F9F1           4345    4359#   4427    
RADP    FA19           4381#   4414    
RADQ2   FA91           4439    4449#   
RADX2   F9ED           4340    4357#   
RAMTAS  FD8D           4886    4938#   
RAMTBT  FDA3           4955#   
RAMTZ0  FD90           4940#   4944    
RAMTZ1  FDAF           4962#   4970    4987    4992    
RAMTZ2  FDB5           4963    4966#   
RAMTZ3  FDCF           4979#   4985    
RAMTZ4  FDD2           4976    4981#   
RAMTZ5  FDDE           4968    4987#   
RBLK    F8C0           2646    3926    4149#   
RD10    FAD7           4503    4507    4511#   4517    4519    4530    4536    4540    
RD12    FAD3           4500    4509#   
RD15    FABD           4468    4494#   
RD160   FB95           4552    4618#   
RD161   FB97           4548    4619#   
RD167   FBA0           4622    4624#   
RD175   FBAC           4625    4631#   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page X-15
VECTORS   VKERNAL.SRC

                     * * Cross Reference * *

Reference flags  (# = Definition, $ = Write, <BLANK> = Read)

Symbol  Value          References

RD180   FBCF           4616    4627    4629    4646    4650#   
RD20    FADA           4497    4513#   
RD200   FAF6           4514    4529#   
RD22    FAF0           4523    4526#   
RD300   FBD2           3640    4533    4632    4652#   4799    
RD40    FB07           4524    4526    4538#   
RD52    FB7C           4595    4603#   
RD55    FB80           4571    4606#   
RD58    FB55           4556    4583#   
RD59    FB87           4568    4580    4604    4610#   
RD60    FB0D           4513    4542#   
RD70    FB1B           4543    4550#   
RD80    FB38           4558    4562    4567#   
RD90    FB90           4585    4588    4591    4599    4608    4611    4615#   
RDBK    FA06           4329    4353    4355    4371#   4402    4404    4406    
RDBK2   FAAA           4441    4461#   
RDFLG   00AA           138#    4160$   4496    4510$   4528$   4529$   4532$   4539$   4619$   
RDTIM   F760           3801#   5352    
READ    F98E           4307#   4312    4997    
READSS  FE57           5051#   5339    
READST  FE68           5053    5060#   
RECERR  F0A2           2285    2319#   
REKEY   EB74           1426#   1535    
REPDO   EACC           1323#   
RER     00A8           134#    4354$   4442$   4458    4662$   4701    4707$   
RESTOR  FD52           4887    4909#   5165    5321    
REZ     00A9           136#    4357$   4359$   4401    4459    4664$   4712    4716$   
RIBUF   00F7           199#    2298$   2489    2959    2966$   3327    3330$   3331$   
RIDATA  00AA           137#    2243$   2290    2330    
RIDBE   029B           254#    2282    2287$   2486    3319    
RIDBS   029C           255#    2284    2485    2490$   3320$   
RINONE  00A9           135#    2227    2266$   2276$   
RIPRTY  00AB           139#    2237    2238$   2310    
RJDJ    F9C3           4331    4334#   
ROBUF   00F9           200#    2173    2403$   2962    2967$   3332    3335$   3336$   
RODATA  00B6           152#    2096$   2174$   
RODBE   029E           264#    2170    2397    2401$   3321    
RODBS   029D           263#    2169    2175$   2399    3322$   
ROPRTY  00BD           159#    2102    2103$   2123    2138    2164$   
ROUT1   FA30           4388    4393#   
ROUT2   FA2E           4389    4392#   
ROWS    9121           324#    1148    1379    1397    1398    3827    
RPT10   EB84           1430    1434#   
RPT20   EBA1           1436    1441    1443    1445    1448#   
RPT40   EBAB           1449    1452#   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page X-16
VECTORS   VKERNAL.SRC

                     * * Cross Reference * *

Reference flags  (# = Definition, $ = Write, <BLANK> = Read)

Symbol  Value          References

RPTFLG  028A           229#    1435    
RS232   F0B9           2336#   3455    3677    
RSODNE  F021           2171    2188#   
RSP232  F160           1762    2501#   4190    
RSPEXT  EFCF           2124    2128#   2139    2142    
RSPNO   EFDA           2119    2134#   
RSPOFF  F166           2504#   2506    
RSPOK   F172           2503    2509#   
RSR018  F04B           2252#   2304    
RSR020  F04D           2232    2253#   
RSR030  F06F           2231    2282#   
RSR031  F081           2292#   2296    
RSR032  F089           2293    2298#   
RSR050  F09D           2311    2314#   
RSR060  F0B3           2254    2330#   
RSRABL  F05B           2264#   2275    2326    
RSRCVR  F036           2227#   5225    
RSREXT  F04A           2247#   2260    2305    2312    2314    
RSRSXT  F062           2268#   
RSRTRT  F068           2228    2274#   
RSSTAT  0297           243#    2183    2184$   2324    2325$   3265$   5054    5056$   
RST005  EFB0           2098    2100#   
RST010  EFBF           2106    2117#   
RST030  EFDE           2121    2138#   
RST040  EFE4           2120    2142#   
RST050  EFE8           2094    2147#   
RST060  EFFB           2156    2163#   
RST070  F004           2167#   
RST080  F006           2169#   
RSTBGN  EFEE           2092    2154#   2423    
RSTEXT  EFB9           2108#   2130    2132    2149    
RSTOR   F2AF           2723    2742#   
RSTOR1  F2B8           2747    2749#   
RSTRAB  EFA3           2091#   5196    
RSWEXT  EFCE           2126#   2136    2140    2143    
RUNTB   EDF4           570     1695#   
RVS     00C7           175#    672     816$    944$    981$    
SA      00B9           156#    2804    2820    2875    2887    2972    2982    3039$   3120    3122$   3149    3185    3200    
                       3209    3391$   3396    3495    3578    3627$   3637    3661    3665    3685    3694    5048$   
SAH     00AD           142#    1100    1171$   1195    1235$   3643    4573    4589    4653$   4694$   4708    4757$   4849    
                       4857$   
SAL     00AC           141#    1098    1119$   1173$   1193    1208$   1237$   1246$   1250    1263    1265    3641    3647    
                       4561    4575    4586    4598    4614$   4638    4655$   4763    4847    4855$   
SAT     026D           214#    3014    3015$   3038    3123$   
SAVE    F682           3616#   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page X-17
VECTORS   VKERNAL.SRC

                     * * Cross Reference * *

Reference flags  (# = Definition, $ = Write, <BLANK> = Read)

Symbol  Value          References

SAVESP  F675           3608#   5350    
SAVING  F728           3634    3683    3708#   
SBERR  =0004           4491#   4545    
SCATN   EEC5           1877#   1890    1928    2890    
SCCL    E8BB           958     962#    
SCD10   EA16           1202#   1211    
SCD20   EA62           1249#   1255    
SCN20   EB40           1396#   1399    1421    
SCN30   EB4A           1400#   1418    
SCNKEY  EB1E           1362    1374#   5331    
SCNOUT  EB8F           1381    1439#   
SCNRTS  EBD6           1437    1447    1451    1453    1458    1465    1469    1475#   1487    
SCOLOR  EAB2           793     904     1262    1286    1301    1309#   1332    
SCR10   E989           1113#   1122    
SCR40   EA2C           1205    1206    1212#   
SCR41   E99D           1116    1124#   
SCRD19  EA3F           1221    1223#   
SCRD21  EA31           1215#   1225    
SCRD22  EA44           1217    1226#   
SCRL3   E9AC           1131    1133#   
SCRL5   E9A2           1128#   1136    
SCRLIN  EA56           1121    1210    1243#   
SCRO0   E981           1109#   1142    
SCROL   E975           710     972     1098#   1187    
SCRORG  E505           401#    5357    
SECND   EEC0           1872#   2893    3211    3638    3668    5327    
SETBOT  FE8A           5083    5092#   
SETLFS  FE50           5046#   5340    
SETMSG  FE66           5059#   5326    
SETNAM  FE49           5041#   5341    
SETPNT  EA7E           727     1114    1203    1274#   1285    
SETTIM  F767           3806#   5351    
SETTMO  FE6F           5065#   5332    
SETTOP  FE7B           3339    4979    5068    5077#   
SFDX    00CB           179#    1377$   1412$   1426    1460    
SHCNH   00AB           140#    4043$   4177$   4535$   4634$   4639    4640$   4644    4791$   4796$   
SHCNL   00A7           132#    4469$   4520    4554    4624$   4779$   4788$   
SHFLAG  028D           232#    1375$   1408    1409$   1462    1483    
SHFLOG  EBDC           443     445     1482#   
SHFOUT  EC43           1489    1505    1534#   
SIXTY  =4289           5030    5032    5038#   
SKIPBY =F675           3570#   3591    
SKIPIT =F770           3813#   3841    
SNSW1   00B4           149#    4161$   4352    4371    4411    4424    4438    4447$   4453$   
SP      0006           95#     

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page X-18
VECTORS   VKERNAL.SRC

                     * * Cross Reference * *

Reference flags  (# = Definition, $ = Write, <BLANK> = Read)

Symbol  Value          References

SPCK2   EB60           1405    1407    1411#   
SPERR  =0010           3433    3477    4489#   4606    
SPMSG   F1E2           2536#   3568    
SRER    F9E5           4349    4352#   4384    4399    
STAH    00C2           166#    3520$   3614$   3980    4008    4058$   4080$   4652    
STAL    00C1           165#    3518$   3612$   3982    4005    4056$   4075$   4654    
START   FD22           4878#   5364    
START1  FD2F           4883    4886#   
STATUS  0090           102#    1995    2658    2828    2896    3023$   3213    3371$   3402    3413    3414$   3423    3441    
                       3476    4150$   5060    5061    5062$   
STDONE  E5B2           507     512#    
STKEY   0091           104#    3832$   3837$   3856    
STKY    FCF6           4798    4822#   
STOK    E597           489     496#    
STOP    FFE1           3416    3649    4225    5160    5353#   
STOP2   F77D           3858    3863#   
STOP3   F957           4179    4216    4237#   
STOP4   F95C           4227    4239#   
STPTCH  E4CF           3794    3823#   
STT1    F95D           4244#   4382    4418    4436    4466    
STT2    F972           4255    4257#   
STT3    F979           4262#   4264    
STUPT   E587           411     485#    745     939     976     
SV10    F689           3621#   3624    3680    
SV100   F6F1           3625    3674#   
SV102   F6F8           3675    3679#   
SV105   F705           3684#   
SV106   F70F           3687    3689#   
SV110   F726           3696    3702#   
SV115   F727           3682    3691    3693    3703#   3709    
SV20    F68C           3619    3623#   
SV25    F69D           3629    3633#   
SV30    F6BC           3645#   3658    
SV40    F6D2           3650    3657#   
SV50    F6D7           3646    3659#   
SVXT    0092           105#    4363    4364$   4387    4394$   
SWITCH  EC00           1500#   
SYNO    0096           109#    4405$   4422    4440    4444$   4449    
T1      009E           118#    2710$   2736    2755$   2758    3970$   3999    4025$   4026    4032$   4093$   4101$   4103    
T2      009F           121#    4023$   4030    4033$   4091$   4098    4102$   
TALK    EE14           1756#   2818    3395    5338    
TAPE    F8F4           4168    4186#   
TAPE1   00B2           147#    2652    2729$   2737$   3193$   3488    3491    3500    3502    3505    3507    3932    3956    
                       3993$   4000$   4006$   4009$   4015$   4018$   4031$   4066    4067    4099    4950$   4951$   
TAPEH   F7E7           2987    3179    3690    3699    3970#   

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page X-19
VECTORS   VKERNAL.SRC

                     * * Cross Reference * *

Reference flags  (# = Definition, $ = Write, <BLANK> = Read)

Symbol  Value          References

TBLA0E  FD52           4896    4905#   
TBLA0R  FD4D           4896    4897    4904#   
TBLX    00D6           190#    409$    412     481$    486     592     707     711$    712     729$    736     744$    828$    
                       840$    844$    930     932$    968     975$    1000$   1015    1018$   1110$   1144$   1164    1178    
                       1190$   2602    
TBUFFR  033C           290#    4948    4949    
TEMP    00B1           146#    4244$   4251    4252$   4257$   4259$   4265    4313$   4318    4319$   4321$   4323$   4328    
                       4339    4344    4348    4362    4429$   4432    
TH20    F822           4026#   4034    
TH30    F834           4028    4038#   
TH40    F84C           3975    4061#   
TIMB    FED2           4927    4931    5165#   
TIME    00A0           122#    3752$   3754$   3756$   3769    3771    3773    3779$   3780$   3781$   3802    3803    3804    
                       3807$   3808$   3809$   
TIMOUT  0285           221#    5065$   
TKATN   EED3           1887#   2822    
TKATN1  EEDD           1892#   1893    
TKSA    EECE           1884#   2825    3397    5328    
TMP0    00C1           164#    4955$   4960$   4962$   4964$   4971    4972    4988    5110    5113$   5114    5117$   5118    
                       5123$   
TMP2    00C3           168#    4915$   4916$   4920    4921$   
TMPC    009F           119#    
TNIF    FCCF           4231    4631    4804#   4822    
TNIQ    FCF4           4815    4819#   
TNOF    FD08           4777    4806    4837#   
TOFROM  EA6E           1247    1261#   
TP32    F923           4206#   4210    
TP35    F925           4207#   4208    
TP40    F92F           4213#   4220    4223    
TRD     F8C9           3522    4156#   
TSTOP   F94B           4125    4217    4225#   
TVIC    EDE4           529     1691#   
TWRT    F8E6           3692    4176#   
TWRT2   F8EA           4045    4178#   
TWRT3   F8ED           4157    4179#   
UD20    F736           3752#   
UD30    F740           3753    3755    3768#   
UD60    F755           3775    3791#   3793    
UDST    FE6A           1864    1969    2628    3434    4506    4546    4607    4649    5061#   
UDTIM   F734           3738#   4222    5159    5356    
UHUH    E82A           882     885#    
UNKAT   E953           1073#   
UNLOCK  ED4D           1637    1643#   
UNLSN   EF04           1924#   3067    3237    3659    3669    5336    
UNTLK   EEF6           1915#   3072    3444    5335    

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page X-20
VECTORS   VKERNAL.SRC

                     * * Cross Reference * *

Reference flags  (# = Definition, $ = Write, <BLANK> = Read)

Symbol  Value          References

UP2     E879           924     928#    
UP5     E831           887     890#    
UP6     E874           891     925#    
UP9     E870           893     923#    
UPALIN  E88E           936     939#    
UPPER   ED30           965     1621    1627#   
USER    00F3           195#    799     801$    808$    910     912$    919$    1253$   1290$   1306$   1310$   1314$   1333    
USRCMD  032E           285#    
VECTOR  FD57           4915#   5322    
VECTSE  FD8D           4917    4933#   
VECTSS  FD6D           4909    4910    4917    4927#   
VERCK   0093           106#    3369$   3428    3565    3924    3928$   4151$   4557    4594    4610    
VICCOL  9400           342#    1267    1313    
VICREG  9000           298#    430$    436     437$    530$    1500    1502$   1623    1624$   1631    1632$   
VICSCN  1000           295#    1697    
VPAN    E5B5           518#    
VPRTY   FBB6           4638#   4643    
W1MS    EF96           1795    2047#   
W1MS1   EF9B           2050#   2053    
WBLK    F8E3           2722    2979    4172#   
WHITE  =0001           359#    1289    
WLGRTS  E72C           699     733#    
WLOG10  E723           701     729#    
WLOG20  E701           703     706#    
WLOG30  E70E           709     713#    1191    1228    
WLOGIC  E6EA           680     694#    
WREND   FC9C           4776    4778#   
WRITE   FBEA           4679#   4719    
WRNC    FC95           4710    4775#   
WRT1    FBF3           4682    4684#   4786    
WRT2    FC4A           4724    4733#   
WRT3    FC47           4695    4706    4709    4715    4717    4720    4731#   4737    4752    4760    4768    
WRT4    FC8C           4736    4770#   
WRT6    FC6E           4742    4754#   
WRT61   FC6A           4749    4751#   
WRT7    FC7D           4755    4762#   
WRTBK   FC92           4773#   4783    4787    4789    4792    4823    
WRTL3   FC06           4693#   4756    
WRTN    FC0B           4701#   4997    
WRTN1   FC21           4702    4712#   
WRTN2   FC2E           4713    4719#   
WRTS    FC54           4739#   4802    
WRTS1   FC60           4746#   
WRTW    FBF1           4683#   4714    
WRTX    FBF5           4685#   4705    

VIC20 KERNEL  #901486-04  (C)1981 CBM	CR6502/11 version 20.53.12	4-Nov-87  12:6:1	Page X-21
VECTORS   VKERNAL.SRC

                     * * Cross Reference * *

Reference flags  (# = Definition, $ = Write, <BLANK> = Read)

Symbol  Value          References

WRTZ    FCA8           4785#   4997    
XMAX    0289           228#    448$    1468    
XR      0004           93#     
XSAV    0097           110#    2574$   2576    2620$   2630    2638    2754$   2757    4956$   4967    4990$   
YR      0005           94#     
ZZZ     F84D           2976    3144    3457    3679    3974    4066#   4073    4113    
